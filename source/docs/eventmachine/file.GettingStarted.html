<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>
  File: Getting Started with Ruby EventMachine
  
    &mdash; Documentation by YARD 0.8.5.2
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '';
  framesUrl = "frames.html#!" + escape(window.location.href);
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: Getting Started with Ruby EventMachine</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><div id='filecontents'>
<h1 id="getting-started-with-ruby-eventmachine">Getting started with Ruby EventMachine</h1>

<h2 id="about-this-guide">About this guide</h2>

<p>This guide is a quick tutorial that helps you to get started with EventMachine for writing event-driven
servers, clients and using it as a lightweight concurrency library.
It should take about 20 minutes to read and study the provided code examples. This guide covers</p>

<ul>
  <li>Installing EventMachine via <a href="http://rubygems.org">Rubygems</a> and <a href="http://gembundler.com">Bundler</a>.</li>
  <li>Building an Echo server, the “Hello, world”-like code example of network servers.</li>
  <li>Building a simple chat, both server and client.</li>
  <li>Building a very small asynchronous Websockets client.</li>
</ul>

<h2 id="covered-versions">Covered versions</h2>

<p>This guide covers EventMachine v0.12.10 and 1.0 (including betas).</p>

<h2 id="level">Level</h2>

<p>This guide assumes you are comfortable (but not necessary a guru) with the command line. On Microsoft Windows™,
we recommend you to use <a href="http://jruby.org">JRuby</a> when running these examples.</p>

<h2 id="installing-eventmachine">Installing EventMachine</h2>

<h3 id="make-sure-you-have-ruby-installed">Make sure you have Ruby installed</h3>

<p>This guide assumes you have one of the supported Ruby implementations installed:</p>

<ul>
  <li>Ruby 1.8.7</li>
  <li>Ruby 1.9.2</li>
  <li><a href="http://jruby.org">JRuby</a> (we recommend 1.6)</li>
  <li><a href="http://rubini.us">Rubinius</a> 1.2 or higher</li>
  <li><a href="http://www.rubyenterpriseedition.com">Ruby Enterprise Edition</a></li>
</ul>

<p>EventMachine works on Microsoft Windows™.</p>

<h3 id="with-rubygems">With Rubygems</h3>

<p>To install the EventMachine gem do</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_gem'>gem</span> <span class='id identifier rubyid_install'>install</span> <span class='id identifier rubyid_eventmachine'>eventmachine</span>
</code></pre>

<h3 id="with-bundler">With Bundler</h3>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_gem'>gem</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>eventmachine</span><span class='tstring_end'>&quot;</span></span>
</code></pre>

<h3 id="verifying-your-installation">Verifying your installation</h3>

<p>Lets verify your installation with this quick IRB session:</p>

<pre class="code ruby"><code class="ruby">irb -rubygems

ruby-1.9.2-p180 :001 &gt; require &quot;eventmachine&quot;
 =&gt; true
ruby-1.9.2-p180 :002 &gt; EventMachine::VERSION
 =&gt; &quot;1.0.0.beta.3&quot;
</code></pre>

<h2 id="an-echo-server-example">An Echo Server Example</h2>

<p>Lets begin with the classic “Hello, world”-like example, an echo server. The echo server responds clients with the
same data that was provided. First, here’s the code:</p>

<p><pre class="code ruby"><span class='comment'>#!/usr/bin/env ruby
</span>
<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>rubygems</span><span class='tstring_end'>&#39;</span></span> <span class='comment'># or use Bundler.setup
</span><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>eventmachine</span><span class='tstring_end'>&#39;</span></span>

<span class='kw'>class</span> <span class='const'>EchoServer</span> <span class='op'>&lt;</span> <span class='const'>EM</span><span class='op'>::</span><span class='const'>Connection</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_receive_data'>receive_data</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_send_data'>send_data</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_run'>run</span> <span class='kw'>do</span>
  <span class='comment'># hit Control + C to stop
</span>  <span class='const'>Signal</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>INT</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>  <span class='lbrace'>{</span> <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_stop'>stop</span> <span class='rbrace'>}</span>
  <span class='const'>Signal</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TERM</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_stop'>stop</span> <span class='rbrace'>}</span>

  <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_start_server'>start_server</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>0.0.0.0</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>10000</span><span class='comma'>,</span> <span class='const'>EchoServer</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre></p>

<p>When run, the server binds to port 10000. We can connect using Telnet and verify it’s working:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_telnet'>telnet</span> <span class='id identifier rubyid_localhost'>localhost</span> <span class='int'>10000</span>
</code></pre>

<p>On my machine the output looks like:</p>

<pre class="code ruby"><code class="ruby">~ telnet localhost 10000
Trying 127.0.0.1...
Connected to localhost.
Escape character is &#39;^]&#39;.
</code></pre>

<p>Let’s send something to our server. Type in “Hello, EventMachine” and hit Enter. The server will respond with
the same string:</p>

<pre class="code ruby"><code class="ruby">~ telnet localhost 10000
Trying 127.0.0.1...
Connected to localhost.
Escape character is &#39;^]&#39;.
Hello, EventMachine
# (here we hit Enter)
Hello, EventMachine
# (this ^^^ is our echo server reply)
</code></pre>

<p>It works! Congratulations, you now can tell your Node.js-loving friends that you “have done some event-driven programming, too”.
Oh, and to stop Telnet, hit Control + Shift + ] and then Control + C.</p>

<p>Lets walk this example line by line and see what’s going on. These lines</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>rubygems</span><span class='tstring_end'>&#39;</span></span> <span class='comment'># or use Bundler.setup
</span><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>eventmachine</span><span class='tstring_end'>&#39;</span></span>
</code></pre>

<p>probably look familiar: you use <a href="http://rubygems.org">RubyGems</a> (or <a href="http://gembundler.com/">Bundler</a>) for dependencies and then require EventMachine gem. Boring.</p>

<p>Next:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>EchoServer</span> <span class='op'>&lt;</span> <span class='const'>EventMachine</span><span class='op'>::</span><span class='const'>Connection</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_receive_data'>receive_data</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_send_data'>send_data</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>Is the implementation of our echo server. We define a class that inherits from <span class='object_link'><a href="EventMachine/Connection.html" title="EventMachine::Connection (class)">EventMachine::Connection</a></span>
and a handler (aka callback) for one event: when we receive data from a client.</p>

<p>EventMachine handles the connection setup, receiving data and passing it to our handler, <span class='object_link'><a href="EventMachine/Connection.html#receive_data-instance_method" title="EventMachine::Connection#receive_data (method)">EventMachine::Connection#receive_data</a></span>.</p>

<p>Then we implement our protocol logic, which in the case of Echo is pretty trivial: we send back whatever we receive.
To do so, we’re using <span class='object_link'><a href="EventMachine/Connection.html#send_data-instance_method" title="EventMachine::Connection#send_data (method)">EventMachine::Connection#send_data</a></span>.</p>

<p>Lets modify the example to recognize <code>exit</code> command:</p>

<p><pre class="code ruby"><span class='comment'>#!/usr/bin/env ruby
</span>
<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>rubygems</span><span class='tstring_end'>&#39;</span></span> <span class='comment'># or use Bundler.setup
</span><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>eventmachine</span><span class='tstring_end'>&#39;</span></span>

<span class='kw'>class</span> <span class='const'>EchoServer</span> <span class='op'>&lt;</span> <span class='const'>EM</span><span class='op'>::</span><span class='const'>Connection</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_receive_data'>receive_data</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_strip'>strip</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>exit$</span><span class='regexp_end'>/i</span></span>
      <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_stop'>stop</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_send_data'>send_data</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_run'>run</span> <span class='kw'>do</span>
  <span class='comment'># hit Control + C to stop
</span>  <span class='const'>Signal</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>INT</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>  <span class='lbrace'>{</span> <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_stop'>stop</span> <span class='rbrace'>}</span>
  <span class='const'>Signal</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TERM</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_stop'>stop</span> <span class='rbrace'>}</span>

  <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_start_server'>start_server</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>0.0.0.0</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>10000</span><span class='comma'>,</span> <span class='const'>EchoServer</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre></p>

<p>Our <code>receive\_data</code> changed slightly and now looks like this:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_receive_data'>receive_data</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_strip'>strip</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>exit$</span><span class='regexp_end'>/i</span></span>
    <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_stop_event_loop'>stop_event_loop</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_send_data'>send_data</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>Because incoming data has trailing newline character, we strip it off before matching it against a simple regular
expression. If the data ends in <code>exit</code>, we stop EventMachine event loop with <span class='object_link'><a href="EventMachine.html#stop_event_loop-class_method" title="EventMachine.stop_event_loop (method)">EventMachine.stop_event_loop</a></span>. This unblocks
main thread and it finishes execution, and our little program exits as the result.</p>

<p>To summarize this first example:</p>

<ul>
  <li>Subclass <span class='object_link'><a href="EventMachine/Connection.html" title="EventMachine::Connection (class)">EventMachine::Connection</a></span> and override <span class='object_link'><a href="EventMachine/Connection.html#send_data-instance_method" title="EventMachine::Connection#send_data (method)">EventMachine::Connection#send_data</a></span> to handle incoming data.</li>
  <li>Use <span class='object_link'><a href="EventMachine.html#run-class_method" title="EventMachine.run (method)">EventMachine.run</a></span> to start EventMachine event loop and then bind echo server with <span class='object_link'><a href="EventMachine.html#start_server-class_method" title="EventMachine.start_server (method)">EventMachine.start_server</a></span>.</li>
  <li>To stop the event loop, use <span class='object_link'><a href="EventMachine.html#stop_event_loop-class_method" title="EventMachine.stop_event_loop (method)">EventMachine.stop_event_loop</a></span> (aliased as EventMachine.stop)</li>
</ul>

<p>Lets move on to a slightly more sophisticated example that will introduce several more features and methods
EventMachine has to offer.</p>

<h2 id="a-simple-chat-server-example">A Simple Chat Server Example</h2>

<p>Next we will write a simple chat. Initially clients will still use telnet to connect, but then we will add little
client application that will serve as a proxy between telnet and the chat server. This example is certainly longer
(~ 150 lines with whitespace and comments) so instead of looking at the final version and going through it line by line,
we will instead begin with a very simple version that only keeps track of connected clients and then add features
as we go.</p>

<p>To set some expectations about our example:</p>

<ul>
  <li>It will keep track of connected clients</li>
  <li>It will support a couple of commands, à la IRC</li>
  <li>It will support direct messages using Twitter-like @usernames</li>
  <li>It won’t use MongoDB, fibers or distributed map/reduce for anything but will be totally <a href="http://bit.ly/webscaletm">Web Scale™</a> nonetheless. Maybe even <a href="http://bit.ly/roflscalevideo">ROFLscale</a>.</li>
</ul>

<h3 id="step-one-detecting-connections-and-disconnectons">Step one: detecting connections and disconnectons</h3>

<p>First step looks like this:</p>

<p><pre class="code ruby"><span class='comment'>#!/usr/bin/env ruby
</span>
<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>rubygems</span><span class='tstring_end'>&#39;</span></span> <span class='comment'># or use Bundler.setup
</span><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>eventmachine</span><span class='tstring_end'>&#39;</span></span>

<span class='kw'>class</span> <span class='const'>SimpleChatServer</span> <span class='op'>&lt;</span> <span class='const'>EM</span><span class='op'>::</span><span class='const'>Connection</span>

  <span class='comment'>#
</span>  <span class='comment'># EventMachine handlers
</span>  <span class='comment'>#
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_post_init'>post_init</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>A client has connected...</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_unbind'>unbind</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>A client has left...</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_run'>run</span> <span class='kw'>do</span>
  <span class='comment'># hit Control + C to stop
</span>  <span class='const'>Signal</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>INT</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>  <span class='lbrace'>{</span> <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_stop'>stop</span> <span class='rbrace'>}</span>
  <span class='const'>Signal</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TERM</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_stop'>stop</span> <span class='rbrace'>}</span>

  <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_start_server'>start_server</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>0.0.0.0</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>10000</span><span class='comma'>,</span> <span class='const'>SimpleChatServer</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre></p>

<p>We see familiar <span class='object_link'><a href="EventMachine.html#run-class_method" title="EventMachine.run (method)">EventMachine.run</a></span> and <span class='object_link'><a href="EventMachine.html#start_server-class_method" title="EventMachine.start_server (method)">EventMachine.start_server</a></span>, but also <span class='object_link'><a href="EventMachine/Connection.html#post_init-instance_method" title="EventMachine::Connection#post_init (method)">EventMachine::Connection#post_init</a></span> and <span class='object_link'><a href="EventMachine/Connection.html#unbind-instance_method" title="EventMachine::Connection#unbind (method)">EventMachine::Connection#unbind</a></span> we haven’t
met yet. We don’t use them in this code, so when are they run? Like <span class='object_link'><a href="EventMachine/Connection.html#receive_data-instance_method" title="EventMachine::Connection#receive_data (method)">EventMachine::Connection#receive_data</a></span>, these methods are callbacks. EventMachine calls them
when certain events happen:</p>

<ul>
  <li>EventMachine#post_init is called by the event loop immediately after the network connection has been established.
In the chat server example case, this is when a new client connects.</li>
  <li>EventMachine#unbind is called when client disconnects, connection is closed or is lost (because of a network issue, for example).</li>
</ul>

<p>All our chat server does so far is logging connections or disconnections. What we want it to do next is to keep track of connected clients.</p>

<h3 id="step-two-keep-track-of-connected-clients">Step two: keep track of connected clients</h3>

<p>Next iteration of the code looks like this:</p>

<p><pre class="code ruby"><span class='comment'>#!/usr/bin/env ruby
</span>
<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>rubygems</span><span class='tstring_end'>&#39;</span></span> <span class='comment'># or use Bundler.setup
</span><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>eventmachine</span><span class='tstring_end'>&#39;</span></span>

<span class='kw'>class</span> <span class='const'>SimpleChatServer</span> <span class='op'>&lt;</span> <span class='const'>EM</span><span class='op'>::</span><span class='const'>Connection</span>

  <span class='cvar'>@@connected_clients</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>


  <span class='comment'>#
</span>  <span class='comment'># EventMachine handlers
</span>  <span class='comment'>#
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_post_init'>post_init</span>
    <span class='cvar'>@@connected_clients</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='kw'>self</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>A client has connected...</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_unbind'>unbind</span>
    <span class='cvar'>@@connected_clients</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='kw'>self</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>A client has left...</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>




  <span class='comment'>#
</span>  <span class='comment'># Helpers
</span>  <span class='comment'>#
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_other_peers'>other_peers</span>
    <span class='cvar'>@@connected_clients</span><span class='period'>.</span><span class='id identifier rubyid_reject'>reject</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span> <span class='kw'>self</span> <span class='op'>==</span> <span class='id identifier rubyid_c'>c</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span> <span class='comment'># other_peers
</span><span class='kw'>end</span>

<span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_run'>run</span> <span class='kw'>do</span>
  <span class='comment'># hit Control + C to stop
</span>  <span class='const'>Signal</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>INT</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>  <span class='lbrace'>{</span> <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_stop'>stop</span> <span class='rbrace'>}</span>
  <span class='const'>Signal</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TERM</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_stop'>stop</span> <span class='rbrace'>}</span>

  <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_start_server'>start_server</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>0.0.0.0</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>10000</span><span class='comma'>,</span> <span class='const'>SimpleChatServer</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre></p>

<p>While the code we added is very straightforward, we have to clarify one this first: subclasses of <span class='object_link'><a href="EventMachine/Connection.html" title="EventMachine::Connection (class)">EventMachine::Connection</a></span> are instantiated by
EventMachine for every new connected peer. So for 10 connected chat clients, there will be 10 separate <code>SimpleChatServer</code> instances in our
server process. Like any other objects, they can be stored in a collection, can provide public API other objects use, can instantiate or inject
dependencies and in general live a happy life all Ruby objects live until garbage collection happens.</p>

<p>In the example above we use a @@class_variable to keep track of connected clients. In Ruby, @@class variables are accessible from instance
methods so we can add new connections to the list from <code>SimpleChatServer#post_init</code> and remove them in <code>SimpleChatServer#unbind</code>. We can also
filter connections by some criteria, as <code>SimpleChatServer#other_peers demonstrates</code>.</p>

<p>So, we keep track of connections but how do we identify them? For a chat app, it’s pretty common to use usernames for that. Lets ask our clients
to enter usernames when they connect.</p>

<h3 id="step-three-adding-usernames">Step three: adding usernames</h3>

<p>To add usernames, we need to add a few things:</p>

<ul>
  <li>We need to invite newly connected clients to enter their username.</li>
  <li>A reader (getter) method on our <span class='object_link'><a href="EventMachine/Connection.html" title="EventMachine::Connection (class)">EventMachine::Connection</a></span> subclass.</li>
  <li>An idea of connection state (keeping track of whether a particular participant had entered username before).</li>
</ul>

<p>Here is one way to do it:</p>

<p><pre class="code ruby"><span class='comment'>#!/usr/bin/env ruby
</span>
<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>rubygems</span><span class='tstring_end'>&#39;</span></span> <span class='comment'># or use Bundler.setup
</span><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>eventmachine</span><span class='tstring_end'>&#39;</span></span>

<span class='kw'>class</span> <span class='const'>SimpleChatServer</span> <span class='op'>&lt;</span> <span class='const'>EM</span><span class='op'>::</span><span class='const'>Connection</span>

  <span class='cvar'>@@connected_clients</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>


  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:username</span>


  <span class='comment'>#
</span>  <span class='comment'># EventMachine handlers
</span>  <span class='comment'>#
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_post_init'>post_init</span>
    <span class='ivar'>@username</span> <span class='op'>=</span> <span class='kw'>nil</span>

    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>A client has connected...</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_ask_username'>ask_username</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_unbind'>unbind</span>
    <span class='cvar'>@@connected_clients</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='kw'>self</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>A client has left...</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_receive_data'>receive_data</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_entered_username?'>entered_username?</span>
      <span class='id identifier rubyid_handle_chat_message'>handle_chat_message</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_strip'>strip</span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_handle_username'>handle_username</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_strip'>strip</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>




  <span class='comment'>#
</span>  <span class='comment'># Username handling
</span>  <span class='comment'>#
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_entered_username?'>entered_username?</span>
    <span class='op'>!</span><span class='ivar'>@username</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='ivar'>@username</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
  <span class='kw'>end</span> <span class='comment'># entered_username?
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_handle_username'>handle_username</span><span class='lparen'>(</span><span class='id identifier rubyid_input'>input</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_input'>input</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
      <span class='id identifier rubyid_send_line'>send_line</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Blank usernames are not allowed. Try again.</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='id identifier rubyid_ask_username'>ask_username</span>
    <span class='kw'>else</span>
      <span class='ivar'>@username</span> <span class='op'>=</span> <span class='id identifier rubyid_input'>input</span>
      <span class='cvar'>@@connected_clients</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='kw'>self</span><span class='rparen'>)</span>
      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_other_peers'>other_peers</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span> <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_send_data'>send_data</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@username</span><span class='embexpr_end'>}</span><span class='tstring_content'> has joined the room\n</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='rbrace'>}</span>
      <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@username</span><span class='embexpr_end'>}</span><span class='tstring_content'> has joined</span><span class='tstring_end'>&quot;</span></span>

      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_send_line'>send_line</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[info] Ohai, </span><span class='embexpr_beg'>#{</span><span class='ivar'>@username</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span> <span class='comment'># handle_username(input)
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_ask_username'>ask_username</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_send_line'>send_line</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[info] Enter your username:</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span> <span class='comment'># ask_username
</span>


  <span class='comment'>#
</span>  <span class='comment'># Message handling
</span>  <span class='comment'>#
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_handle_chat_message'>handle_chat_message</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>NotImplementedError</span>
  <span class='kw'>end</span>



  <span class='comment'>#
</span>  <span class='comment'># Helpers
</span>  <span class='comment'>#
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_other_peers'>other_peers</span>
    <span class='cvar'>@@connected_clients</span><span class='period'>.</span><span class='id identifier rubyid_reject'>reject</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span> <span class='kw'>self</span> <span class='op'>==</span> <span class='id identifier rubyid_c'>c</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span> <span class='comment'># other_peers
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_send_line'>send_line</span><span class='lparen'>(</span><span class='id identifier rubyid_line'>line</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_send_data'>send_data</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_line'>line</span><span class='embexpr_end'>}</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span> <span class='comment'># send_line(line)
</span><span class='kw'>end</span>

<span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_run'>run</span> <span class='kw'>do</span>
  <span class='comment'># hit Control + C to stop
</span>  <span class='const'>Signal</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>INT</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>  <span class='lbrace'>{</span> <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_stop'>stop</span> <span class='rbrace'>}</span>
  <span class='const'>Signal</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TERM</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_stop'>stop</span> <span class='rbrace'>}</span>

  <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_start_server'>start_server</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>0.0.0.0</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>10000</span><span class='comma'>,</span> <span class='const'>SimpleChatServer</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre></p>

<p>This is quite an update so lets take a look at each method individually. First, <code>SimpleChatServer#post_init</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_post_init'>post_init</span>
  <span class='ivar'>@username</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>A client has connected...</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_ask_username'>ask_username</span>
<span class='kw'>end</span>
</code></pre>

<p>To keep track of username we ask chat participants for, we add @username instance variable to our connection class. Connection
instances are just Ruby objects associated with a particular connected peer, so using @ivars is very natural. To make username
value accessible to other objects, we added a reader method that was not shown on the snippet above.</p>

<p>Lets dig into <code>SimpleChatServer#ask_username</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_ask_username'>ask_username</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_send_line'>send_line</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[info] Enter your username:</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
<span class='kw'>end</span> <span class='comment'># ask_username
</span>
<span class='comment'># ...
</span>
<span class='kw'>def</span> <span class='id identifier rubyid_send_line'>send_line</span><span class='lparen'>(</span><span class='id identifier rubyid_line'>line</span><span class='rparen'>)</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_send_data'>send_data</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_line'>line</span><span class='embexpr_end'>}</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
<span class='kw'>end</span> <span class='comment'># send_line(line)
</span></code></pre>

<p>Nothing new here, we are using <span class='object_link'><a href="EventMachine/Connection.html#send_data-instance_method" title="EventMachine::Connection#send_data (method)">EventMachine::Connection#send_data</a></span> which we have seen before.</p>

<p>In <code>SimpleChatServer#receive_data</code> we now have to check if the username was entered or we need
to ask for it:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_receive_data'>receive_data</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_entered_username?'>entered_username?</span>
    <span class='id identifier rubyid_handle_chat_message'>handle_chat_message</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_strip'>strip</span><span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_handle_username'>handle_username</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_strip'>strip</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='comment'># ...
</span>
<span class='kw'>def</span> <span class='id identifier rubyid_entered_username?'>entered_username?</span>
  <span class='op'>!</span><span class='ivar'>@username</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='ivar'>@username</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
<span class='kw'>end</span> <span class='comment'># entered_username?
</span></code></pre>

<p>Finally, handler of chat messages is not yet implemented:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>def</span> <span class='id identifier rubyid_handle_chat_message'>handle_chat_message</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'>NotImplementedError</span>
<span class='kw'>end</span>
</code></pre>

<p>Lets try this example out using Telnet:</p>

<pre class="code ruby"><code class="ruby">~ telnet localhost 10000
Trying 127.0.0.1...
Connected to localhost.
Escape character is &#39;^]&#39;.
[info] Enter your username:
antares_
[info] Ohai, antares_
</code></pre>

<p>and the server output:</p>

<pre class="code ruby"><code class="ruby">A client has connected...
antares_ has joined
</code></pre>

<p>This version requires you to remember how to terminate your Telnet session (Ctrl + Shift + ], then Ctrl + C).
It is annoying, so why don’t we add the same <code>exit</code> command to our chat server?</p>

<h3 id="step-four-adding-exit-command-and-delivering-chat-messages">Step four: adding exit command and delivering chat messages</h3>

<p><pre class="code ruby"><span class='comment'>#!/usr/bin/env ruby
</span>
<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>rubygems</span><span class='tstring_end'>&#39;</span></span> <span class='comment'># or use Bundler.setup
</span><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>eventmachine</span><span class='tstring_end'>&#39;</span></span>

<span class='kw'>class</span> <span class='const'>SimpleChatServer</span> <span class='op'>&lt;</span> <span class='const'>EM</span><span class='op'>::</span><span class='const'>Connection</span>

  <span class='cvar'>@@connected_clients</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>


  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:username</span>


  <span class='comment'>#
</span>  <span class='comment'># EventMachine handlers
</span>  <span class='comment'>#
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_post_init'>post_init</span>
    <span class='ivar'>@username</span> <span class='op'>=</span> <span class='kw'>nil</span>

    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>A client has connected...</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_ask_username'>ask_username</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_unbind'>unbind</span>
    <span class='cvar'>@@connected_clients</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='kw'>self</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[info] </span><span class='embexpr_beg'>#{</span><span class='ivar'>@username</span><span class='embexpr_end'>}</span><span class='tstring_content'> has left</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_entered_username?'>entered_username?</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_receive_data'>receive_data</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_entered_username?'>entered_username?</span>
      <span class='id identifier rubyid_handle_chat_message'>handle_chat_message</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_strip'>strip</span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_handle_username'>handle_username</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_strip'>strip</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>




  <span class='comment'>#
</span>  <span class='comment'># Username handling
</span>  <span class='comment'>#
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_entered_username?'>entered_username?</span>
    <span class='op'>!</span><span class='ivar'>@username</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='ivar'>@username</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
  <span class='kw'>end</span> <span class='comment'># entered_username?
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_handle_username'>handle_username</span><span class='lparen'>(</span><span class='id identifier rubyid_input'>input</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_input'>input</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
      <span class='id identifier rubyid_send_line'>send_line</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Blank usernames are not allowed. Try again.</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='id identifier rubyid_ask_username'>ask_username</span>
    <span class='kw'>else</span>
      <span class='ivar'>@username</span> <span class='op'>=</span> <span class='id identifier rubyid_input'>input</span>
      <span class='cvar'>@@connected_clients</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='kw'>self</span><span class='rparen'>)</span>
      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_other_peers'>other_peers</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span> <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_send_data'>send_data</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@username</span><span class='embexpr_end'>}</span><span class='tstring_content'> has joined the room\n</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='rbrace'>}</span>
      <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@username</span><span class='embexpr_end'>}</span><span class='tstring_content'> has joined</span><span class='tstring_end'>&quot;</span></span>

      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_send_line'>send_line</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[info] Ohai, </span><span class='embexpr_beg'>#{</span><span class='ivar'>@username</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span> <span class='comment'># handle_username(input)
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_ask_username'>ask_username</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_send_line'>send_line</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[info] Enter your username:</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span> <span class='comment'># ask_username
</span>


  <span class='comment'>#
</span>  <span class='comment'># Message handling
</span>  <span class='comment'>#
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_handle_chat_message'>handle_chat_message</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_command?'>command?</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='rparen'>)</span>
      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_handle_command'>handle_command</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_announce'>announce</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@username</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>


  <span class='comment'>#
</span>  <span class='comment'># Commands handling
</span>  <span class='comment'>#
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_command?'>command?</span><span class='lparen'>(</span><span class='id identifier rubyid_input'>input</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_input'>input</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>exit$</span><span class='regexp_end'>/i</span></span>
  <span class='kw'>end</span> <span class='comment'># command?(input)
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_handle_command'>handle_command</span><span class='lparen'>(</span><span class='id identifier rubyid_cmd'>cmd</span><span class='rparen'>)</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_cmd'>cmd</span>
    <span class='kw'>when</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>exit$</span><span class='regexp_end'>/i</span></span>   <span class='kw'>then</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_close_connection'>close_connection</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span> <span class='comment'># handle_command(cmd)
</span>


  <span class='comment'>#
</span>  <span class='comment'># Helpers
</span>  <span class='comment'>#
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_announce'>announce</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_prefix'>prefix</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[chat server]</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='cvar'>@@connected_clients</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span> <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_send_line'>send_line</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_prefix'>prefix</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_msg'>msg</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='rbrace'>}</span> <span class='kw'>unless</span> <span class='id identifier rubyid_msg'>msg</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
  <span class='kw'>end</span> <span class='comment'># announce(msg)
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_other_peers'>other_peers</span>
    <span class='cvar'>@@connected_clients</span><span class='period'>.</span><span class='id identifier rubyid_reject'>reject</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span> <span class='kw'>self</span> <span class='op'>==</span> <span class='id identifier rubyid_c'>c</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span> <span class='comment'># other_peers
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_send_line'>send_line</span><span class='lparen'>(</span><span class='id identifier rubyid_line'>line</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_send_data'>send_data</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_line'>line</span><span class='embexpr_end'>}</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span> <span class='comment'># send_line(line)
</span><span class='kw'>end</span>

<span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_run'>run</span> <span class='kw'>do</span>
  <span class='comment'># hit Control + C to stop
</span>  <span class='const'>Signal</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>INT</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>  <span class='lbrace'>{</span> <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_stop'>stop</span> <span class='rbrace'>}</span>
  <span class='const'>Signal</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TERM</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_stop'>stop</span> <span class='rbrace'>}</span>

  <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_start_server'>start_server</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>0.0.0.0</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>10000</span><span class='comma'>,</span> <span class='const'>SimpleChatServer</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre></p>

<p>TBD</p>

<p>Lets test-drive this version. Client A:</p>

<pre class="code ruby"><code class="ruby">~ telnet localhost 10000
Trying 127.0.0.1...
Connected to localhost.
Escape character is &#39;^]&#39;.
[info] Enter your username:
michael
[info] Ohai, michael
Hi everyone
michael: Hi everyone
joe has joined the room
# here ^^^ client B connects, lets greet him
hi joe
michael: hi joe
joe: hey michael
# ^^^ client B replies
exit
# ^^^ out command in action
Connection closed by foreign host.
</code></pre>

<p>Client B:</p>

<pre class="code ruby"><code class="ruby">~ telnet localhost 10000
Trying 127.0.0.1...
Connected to localhost.
Escape character is &#39;^]&#39;.
[info] Enter your username:
joe
[info] Ohai, joe
michael: hi joe
# ^^^ client A greets us, lets reply
hey michael
joe: hey michael
exit
# ^^^ out command in action
Connection closed by foreign host.
</code></pre>

<p>And finally, the server output:</p>

<pre class="code ruby"><code class="ruby">A client has connected...
michael has joined
A client has connected...
_antares has joined
[info] _antares has left
[info] michael has left
</code></pre>

<p>Our little char server now supports usernames, sending messages and the <code>exit</code> command. Next up, private (aka direct) messages.</p>

<h3 id="step-five-adding-direct-messages-and-one-more-command">Step five: adding direct messages and one more command</h3>

<p>To add direct messages, we come up with a simple convention: private messages begin with @username and may have optional colon before
message text, like this:</p>

<pre class="code ruby"><code class="ruby">@joe: hey, how do you like eventmachine?
</code></pre>

<p>This convention makes parsing of messages simple so that we can concentrate on delivering them to a particular client connection.
Remember when we added <code>username</code> reader on our connection class? That tiny change makes this step possible: when a new direct
message comes in, we extract username and message text and then find then connection for @username in question:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'>#
</span><span class='comment'># Message handling
</span><span class='comment'>#
</span>  
<span class='kw'>def</span> <span class='id identifier rubyid_handle_chat_message'>handle_chat_message</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_command?'>command?</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_handle_command'>handle_command</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_direct_message?'>direct_message?</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='rparen'>)</span>
      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_handle_direct_message'>handle_direct_message</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_announce'>announce</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@username</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span> <span class='comment'># handle_chat_message(msg)
</span>  
<span class='kw'>def</span> <span class='id identifier rubyid_direct_message?'>direct_message?</span><span class='lparen'>(</span><span class='id identifier rubyid_input'>input</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_input'>input</span> <span class='op'>=~</span> <span class='const'>DM_REGEXP</span>
<span class='kw'>end</span> <span class='comment'># direct_message?(input)
</span>  
<span class='kw'>def</span> <span class='id identifier rubyid_handle_direct_message'>handle_direct_message</span><span class='lparen'>(</span><span class='id identifier rubyid_input'>input</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_username'>username</span><span class='comma'>,</span> <span class='id identifier rubyid_message'>message</span> <span class='op'>=</span> <span class='id identifier rubyid_parse_direct_message'>parse_direct_message</span><span class='lparen'>(</span><span class='id identifier rubyid_input'>input</span><span class='rparen'>)</span>
  
  <span class='kw'>if</span> <span class='id identifier rubyid_connection'>connection</span> <span class='op'>=</span> <span class='cvar'>@@connected_clients</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span> <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_username'>username</span> <span class='op'>==</span> <span class='id identifier rubyid_username'>username</span> <span class='rbrace'>}</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[dm] @</span><span class='embexpr_beg'>#{</span><span class='ivar'>@username</span><span class='embexpr_end'>}</span><span class='tstring_content'> =&gt; @</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_username'>username</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_connection'>connection</span><span class='period'>.</span><span class='id identifier rubyid_send_line'>send_line</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[dm] @</span><span class='embexpr_beg'>#{</span><span class='ivar'>@username</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_send_line'>send_line</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>@</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_username'>username</span><span class='embexpr_end'>}</span><span class='tstring_content'> is not in the room. Here&#39;s who is: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_usernames'>usernames</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>, </span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span> <span class='comment'># handle_direct_message(input)
</span>  
<span class='kw'>def</span> <span class='id identifier rubyid_parse_direct_message'>parse_direct_message</span><span class='lparen'>(</span><span class='id identifier rubyid_input'>input</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='lbracket'>[</span><span class='backref'>$1</span><span class='comma'>,</span> <span class='backref'>$2</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_input'>input</span> <span class='op'>=~</span> <span class='const'>DM_REGEXP</span>
<span class='kw'>end</span> <span class='comment'># parse_direct_message(input)
</span></code></pre>

<p>This snippet demonstrates how one connection instance can obtain another connection instance and send data to it.
This is a very powerful feature, consider just a few use cases:</p>

<ul>
  <li>Peer-to-peer protocols</li>
  <li>Content-aware routing</li>
  <li>Efficient streaming with optional filtering</li>
</ul>

<p>Less common use cases include extending C++ core of EventMachine to provide access to  hardware that streams events that
can be re-broadcasted to any interested parties connected via TCP, UDP or something like AMQP or WebSockets. With this,
sky is the limit. Actually, EventMachine has several features for efficient proxying data between connections.
We will not cover them in this guide.</p>

<p>One last feature that we are going to add to our chat server is the <code>status</code> command that tells you current server time and how many people
are there in the chat room:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'>#
</span><span class='comment'># Commands handling
</span><span class='comment'>#
</span>  
<span class='kw'>def</span> <span class='id identifier rubyid_command?'>command?</span><span class='lparen'>(</span><span class='id identifier rubyid_input'>input</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_input'>input</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>(exit|status)$</span><span class='regexp_end'>/i</span></span>
<span class='kw'>end</span> <span class='comment'># command?(input)
</span>  
<span class='kw'>def</span> <span class='id identifier rubyid_handle_command'>handle_command</span><span class='lparen'>(</span><span class='id identifier rubyid_cmd'>cmd</span><span class='rparen'>)</span>
  <span class='kw'>case</span> <span class='id identifier rubyid_cmd'>cmd</span>
  <span class='kw'>when</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>exit$</span><span class='regexp_end'>/i</span></span>   <span class='kw'>then</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_close_connection'>close_connection</span>
  <span class='kw'>when</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>status$</span><span class='regexp_end'>/i</span></span> <span class='kw'>then</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_send_line'>send_line</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[chat server] It&#39;s </span><span class='embexpr_beg'>#{</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_strftime'>strftime</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>%H:%M</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'> and there are </span><span class='embexpr_beg'>#{</span><span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_number_of_connected_clients'>number_of_connected_clients</span><span class='embexpr_end'>}</span><span class='tstring_content'> people in the room</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span> <span class='comment'># handle_command(cmd)
</span></code></pre>

<p>Hopefully this piece of code is easy to follow. Try adding a few more commands, for example, the <code>whoishere</code> command that lists people
currently in the chat room.</p>

<p>In the end, our chat server looks like this:</p>

<p><pre class="code ruby"><span class='comment'>#!/usr/bin/env ruby
</span>
<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>rubygems</span><span class='tstring_end'>&#39;</span></span> <span class='comment'># or use Bundler.setup
</span><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>eventmachine</span><span class='tstring_end'>&#39;</span></span>

<span class='kw'>class</span> <span class='const'>SimpleChatServer</span> <span class='op'>&lt;</span> <span class='const'>EM</span><span class='op'>::</span><span class='const'>Connection</span>

  <span class='cvar'>@@connected_clients</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='const'>DM_REGEXP</span>           <span class='op'>=</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^@([a-zA-Z0-9]+)\s*:?\s+(.+)</span><span class='regexp_end'>/</span></span><span class='period'>.</span><span class='id identifier rubyid_freeze'>freeze</span>

  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:username</span>


  <span class='comment'>#
</span>  <span class='comment'># EventMachine handlers
</span>  <span class='comment'>#
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_post_init'>post_init</span>
    <span class='ivar'>@username</span> <span class='op'>=</span> <span class='kw'>nil</span>

    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>A client has connected...</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_ask_username'>ask_username</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_unbind'>unbind</span>
    <span class='cvar'>@@connected_clients</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='kw'>self</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[info] </span><span class='embexpr_beg'>#{</span><span class='ivar'>@username</span><span class='embexpr_end'>}</span><span class='tstring_content'> has left</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_entered_username?'>entered_username?</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_receive_data'>receive_data</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_entered_username?'>entered_username?</span>
      <span class='id identifier rubyid_handle_chat_message'>handle_chat_message</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_strip'>strip</span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_handle_username'>handle_username</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_strip'>strip</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>


  <span class='comment'>#
</span>  <span class='comment'># Username handling
</span>  <span class='comment'>#
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_entered_username?'>entered_username?</span>
    <span class='op'>!</span><span class='ivar'>@username</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='ivar'>@username</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
  <span class='kw'>end</span> <span class='comment'># entered_username?
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_handle_username'>handle_username</span><span class='lparen'>(</span><span class='id identifier rubyid_input'>input</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_input'>input</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
      <span class='id identifier rubyid_send_line'>send_line</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Blank usernames are not allowed. Try again.</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='id identifier rubyid_ask_username'>ask_username</span>
    <span class='kw'>else</span>
      <span class='ivar'>@username</span> <span class='op'>=</span> <span class='id identifier rubyid_input'>input</span>
      <span class='cvar'>@@connected_clients</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='kw'>self</span><span class='rparen'>)</span>
      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_other_peers'>other_peers</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span> <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_send_data'>send_data</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@username</span><span class='embexpr_end'>}</span><span class='tstring_content'> has joined the room\n</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='rbrace'>}</span>
      <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@username</span><span class='embexpr_end'>}</span><span class='tstring_content'> has joined</span><span class='tstring_end'>&quot;</span></span>

      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_send_line'>send_line</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[info] Ohai, </span><span class='embexpr_beg'>#{</span><span class='ivar'>@username</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span> <span class='comment'># handle_username(input)
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_ask_username'>ask_username</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_send_line'>send_line</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[info] Enter your username:</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span> <span class='comment'># ask_username
</span>

  <span class='comment'>#
</span>  <span class='comment'># Message handling
</span>  <span class='comment'>#
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_handle_chat_message'>handle_chat_message</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_command?'>command?</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='rparen'>)</span>
      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_handle_command'>handle_command</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_direct_message?'>direct_message?</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='rparen'>)</span>
        <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_handle_direct_message'>handle_direct_message</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='rparen'>)</span>
      <span class='kw'>else</span>
        <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_announce'>announce</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@username</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span> <span class='comment'># handle_chat_message(msg)
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_direct_message?'>direct_message?</span><span class='lparen'>(</span><span class='id identifier rubyid_input'>input</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_input'>input</span> <span class='op'>=~</span> <span class='const'>DM_REGEXP</span>
  <span class='kw'>end</span> <span class='comment'># direct_message?(input)
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_handle_direct_message'>handle_direct_message</span><span class='lparen'>(</span><span class='id identifier rubyid_input'>input</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_username'>username</span><span class='comma'>,</span> <span class='id identifier rubyid_message'>message</span> <span class='op'>=</span> <span class='id identifier rubyid_parse_direct_message'>parse_direct_message</span><span class='lparen'>(</span><span class='id identifier rubyid_input'>input</span><span class='rparen'>)</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_connection'>connection</span> <span class='op'>=</span> <span class='cvar'>@@connected_clients</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span> <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_username'>username</span> <span class='op'>==</span> <span class='id identifier rubyid_username'>username</span> <span class='rbrace'>}</span>
      <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[dm] @</span><span class='embexpr_beg'>#{</span><span class='ivar'>@username</span><span class='embexpr_end'>}</span><span class='tstring_content'> =&gt; @</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_username'>username</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_connection'>connection</span><span class='period'>.</span><span class='id identifier rubyid_send_line'>send_line</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[dm] @</span><span class='embexpr_beg'>#{</span><span class='ivar'>@username</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_send_line'>send_line</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>@</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_username'>username</span><span class='embexpr_end'>}</span><span class='tstring_content'> is not in the room. Here&#39;s who is: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_usernames'>usernames</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>, </span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span> <span class='comment'># handle_direct_message(input)
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_parse_direct_message'>parse_direct_message</span><span class='lparen'>(</span><span class='id identifier rubyid_input'>input</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='lbracket'>[</span><span class='backref'>$1</span><span class='comma'>,</span> <span class='backref'>$2</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_input'>input</span> <span class='op'>=~</span> <span class='const'>DM_REGEXP</span>
  <span class='kw'>end</span> <span class='comment'># parse_direct_message(input)
</span>

  <span class='comment'>#
</span>  <span class='comment'># Commands handling
</span>  <span class='comment'>#
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_command?'>command?</span><span class='lparen'>(</span><span class='id identifier rubyid_input'>input</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_input'>input</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>(exit|status)$</span><span class='regexp_end'>/i</span></span>
  <span class='kw'>end</span> <span class='comment'># command?(input)
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_handle_command'>handle_command</span><span class='lparen'>(</span><span class='id identifier rubyid_cmd'>cmd</span><span class='rparen'>)</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_cmd'>cmd</span>
    <span class='kw'>when</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>exit$</span><span class='regexp_end'>/i</span></span>   <span class='kw'>then</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_close_connection'>close_connection</span>
    <span class='kw'>when</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>status$</span><span class='regexp_end'>/i</span></span> <span class='kw'>then</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_send_line'>send_line</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[chat server] It&#39;s </span><span class='embexpr_beg'>#{</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_strftime'>strftime</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>%H:%M</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'> and there are </span><span class='embexpr_beg'>#{</span><span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_number_of_connected_clients'>number_of_connected_clients</span><span class='embexpr_end'>}</span><span class='tstring_content'> people in the room</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span> <span class='comment'># handle_command(cmd)
</span>

  <span class='comment'>#
</span>  <span class='comment'># Helpers
</span>  <span class='comment'>#
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_announce'>announce</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_prefix'>prefix</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[chat server]</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='cvar'>@@connected_clients</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span> <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_send_line'>send_line</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_prefix'>prefix</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_msg'>msg</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='rbrace'>}</span> <span class='kw'>unless</span> <span class='id identifier rubyid_msg'>msg</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
  <span class='kw'>end</span> <span class='comment'># announce(msg)
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_other_peers'>other_peers</span>
    <span class='cvar'>@@connected_clients</span><span class='period'>.</span><span class='id identifier rubyid_reject'>reject</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span> <span class='kw'>self</span> <span class='op'>==</span> <span class='id identifier rubyid_c'>c</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span> <span class='comment'># other_peers
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_send_line'>send_line</span><span class='lparen'>(</span><span class='id identifier rubyid_line'>line</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_send_data'>send_data</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_line'>line</span><span class='embexpr_end'>}</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span> <span class='comment'># send_line(line)
</span><span class='kw'>end</span>

<span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_run'>run</span> <span class='kw'>do</span>
  <span class='comment'># hit Control + C to stop
</span>  <span class='const'>Signal</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>INT</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>  <span class='lbrace'>{</span> <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_stop'>stop</span> <span class='rbrace'>}</span>
  <span class='const'>Signal</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TERM</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_stop'>stop</span> <span class='rbrace'>}</span>

  <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_start_server'>start_server</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>0.0.0.0</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>10000</span><span class='comma'>,</span> <span class='const'>SimpleChatServer</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre></p>

<p>We are almost done with the server but there are some closing thoughts.</p>

<h3 id="step-six-final-version">Step six: final version</h3>

<p>Just in case, here is the final version of the chat server code we have built:</p>

<p><pre class="code ruby"><span class='comment'>#!/usr/bin/env ruby
</span>
<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>rubygems</span><span class='tstring_end'>&#39;</span></span> <span class='comment'># or use Bundler.setup
</span><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>eventmachine</span><span class='tstring_end'>&#39;</span></span>

<span class='kw'>class</span> <span class='const'>SimpleChatServer</span> <span class='op'>&lt;</span> <span class='const'>EM</span><span class='op'>::</span><span class='const'>Connection</span>

  <span class='cvar'>@@connected_clients</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='const'>DM_REGEXP</span>           <span class='op'>=</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^@([a-zA-Z0-9]+)\s*:?\s*(.+)</span><span class='regexp_end'>/</span></span><span class='period'>.</span><span class='id identifier rubyid_freeze'>freeze</span>

  <span class='id identifier rubyid_attr_reader'>attr_reader</span> <span class='symbol'>:username</span>


  <span class='comment'>#
</span>  <span class='comment'># EventMachine handlers
</span>  <span class='comment'>#
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_post_init'>post_init</span>
    <span class='ivar'>@username</span> <span class='op'>=</span> <span class='kw'>nil</span>

    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>A client has connected...</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_ask_username'>ask_username</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_unbind'>unbind</span>
    <span class='cvar'>@@connected_clients</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='kw'>self</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[info] </span><span class='embexpr_beg'>#{</span><span class='ivar'>@username</span><span class='embexpr_end'>}</span><span class='tstring_content'> has left</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_entered_username?'>entered_username?</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_receive_data'>receive_data</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_entered_username?'>entered_username?</span>
      <span class='id identifier rubyid_handle_chat_message'>handle_chat_message</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_strip'>strip</span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_handle_username'>handle_username</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_strip'>strip</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>


  <span class='comment'>#
</span>  <span class='comment'># Username handling
</span>  <span class='comment'>#
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_entered_username?'>entered_username?</span>
    <span class='op'>!</span><span class='ivar'>@username</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='ivar'>@username</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
  <span class='kw'>end</span> <span class='comment'># entered_username?
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_handle_username'>handle_username</span><span class='lparen'>(</span><span class='id identifier rubyid_input'>input</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_input'>input</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
      <span class='id identifier rubyid_send_line'>send_line</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Blank usernames are not allowed. Try again.</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='id identifier rubyid_ask_username'>ask_username</span>
    <span class='kw'>else</span>
      <span class='ivar'>@username</span> <span class='op'>=</span> <span class='id identifier rubyid_input'>input</span>
      <span class='cvar'>@@connected_clients</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='kw'>self</span><span class='rparen'>)</span>
      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_other_peers'>other_peers</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span> <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_send_data'>send_data</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@username</span><span class='embexpr_end'>}</span><span class='tstring_content'> has joined the room\n</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='rbrace'>}</span>
      <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@username</span><span class='embexpr_end'>}</span><span class='tstring_content'> has joined</span><span class='tstring_end'>&quot;</span></span>

      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_send_line'>send_line</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[info] Ohai, </span><span class='embexpr_beg'>#{</span><span class='ivar'>@username</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span> <span class='comment'># handle_username(input)
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_ask_username'>ask_username</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_send_line'>send_line</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[info] Enter your username:</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span> <span class='comment'># ask_username
</span>

  <span class='comment'>#
</span>  <span class='comment'># Message handling
</span>  <span class='comment'>#
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_handle_chat_message'>handle_chat_message</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_command?'>command?</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='rparen'>)</span>
      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_handle_command'>handle_command</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_direct_message?'>direct_message?</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='rparen'>)</span>
        <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_handle_direct_message'>handle_direct_message</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='rparen'>)</span>
      <span class='kw'>else</span>
        <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_announce'>announce</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@username</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span> <span class='comment'># handle_chat_message(msg)
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_direct_message?'>direct_message?</span><span class='lparen'>(</span><span class='id identifier rubyid_input'>input</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_input'>input</span> <span class='op'>=~</span> <span class='const'>DM_REGEXP</span>
  <span class='kw'>end</span> <span class='comment'># direct_message?(input)
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_handle_direct_message'>handle_direct_message</span><span class='lparen'>(</span><span class='id identifier rubyid_input'>input</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_username'>username</span><span class='comma'>,</span> <span class='id identifier rubyid_message'>message</span> <span class='op'>=</span> <span class='id identifier rubyid_parse_direct_message'>parse_direct_message</span><span class='lparen'>(</span><span class='id identifier rubyid_input'>input</span><span class='rparen'>)</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_connection'>connection</span> <span class='op'>=</span> <span class='cvar'>@@connected_clients</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span> <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_username'>username</span> <span class='op'>==</span> <span class='id identifier rubyid_username'>username</span> <span class='rbrace'>}</span>
      <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[dm] @</span><span class='embexpr_beg'>#{</span><span class='ivar'>@username</span><span class='embexpr_end'>}</span><span class='tstring_content'> =&gt; @</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_username'>username</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_connection'>connection</span><span class='period'>.</span><span class='id identifier rubyid_send_line'>send_line</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[dm] @</span><span class='embexpr_beg'>#{</span><span class='ivar'>@username</span><span class='embexpr_end'>}</span><span class='tstring_content'>: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_send_line'>send_line</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>@</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_username'>username</span><span class='embexpr_end'>}</span><span class='tstring_content'> is not in the room. Here&#39;s who is: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_usernames'>usernames</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>, </span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>end</span> <span class='comment'># handle_direct_message(input)
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_parse_direct_message'>parse_direct_message</span><span class='lparen'>(</span><span class='id identifier rubyid_input'>input</span><span class='rparen'>)</span>
    <span class='kw'>return</span> <span class='lbracket'>[</span><span class='backref'>$1</span><span class='comma'>,</span> <span class='backref'>$2</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_input'>input</span> <span class='op'>=~</span> <span class='const'>DM_REGEXP</span>
  <span class='kw'>end</span> <span class='comment'># parse_direct_message(input)
</span>

  <span class='comment'>#
</span>  <span class='comment'># Commands handling
</span>  <span class='comment'>#
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_command?'>command?</span><span class='lparen'>(</span><span class='id identifier rubyid_input'>input</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_input'>input</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>(exit|status)$</span><span class='regexp_end'>/i</span></span>
  <span class='kw'>end</span> <span class='comment'># command?(input)
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_handle_command'>handle_command</span><span class='lparen'>(</span><span class='id identifier rubyid_cmd'>cmd</span><span class='rparen'>)</span>
    <span class='kw'>case</span> <span class='id identifier rubyid_cmd'>cmd</span>
    <span class='kw'>when</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>exit$</span><span class='regexp_end'>/i</span></span>   <span class='kw'>then</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_close_connection'>close_connection</span>
    <span class='kw'>when</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>status$</span><span class='regexp_end'>/i</span></span> <span class='kw'>then</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_send_line'>send_line</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[chat server] It&#39;s </span><span class='embexpr_beg'>#{</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_strftime'>strftime</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>%H:%M</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'> and there are </span><span class='embexpr_beg'>#{</span><span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_number_of_connected_clients'>number_of_connected_clients</span><span class='embexpr_end'>}</span><span class='tstring_content'> people in the room</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span> <span class='comment'># handle_command(cmd)
</span>

  <span class='comment'>#
</span>  <span class='comment'># Helpers
</span>  <span class='comment'>#
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_announce'>announce</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_prefix'>prefix</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>[chat server]</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='cvar'>@@connected_clients</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span> <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_send_line'>send_line</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_prefix'>prefix</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_msg'>msg</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='rbrace'>}</span> <span class='kw'>unless</span> <span class='id identifier rubyid_msg'>msg</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
  <span class='kw'>end</span> <span class='comment'># announce(msg)
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_number_of_connected_clients'>number_of_connected_clients</span>
    <span class='cvar'>@@connected_clients</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span>
  <span class='kw'>end</span> <span class='comment'># number_of_connected_clients
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_other_peers'>other_peers</span>
    <span class='cvar'>@@connected_clients</span><span class='period'>.</span><span class='id identifier rubyid_reject'>reject</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span> <span class='kw'>self</span> <span class='op'>==</span> <span class='id identifier rubyid_c'>c</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span> <span class='comment'># other_peers
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_send_line'>send_line</span><span class='lparen'>(</span><span class='id identifier rubyid_line'>line</span><span class='rparen'>)</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_send_data'>send_data</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_line'>line</span><span class='embexpr_end'>}</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span> <span class='comment'># send_line(line)
</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_usernames'>usernames</span>
    <span class='cvar'>@@connected_clients</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span> <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_username'>username</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span> <span class='comment'># usernames
</span><span class='kw'>end</span>

<span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_run'>run</span> <span class='kw'>do</span>
  <span class='comment'># hit Control + C to stop
</span>  <span class='const'>Signal</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>INT</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>  <span class='lbrace'>{</span> <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_stop'>stop</span> <span class='rbrace'>}</span>
  <span class='const'>Signal</span><span class='period'>.</span><span class='id identifier rubyid_trap'>trap</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>TERM</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_stop'>stop</span> <span class='rbrace'>}</span>

  <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_start_server'>start_server</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>0.0.0.0</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>10000</span><span class='comma'>,</span> <span class='const'>SimpleChatServer</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre></p>

<h3 id="step-seven-future-directions-and-some-closing-thoughts">Step seven: future directions and some closing thoughts</h3>

<p>The chat server is just about 150 lines of Ruby including empty lines and comments, yet it has a few features most of chat server
examples never add. We did not, however, implement many other features that popular IRC clients like <a href="http://colloquy.info">Colloquy</a> have:</p>

<ul>
  <li>Chat moderation</li>
  <li>Multiple rooms</li>
  <li>Connection timeout detection</li>
</ul>

<p>How would one go about implementing them? We thought it is worth discussing what else EventMachine has to offer and what ecosystem projects
one can use to build a really feature-rich Web-based IRC chat client.</p>

<p>With multiple rooms it’s more or less straightforward, just add one more hash and a bunch of commands and use the information about which rooms participant
is in when you are delivering messages. There is nothing in EventMachine itself that can make the job much easier for developer.</p>

<p>To implement chat moderation feature you may want to do a few things:</p>

<ul>
  <li>Work with client IP addresses. Maybe we want to consider everyone who connects from certain IPs a moderator.</li>
  <li>Access persistent data about usernames of moderators and their credentials.</li>
</ul>

<p>Does EventMachine have anything to offer here? It does. To obtain peer IP address, take a look at <span class='object_link'><a href="EventMachine/Connection.html#get_peername-instance_method" title="EventMachine::Connection#get_peername (method)">EventMachine::Connection#get_peername</a></span>. The name of this method is
a little bit misleading and originates from low-level socket programming APIs.</p>

<h4 id="a-whirlwind-tour-of-the-eventmachine-ecosystem">A whirlwind tour of the EventMachine ecosystem</h4>

<p>To work with data stores you can use several database drivers that ship with EventMachine itself, however, quite often there are some 3rd party projects in
the EventMachine ecosystem that have more features, are faster or just better maintained. So we figured it will be helpful to provide a few pointers
to some of those projects:</p>

<ul>
  <li>For MySQL, check out <a href="https://github.com/eventmachine/em-mysql">em-mysql</a> project.</li>
  <li>For PostgreSQL, have a look at Mike Perham’s <a href="https://github.com/mperham/em_postgresql">EventMachine-based PostgreSQL driver</a>.</li>
  <li>For Redis, there is a young but already popular <a href="https://github.com/mloughran/em-hiredis">em-hiredis</a> library that combines EventMachine’s non-blocking I/O with
extreme performance of the official Redis C client, <a href="https://github.com/antirez/hiredis">hiredis</a>.</li>
  <li>For MongoDB, see <a href="https://github.com/bcg/em-mongo">em-mongo</a></li>
  <li>For Cassandra, Mike Perham <a href="http://www.mikeperham.com/2010/02/09/cassandra-and-eventmachine/">added transport agnosticism feature</a> to the <a href="https://rubygems.org/gems/cassandra">cassandra gem</a>.</li>
</ul>

<p><a href="http://www.basho.com/products_riak_overview.php">Riak</a> and CouchDB talk HTTP so it’s possible to use <a href="https://github.com/igrigorik/em-http-request">em-http-request</a>.
If you are aware of EventMachine-based non-blocking drivers for these databases, as well as for HBase, let us know on the <a href="http://groups.google.com/group/eventmachine">EventMachine mailing list</a>.
Also, EventMachine supports TLS (aka SSL) and works well on <a href="http://jruby.org">JRuby</a> and Windows.</p>

<p>Learn more in our <a href="file.Ecosystem.html" title="EventMachine ecosystem">EventMachine ecosystem</a> and <a href="file.TLS.html" title="TLS (aka SSL)">TLS (aka SSL)</a> guides.</p>

<h4 id="connection-loss-detection">Connection loss detection</h4>

<p>Finally, connection loss detection. When our chat participant closes her laptop lid, how do we know that she is no longer active? The answer is, when EventMachine
detects TCP connectin closure, it calls <span class='object_link'><a href="EventMachine/Connection.html#unbind-instance_method" title="EventMachine::Connection#unbind (method)">EventMachine::Connection#unbind</a></span>. Version 1.0.beta3 and later also pass an optional argument to that method. The argument
indicates what error (if any) caused the connection to be closed.</p>

<p>Learn more in our <a href="file.ConnectionFailureAndRecovery.html" title="Connection Failure and Recovery">Connection Failure and Recovery</a> guide.</p>

<h4 id="what-the-chat-server-example-doesnt-demonstrate">What the Chat Server Example doesn’t demonstrate</h4>

<p>This chat server also leaves out something production quality clients and servers must take care of: buffering. We intentionally did not include any buffering in
our chat server example: it would only distract you from learning what you really came here to learn: how to use EventMachine to build blazing fast asynchronous
networking programs quickly. However, <span class='object_link'><a href="EventMachine/Connection.html#receive_data-instance_method" title="EventMachine::Connection#receive_data (method)">EventMachine::Connection#receive_data</a></span> does not offer any guarantees that you will be receiving “whole messages” all the time,
largely because the underlying transport (UDP or TCP) does not offer such guarantees. Many protocols, for example, AMQP, mandate that large content chunks are
split into smaller <em>frames</em> of certain size. This means that <a href="https://github.com/ruby-amqp/amq-client">amq-client</a> library, for instance, that has EventMachine-based driver,
has to deal with figuring out when exactly we received “the whole message”. To do so, it uses buffering and employs various checks to detect <em>frame boundaries</em>.
So <strong>don’t be deceived by the simplicity of this chat example</strong>: it intentionally leaves framing out, but real world protocols usually require it.</p>

<h2 id="a-proxying-chat-client-example">A (Proxying) Chat Client Example</h2>

<p>TBD</p>

<h2 id="wrapping-up">Wrapping up</h2>

<p>This tutorial ends here. Congratulations! You have learned quite a bit about EventMachine.</p>

<h2 id="what-to-read-next">What to read next</h2>

<p>The documentation is organized as a <a href="file.DocumentationGuidesIndex.html" title="number of guides">number of guides</a>, covering all kinds of
topics. TBD</p>

<h2 id="tell-us-what-you-think">Tell us what you think!</h2>

<p>Please take a moment and tell us what you think about this guide on the <a href="http://bit.ly/jW3cR3">EventMachine mailing list</a>
or in the #eventmachine channel on irc.freenode.net: what was unclear? What wasn’t covered?
Maybe you don’t like the guide style or the grammar and spelling are incorrect? Reader feedback is
key to making documentation better.</p>
</div></div>

    <div id="footer">
  Generated on Fri Feb 21 19:34:58 2014 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.5.2 (ruby-2.0.0).
</div>

  </body>
</html>
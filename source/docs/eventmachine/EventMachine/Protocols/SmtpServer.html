<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: EventMachine::Protocols::SmtpServer
  
    &mdash; Documentation by YARD 0.8.5.2
  
</title>

  <link rel="stylesheet" href="../../css/style.css" type="text/css" media="screen" charset="utf-8" />

  <link rel="stylesheet" href="../../css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '../../';
  framesUrl = "../../frames.html#!" + escape(window.location.href);
</script>


  <script type="text/javascript" charset="utf-8" src="../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="../../_index.html">Index (S)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../EventMachine.html" title="EventMachine (module)">EventMachine</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Protocols.html" title="EventMachine::Protocols (module)">Protocols</a></span></span>
     &raquo; 
    <span class="title">SmtpServer</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="../../method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="../../file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Class: EventMachine::Protocols::SmtpServer
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName"><span class='object_link'><a href="../Connection.html" title="EventMachine::Connection (class)">Connection</a></span></span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next"><span class='object_link'><a href="../Connection.html" title="EventMachine::Connection (class)">Connection</a></span></li>
          
            <li class="next">EventMachine::Protocols::SmtpServer</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
      <dt class="r2">Includes:</dt>
      <dd class="r2"><span class='object_link'><a href="LineText2.html" title="EventMachine::Protocols::LineText2 (module)">LineText2</a></span></dd>
      
    
  
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">lib/em/protocols/smtpserver.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p>This is a protocol handler for the server side of SMTP.
It’s NOT a complete SMTP server obeying all the semantics of servers conforming to
RFC2821. Rather, it uses overridable method stubs to communicate protocol states
and data to user code. User code is responsible for doing the right things with the
data in order to get complete and correct SMTP server behavior.</p>

<p>Simple SMTP server example:</p>

<p>class EmailServer &lt; EM::P::SmtpServer
   def receive_plain_auth(user, pass)
     true
   end</p>

<p>def get_server_domain
     “mock.smtp.server.local”
   end</p>

<p>def get_server_greeting
     “mock smtp server greets you with impunity”
   end</p>

<p>def receive_sender(sender)
     current.sender = sender
     true
   end</p>

<p>def receive_recipient(recipient)
     current.recipient = recipient
     true
   end</p>

<p>def receive_message
     current.received = true
     current.completed_at = Time.now</p>

<pre class="code ruby"><code class="ruby"> p [:received_email, current]
 @current = OpenStruct.new
 true    end
</code></pre>

<p>def receive_ehlo_domain(domain)
     @ehlo_domain = domain
     true
   end</p>

<p>def receive_data_command
     current.data = “”
     true
   end</p>

<p>def receive_data_chunk(data)
     current.data « data.join(“\n”)
     true
   end</p>

<p>def receive_transaction
     if @ehlo_domain
       current.ehlo_domain = @ehlo_domain
       @ehlo_domain = nil
     end
     true
   end</p>

<p>def current
     @current ||= OpenStruct.new
   end</p>

<p>def self.start(host = ‘localhost’, port = 1025)
     require ‘ostruct’
     @server = EM.start_server host, port, self
   end</p>

<p>def self.stop
     if @server
       EM.stop_server @server
       @server = nil
     end
   end</p>

<p>def self.running?
     !!@server
   end
 end</p>

<p>EM.run{ EmailServer.start }</p>

<p>–
Useful paragraphs in RFC-2821:
4.3.2: Concise list of command-reply sequences, in essence a text representation
of the command state-machine.</p>

<p>STARTTLS is defined in RFC2487.
Observe that there are important rules governing whether a publicly-referenced server
(meaning one whose Internet address appears in public MX records) may require the
non-optional use of TLS.
Non-optional TLS does not apply to EHLO, NOOP, QUIT or STARTTLS.</p>


  </div>
</div>
<div class="tags">
  

</div>
  <h2>Constant Summary</h2>
  
    <dl class="constants">
      
        <dt id="HeloRegex-constant" class="">HeloRegex =
          
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\AHELO\s*</span><span class='regexp_end'>/i</span></span></pre></dd>
      
        <dt id="EhloRegex-constant" class="">EhloRegex =
          
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\AEHLO\s*</span><span class='regexp_end'>/i</span></span></pre></dd>
      
        <dt id="QuitRegex-constant" class="">QuitRegex =
          
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\AQUIT</span><span class='regexp_end'>/i</span></span></pre></dd>
      
        <dt id="MailFromRegex-constant" class="">MailFromRegex =
          
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\AMAIL FROM:\s*</span><span class='regexp_end'>/i</span></span></pre></dd>
      
        <dt id="RcptToRegex-constant" class="">RcptToRegex =
          
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\ARCPT TO:\s*</span><span class='regexp_end'>/i</span></span></pre></dd>
      
        <dt id="DataRegex-constant" class="">DataRegex =
          
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\ADATA</span><span class='regexp_end'>/i</span></span></pre></dd>
      
        <dt id="NoopRegex-constant" class="">NoopRegex =
          
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\ANOOP</span><span class='regexp_end'>/i</span></span></pre></dd>
      
        <dt id="RsetRegex-constant" class="">RsetRegex =
          
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\ARSET</span><span class='regexp_end'>/i</span></span></pre></dd>
      
        <dt id="VrfyRegex-constant" class="">VrfyRegex =
          
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\AVRFY\s+</span><span class='regexp_end'>/i</span></span></pre></dd>
      
        <dt id="ExpnRegex-constant" class="">ExpnRegex =
          
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\AEXPN\s+</span><span class='regexp_end'>/i</span></span></pre></dd>
      
        <dt id="HelpRegex-constant" class="">HelpRegex =
          
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\AHELP</span><span class='regexp_end'>/i</span></span></pre></dd>
      
        <dt id="StarttlsRegex-constant" class="">StarttlsRegex =
          
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\ASTARTTLS</span><span class='regexp_end'>/i</span></span></pre></dd>
      
        <dt id="AuthRegex-constant" class="">AuthRegex =
          
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\AAUTH\s+</span><span class='regexp_end'>/i</span></span></pre></dd>
      
        <dt id="parms-classvariable" class="">@@parms =
          <div class="docstring">
  <div class="discussion">
    <p>Class variable containing default parameters that can be overridden
in application code.
Individual objects of this class will make an instance-local copy of
the class variable, so that they can be reconfigured on a per-instance
basis.</p>

<p>Chunksize is the number of data lines we’ll buffer before
sending them to the application. TODO, make this user-configurable.</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='lbrace'>{</span>
  <span class='symbol'>:chunksize</span> <span class='op'>=&gt;</span> <span class='int'>4000</span><span class='comma'>,</span>
  <span class='symbol'>:verbose</span> <span class='op'>=&gt;</span> <span class='kw'>false</span>
<span class='rbrace'>}</span></pre></dd>
      
    </dl>
  



  
  
  <h3 class="inherited">Constants included
     from <span class='object_link'><a href="LineText2.html" title="EventMachine::Protocols::LineText2 (module)">LineText2</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="LineText2.html#MaxBinaryLength-constant" title="EventMachine::Protocols::LineText2::MaxBinaryLength (constant)">LineText2::MaxBinaryLength</a></span>, <span class='object_link'><a href="LineText2.html#MaxLineLength-constant" title="EventMachine::Protocols::LineText2::MaxLineLength (constant)">LineText2::MaxLineLength</a></span></p>





  
    <h2>
      Class Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#parms%3D-class_method" title="parms= (class method)">+ (Object) <strong>parms=</strong>(parms = {}) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
    </ul>
  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#connection_ended-instance_method" title="#connection_ended (instance method)">- (Object) <strong>connection_ended</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Sent when the remote peer has ended the connection.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#get_server_domain-instance_method" title="#get_server_domain (instance method)">- (Object) <strong>get_server_domain</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>The domain name returned in the first line of the response to a
successful EHLO or HELO command.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#get_server_greeting-instance_method" title="#get_server_greeting (instance method)">- (Object) <strong>get_server_greeting</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>The greeting returned in the initial connection message to the client.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#init_protocol_state-instance_method" title="#init_protocol_state (instance method)">- (Object) <strong>init_protocol_state</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">- (SmtpServer) <strong>initialize</strong>(*args) </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>A new instance of SmtpServer.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#parms%3D-instance_method" title="#parms= (instance method)">- (Object) <strong>parms=</strong>(parms = {}) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#post_init-instance_method" title="#post_init (instance method)">- (Object) <strong>post_init</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>In SMTP, the server talks first.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#process_auth-instance_method" title="#process_auth (instance method)">- (Object) <strong>process_auth</strong>(str) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>–
So far, only AUTH PLAIN is supported but we should do at least LOGIN as well.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#process_auth_line-instance_method" title="#process_auth_line (instance method)">- (Object) <strong>process_auth_line</strong>(line) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#process_data-instance_method" title="#process_data (instance method)">- (Object) <strong>process_data</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>–
Unusually, we can deal with a Deferrable returned from the user application.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#process_data_line-instance_method" title="#process_data_line (instance method)">- (Object) <strong>process_data_line</strong>(ln) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Send the incoming data to the application one chunk at a time, rather than
one line at a time.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#process_ehlo-instance_method" title="#process_ehlo (instance method)">- (Object) <strong>process_ehlo</strong>(domain) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>–
EHLO/HELO is always legal, per the standard.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#process_expn-instance_method" title="#process_expn (instance method)">- (Object) <strong>process_expn</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>TODO - implement this properly, the implementation is a stub!.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#process_helo-instance_method" title="#process_helo (instance method)">- (Object) <strong>process_helo</strong>(domain) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#process_help-instance_method" title="#process_help (instance method)">- (Object) <strong>process_help</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>TODO - implement this properly, the implementation is a stub!.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#process_mail_from-instance_method" title="#process_mail_from (instance method)">- (Object) <strong>process_mail_from</strong>(sender) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>–
Requiring TLS is touchy, cf RFC2784.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#process_noop-instance_method" title="#process_noop (instance method)">- (Object) <strong>process_noop</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#process_quit-instance_method" title="#process_quit (instance method)">- (Object) <strong>process_quit</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#process_rcpt_to-instance_method" title="#process_rcpt_to (instance method)">- (Object) <strong>process_rcpt_to</strong>(rcpt) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>–
Since we require :mail_from to have been seen before we process RCPT TO,
we don’t need to repeat the tests for TLS and AUTH.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#process_rset-instance_method" title="#process_rset (instance method)">- (Object) <strong>process_rset</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#process_starttls-instance_method" title="#process_starttls (instance method)">- (Object) <strong>process_starttls</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>–
STARTTLS may not be issued before EHLO, or unless the user has chosen
to support it.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#process_unknown-instance_method" title="#process_unknown (instance method)">- (Object) <strong>process_unknown</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#process_vrfy-instance_method" title="#process_vrfy (instance method)">- (Object) <strong>process_vrfy</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>TODO - implement this properly, the implementation is a stub!.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#receive_data_chunk-instance_method" title="#receive_data_chunk (instance method)">- (Object) <strong>receive_data_chunk</strong>(data) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Sent when data from the remote peer is available.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#receive_data_command-instance_method" title="#receive_data_command (instance method)">- (Object) <strong>receive_data_command</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Called when the remote peer sends the DATA command.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#receive_ehlo_domain-instance_method" title="#receive_ehlo_domain (instance method)">- (Object) <strong>receive_ehlo_domain</strong>(domain) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>A false response from this user-overridable method will cause a
550 error to be returned to the remote client.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#receive_line-instance_method" title="#receive_line (instance method)">- (Object) <strong>receive_line</strong>(ln) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#receive_message-instance_method" title="#receive_message (instance method)">- (Object) <strong>receive_message</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Sent after a message has been completely received.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#receive_plain_auth-instance_method" title="#receive_plain_auth (instance method)">- (Object) <strong>receive_plain_auth</strong>(user, password) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Return true or false to indicate that the authentication is acceptable.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#receive_recipient-instance_method" title="#receive_recipient (instance method)">- (Object) <strong>receive_recipient</strong>(rcpt) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Receives the argument of a RCPT TO command.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#receive_reset-instance_method" title="#receive_reset (instance method)">- (Object) <strong>receive_reset</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Sent when the remote peer issues the RSET command.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#receive_sender-instance_method" title="#receive_sender (instance method)">- (Object) <strong>receive_sender</strong>(sender) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Receives the argument of the MAIL FROM command.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#receive_transaction-instance_method" title="#receive_transaction (instance method)">- (Object) <strong>receive_transaction</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>This is called when the protocol state is reset.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#reset_protocol_state-instance_method" title="#reset_protocol_state (instance method)">- (Object) <strong>reset_protocol_state</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>–
This is called at several points to restore the protocol state
to a pre-transaction state.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#send_server_greeting-instance_method" title="#send_server_greeting (instance method)">- (Object) <strong>send_server_greeting</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#unbind-instance_method" title="#unbind (instance method)">- (Object) <strong>unbind</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods included from <span class='object_link'><a href="LineText2.html" title="EventMachine::Protocols::LineText2 (module)">LineText2</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="LineText2.html#receive_binary_data-instance_method" title="EventMachine::Protocols::LineText2#receive_binary_data (method)">#receive_binary_data</a></span>, <span class='object_link'><a href="LineText2.html#receive_data-instance_method" title="EventMachine::Protocols::LineText2#receive_data (method)">#receive_data</a></span>, <span class='object_link'><a href="LineText2.html#receive_end_of_binary_data-instance_method" title="EventMachine::Protocols::LineText2#receive_end_of_binary_data (method)">#receive_end_of_binary_data</a></span>, <span class='object_link'><a href="LineText2.html#set_binary_mode-instance_method" title="EventMachine::Protocols::LineText2#set_binary_mode (method)">#set_binary_mode</a></span>, <span class='object_link'><a href="LineText2.html#set_delimiter-instance_method" title="EventMachine::Protocols::LineText2#set_delimiter (method)">#set_delimiter</a></span>, <span class='object_link'><a href="LineText2.html#set_line_mode-instance_method" title="EventMachine::Protocols::LineText2#set_line_mode (method)">#set_line_mode</a></span>, <span class='object_link'><a href="LineText2.html#set_text_mode-instance_method" title="EventMachine::Protocols::LineText2#set_text_mode (method)">#set_text_mode</a></span></p>

  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods inherited from <span class='object_link'><a href="../Connection.html" title="EventMachine::Connection (class)">Connection</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="../Connection.html#close_connection-instance_method" title="EventMachine::Connection#close_connection (method)">#close_connection</a></span>, <span class='object_link'><a href="../Connection.html#close_connection_after_writing-instance_method" title="EventMachine::Connection#close_connection_after_writing (method)">#close_connection_after_writing</a></span>, <span class='object_link'><a href="../Connection.html#comm_inactivity_timeout-instance_method" title="EventMachine::Connection#comm_inactivity_timeout (method)">#comm_inactivity_timeout</a></span>, <span class='object_link'><a href="../Connection.html#comm_inactivity_timeout%3D-instance_method" title="EventMachine::Connection#comm_inactivity_timeout= (method)">#comm_inactivity_timeout=</a></span>, <span class='object_link'><a href="../Connection.html#connection_completed-instance_method" title="EventMachine::Connection#connection_completed (method)">#connection_completed</a></span>, <span class='object_link'><a href="../Connection.html#detach-instance_method" title="EventMachine::Connection#detach (method)">#detach</a></span>, <span class='object_link'><a href="../Connection.html#error%3F-instance_method" title="EventMachine::Connection#error? (method)">#error?</a></span>, <span class='object_link'><a href="../Connection.html#get_idle_time-instance_method" title="EventMachine::Connection#get_idle_time (method)">#get_idle_time</a></span>, <span class='object_link'><a href="../Connection.html#get_peer_cert-instance_method" title="EventMachine::Connection#get_peer_cert (method)">#get_peer_cert</a></span>, <span class='object_link'><a href="../Connection.html#get_peername-instance_method" title="EventMachine::Connection#get_peername (method)">#get_peername</a></span>, <span class='object_link'><a href="../Connection.html#get_pid-instance_method" title="EventMachine::Connection#get_pid (method)">#get_pid</a></span>, <span class='object_link'><a href="../Connection.html#get_proxied_bytes-instance_method" title="EventMachine::Connection#get_proxied_bytes (method)">#get_proxied_bytes</a></span>, <span class='object_link'><a href="../Connection.html#get_sock_opt-instance_method" title="EventMachine::Connection#get_sock_opt (method)">#get_sock_opt</a></span>, <span class='object_link'><a href="../Connection.html#get_sockname-instance_method" title="EventMachine::Connection#get_sockname (method)">#get_sockname</a></span>, <span class='object_link'><a href="../Connection.html#get_status-instance_method" title="EventMachine::Connection#get_status (method)">#get_status</a></span>, <span class='object_link'><a href="../Connection.html#notify_readable%3D-instance_method" title="EventMachine::Connection#notify_readable= (method)">#notify_readable=</a></span>, <span class='object_link'><a href="../Connection.html#notify_readable%3F-instance_method" title="EventMachine::Connection#notify_readable? (method)">#notify_readable?</a></span>, <span class='object_link'><a href="../Connection.html#notify_writable%3D-instance_method" title="EventMachine::Connection#notify_writable= (method)">#notify_writable=</a></span>, <span class='object_link'><a href="../Connection.html#notify_writable%3F-instance_method" title="EventMachine::Connection#notify_writable? (method)">#notify_writable?</a></span>, <span class='object_link'><a href="../Connection.html#pause-instance_method" title="EventMachine::Connection#pause (method)">#pause</a></span>, <span class='object_link'><a href="../Connection.html#paused%3F-instance_method" title="EventMachine::Connection#paused? (method)">#paused?</a></span>, <span class='object_link'><a href="../Connection.html#pending_connect_timeout-instance_method" title="EventMachine::Connection#pending_connect_timeout (method)">#pending_connect_timeout</a></span>, <span class='object_link'><a href="../Connection.html#pending_connect_timeout%3D-instance_method" title="EventMachine::Connection#pending_connect_timeout= (method)">#pending_connect_timeout=</a></span>, <span class='object_link'><a href="../Connection.html#proxy_completed-instance_method" title="EventMachine::Connection#proxy_completed (method)">#proxy_completed</a></span>, <span class='object_link'><a href="../Connection.html#proxy_incoming_to-instance_method" title="EventMachine::Connection#proxy_incoming_to (method)">#proxy_incoming_to</a></span>, <span class='object_link'><a href="../Connection.html#proxy_target_unbound-instance_method" title="EventMachine::Connection#proxy_target_unbound (method)">#proxy_target_unbound</a></span>, <span class='object_link'><a href="../Connection.html#receive_data-instance_method" title="EventMachine::Connection#receive_data (method)">#receive_data</a></span>, <span class='object_link'><a href="../Connection.html#reconnect-instance_method" title="EventMachine::Connection#reconnect (method)">#reconnect</a></span>, <span class='object_link'><a href="../Connection.html#resume-instance_method" title="EventMachine::Connection#resume (method)">#resume</a></span>, <span class='object_link'><a href="../Connection.html#send_data-instance_method" title="EventMachine::Connection#send_data (method)">#send_data</a></span>, <span class='object_link'><a href="../Connection.html#send_datagram-instance_method" title="EventMachine::Connection#send_datagram (method)">#send_datagram</a></span>, <span class='object_link'><a href="../Connection.html#send_file_data-instance_method" title="EventMachine::Connection#send_file_data (method)">#send_file_data</a></span>, <span class='object_link'><a href="../Connection.html#set_sock_opt-instance_method" title="EventMachine::Connection#set_sock_opt (method)">#set_sock_opt</a></span>, <span class='object_link'><a href="../Connection.html#ssl_handshake_completed-instance_method" title="EventMachine::Connection#ssl_handshake_completed (method)">#ssl_handshake_completed</a></span>, <span class='object_link'><a href="../Connection.html#ssl_verify_peer-instance_method" title="EventMachine::Connection#ssl_verify_peer (method)">#ssl_verify_peer</a></span>, <span class='object_link'><a href="../Connection.html#start_tls-instance_method" title="EventMachine::Connection#start_tls (method)">#start_tls</a></span>, <span class='object_link'><a href="../Connection.html#stop_proxying-instance_method" title="EventMachine::Connection#stop_proxying (method)">#stop_proxying</a></span>, <span class='object_link'><a href="../Connection.html#stream_file_data-instance_method" title="EventMachine::Connection#stream_file_data (method)">#stream_file_data</a></span></p>
<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    - (<tt><span class='object_link'><a href="" title="EventMachine::Protocols::SmtpServer (class)">SmtpServer</a></span></tt>) <strong>initialize</strong>(*args) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>A new instance of SmtpServer</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


162
163
164
165
166</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 162</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span>
  <span class='kw'>super</span>
  <span class='ivar'>@parms</span> <span class='op'>=</span> <span class='cvar'>@@parms</span>
  <span class='id identifier rubyid_init_protocol_state'>init_protocol_state</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>


  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="parms=-class_method">
  
    + (<tt>Object</tt>) <strong>parms=</strong>(parms = {}) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


156
157
158</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 156</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_parms='>parms=</span> <span class='id identifier rubyid_parms'>parms</span><span class='op'>=</span><span class='lbrace'>{</span><span class='rbrace'>}</span>
  <span class='cvar'>@@parms</span><span class='period'>.</span><span class='id identifier rubyid_merge!'>merge!</span><span class='lparen'>(</span><span class='id identifier rubyid_parms'>parms</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="connection_ended-instance_method">
  
    - (<tt>Object</tt>) <strong>connection_ended</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Sent when the remote peer has ended the connection.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


606
607</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 606</span>

<span class='kw'>def</span> <span class='id identifier rubyid_connection_ended'>connection_ended</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="get_server_domain-instance_method">
  
    - (<tt>Object</tt>) <strong>get_server_domain</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>The domain name returned in the first line of the response to a
successful EHLO or HELO command.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


566
567
568</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 566</span>

<span class='kw'>def</span> <span class='id identifier rubyid_get_server_domain'>get_server_domain</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Ok EventMachine SMTP Server</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="get_server_greeting-instance_method">
  
    - (<tt>Object</tt>) <strong>get_server_greeting</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>The greeting returned in the initial connection message to the client.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


561
562
563</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 561</span>

<span class='kw'>def</span> <span class='id identifier rubyid_get_server_greeting'>get_server_greeting</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>EventMachine SMTP Server</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="init_protocol_state-instance_method">
  
    - (<tt>Object</tt>) <strong>init_protocol_state</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


270
271
272</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 270</span>

<span class='kw'>def</span> <span class='id identifier rubyid_init_protocol_state'>init_protocol_state</span>
  <span class='ivar'>@state</span> <span class='op'>||=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="parms=-instance_method">
  
    - (<tt>Object</tt>) <strong>parms=</strong>(parms = {}) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


168
169
170</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 168</span>

<span class='kw'>def</span> <span class='id identifier rubyid_parms='>parms=</span> <span class='id identifier rubyid_parms'>parms</span><span class='op'>=</span><span class='lbrace'>{</span><span class='rbrace'>}</span>
  <span class='ivar'>@parms</span><span class='period'>.</span><span class='id identifier rubyid_merge!'>merge!</span><span class='lparen'>(</span><span class='id identifier rubyid_parms'>parms</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="post_init-instance_method">
  
    - (<tt>Object</tt>) <strong>post_init</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>In SMTP, the server talks first. But by a (perhaps flawed) axiom in EM,
#post_init will execute BEFORE the block passed to #start_server, for any
given accepted connection. Since in this class we’ll probably be getting
a lot of initialization parameters, we want the guts of post_init to
run AFTER the application has initialized the connection object. So we
use a spawn to schedule the post_init to run later.
It’s a little weird, I admit. A reasonable alternative would be to set
parameters as a class variable and to do that before accepting any connections.</p>

<p>OBSOLETE, now we have @@parms. But the spawn is nice to keep as an illustration.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


183
184
185
186
187</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 183</span>

<span class='kw'>def</span> <span class='id identifier rubyid_post_init'>post_init</span>
  <span class='comment'>#send_data &quot;220 #{get_server_greeting}\r\n&quot; (ORIGINAL)
</span>  <span class='comment'>#(EM.spawn {|x| x.send_data &quot;220 #{x.get_server_greeting}\r\n&quot;}).notify(self)
</span>  <span class='lparen'>(</span><span class='const'>EM</span><span class='period'>.</span><span class='id identifier rubyid_spawn'>spawn</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_x'>x</span><span class='op'>|</span> <span class='id identifier rubyid_x'>x</span><span class='period'>.</span><span class='id identifier rubyid_send_server_greeting'>send_server_greeting</span><span class='rbrace'>}</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_notify'>notify</span><span class='lparen'>(</span><span class='kw'>self</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="process_auth-instance_method">
  
    - (<tt>Object</tt>) <strong>process_auth</strong>(str) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>–
So far, only AUTH PLAIN is supported but we should do at least LOGIN as well.
TODO, support clients that send AUTH PLAIN with no parameter, expecting a 3xx
response and a continuation of the auth conversation.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 340</span>

<span class='kw'>def</span> <span class='id identifier rubyid_process_auth'>process_auth</span> <span class='id identifier rubyid_str'>str</span>
  <span class='kw'>if</span> <span class='ivar'>@state</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='symbol'>:auth</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>503 auth already issued\r\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_str'>str</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\APLAIN\s?</span><span class='regexp_end'>/i</span></span>
    <span class='kw'>if</span> <span class='backref'>$&#39;</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>==</span> <span class='int'>0</span>
      <span class='comment'># we got a partial response, so let the client know to send the rest
</span>      <span class='ivar'>@state</span> <span class='op'>&lt;&lt;</span> <span class='symbol'>:auth_incomplete</span>
      <span class='id identifier rubyid_send_data'>send_data</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>334 \r\n</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='comment'># we got the initial response, so go ahead &amp; process it
</span>      <span class='id identifier rubyid_process_auth_line'>process_auth_line</span><span class='lparen'>(</span><span class='backref'>$&#39;</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
    <span class='comment'>#elsif str =~ /\ALOGIN\s+/i
</span>  <span class='kw'>else</span>
    <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>504 auth mechanism not available\r\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="process_auth_line-instance_method">
  
    - (<tt>Object</tt>) <strong>process_auth_line</strong>(line) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


358
359
360
361
362
363
364
365
366
367
368</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 358</span>

<span class='kw'>def</span> <span class='id identifier rubyid_process_auth_line'>process_auth_line</span><span class='lparen'>(</span><span class='id identifier rubyid_line'>line</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_plain'>plain</span> <span class='op'>=</span> <span class='id identifier rubyid_line'>line</span><span class='period'>.</span><span class='id identifier rubyid_unpack'>unpack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>m</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
  <span class='id identifier rubyid__'>_</span><span class='comma'>,</span><span class='id identifier rubyid_user'>user</span><span class='comma'>,</span><span class='id identifier rubyid_psw'>psw</span> <span class='op'>=</span> <span class='id identifier rubyid_plain'>plain</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\000</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_receive_plain_auth'>receive_plain_auth</span> <span class='id identifier rubyid_user'>user</span><span class='comma'>,</span><span class='id identifier rubyid_psw'>psw</span>
    <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>235 authentication ok\r\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='ivar'>@state</span> <span class='op'>&lt;&lt;</span> <span class='symbol'>:auth</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>535 invalid authentication\r\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='ivar'>@state</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span> <span class='symbol'>:auth_incomplete</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="process_data-instance_method">
  
    - (<tt>Object</tt>) <strong>process_data</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>–
Unusually, we can deal with a Deferrable returned from the user application.
This was added to deal with a special case in a particular application, but
it would be a nice idea to add it to the other user-code callbacks.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 375</span>

<span class='kw'>def</span> <span class='id identifier rubyid_process_data'>process_data</span>
  <span class='kw'>unless</span> <span class='ivar'>@state</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='symbol'>:rcpt</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>503 Operation sequence error\r\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_succeeded'>succeeded</span> <span class='op'>=</span> <span class='id identifier rubyid_proc'>proc</span> <span class='lbrace'>{</span>
      <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>354 Send it\r\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='ivar'>@state</span> <span class='op'>&lt;&lt;</span> <span class='symbol'>:data</span>
      <span class='ivar'>@databuffer</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
    <span class='rbrace'>}</span>
    <span class='id identifier rubyid_failed'>failed</span> <span class='op'>=</span> <span class='id identifier rubyid_proc'>proc</span> <span class='lbrace'>{</span>
      <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>550 Operation failed\r\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='rbrace'>}</span>

    <span class='id identifier rubyid_d'>d</span> <span class='op'>=</span> <span class='id identifier rubyid_receive_data_command'>receive_data_command</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:callback</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_callback'>callback</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='id identifier rubyid_succeeded'>succeeded</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_errback'>errback</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='id identifier rubyid_failed'>failed</span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='lparen'>(</span><span class='id identifier rubyid_d'>d</span> <span class='op'>?</span> <span class='id identifier rubyid_succeeded'>succeeded</span> <span class='op'>:</span> <span class='id identifier rubyid_failed'>failed</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="process_data_line-instance_method">
  
    - (<tt>Object</tt>) <strong>process_data_line</strong>(ln) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Send the incoming data to the application one chunk at a time, rather than
one line at a time. That lets the application be a little more flexible about
storing to disk, etc.
Since we clear the chunk array every time we submit it, the caller needs to be
aware to do things like dup it if he wants to keep it around across calls.</p>

<p>Resets the transaction upon disposition of the incoming message.
RFC5321 says this about the MAIL FROM command:
 “This command tells the SMTP-receiver that a new mail transaction is
  starting and to reset all its state tables and buffers, including any
  recipients or mail data.”</p>

<p>Equivalent behaviour is implemented by resetting after a completed transaction.</p>

<p>User-written code can return a Deferrable as a response from receive_message.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 519</span>

<span class='kw'>def</span> <span class='id identifier rubyid_process_data_line'>process_data_line</span> <span class='id identifier rubyid_ln'>ln</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_ln'>ln</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>.</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>if</span> <span class='ivar'>@databuffer</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='int'>0</span>
      <span class='id identifier rubyid_receive_data_chunk'>receive_data_chunk</span> <span class='ivar'>@databuffer</span>
      <span class='ivar'>@databuffer</span><span class='period'>.</span><span class='id identifier rubyid_clear'>clear</span>
    <span class='kw'>end</span>


    <span class='id identifier rubyid_succeeded'>succeeded</span> <span class='op'>=</span> <span class='id identifier rubyid_proc'>proc</span> <span class='lbrace'>{</span>
      <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>250 Message accepted\r\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_reset_protocol_state'>reset_protocol_state</span>
    <span class='rbrace'>}</span>
    <span class='id identifier rubyid_failed'>failed</span> <span class='op'>=</span> <span class='id identifier rubyid_proc'>proc</span> <span class='lbrace'>{</span>
      <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>550 Message rejected\r\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_reset_protocol_state'>reset_protocol_state</span>
    <span class='rbrace'>}</span>
    <span class='id identifier rubyid_d'>d</span> <span class='op'>=</span> <span class='id identifier rubyid_receive_message'>receive_message</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:set_deferred_status</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_callback'>callback</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='id identifier rubyid_succeeded'>succeeded</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_errback'>errback</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='id identifier rubyid_failed'>failed</span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='lparen'>(</span><span class='id identifier rubyid_d'>d</span> <span class='op'>?</span> <span class='id identifier rubyid_succeeded'>succeeded</span> <span class='op'>:</span> <span class='id identifier rubyid_failed'>failed</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span>
    <span class='kw'>end</span>

    <span class='ivar'>@state</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span> <span class='symbol'>:data</span>
  <span class='kw'>else</span>
    <span class='comment'># slice off leading . if any
</span>    <span class='id identifier rubyid_ln'>ln</span><span class='period'>.</span><span class='id identifier rubyid_slice!'>slice!</span><span class='lparen'>(</span><span class='int'>0</span><span class='op'>...</span><span class='int'>1</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_ln'>ln</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='CHAR'>?.</span>
    <span class='ivar'>@databuffer</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_ln'>ln</span>
    <span class='kw'>if</span> <span class='ivar'>@databuffer</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='cvar'>@@parms</span><span class='lbracket'>[</span><span class='symbol'>:chunksize</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_receive_data_chunk'>receive_data_chunk</span> <span class='ivar'>@databuffer</span>
      <span class='ivar'>@databuffer</span><span class='period'>.</span><span class='id identifier rubyid_clear'>clear</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="process_ehlo-instance_method">
  
    - (<tt>Object</tt>) <strong>process_ehlo</strong>(domain) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>–
EHLO/HELO is always legal, per the standard. On success
it always clears buffers and initiates a mail “transaction.”
Which means that a MAIL FROM must follow.</p>

<p>Per the standard, an EHLO/HELO or a RSET “initiates” an email
transaction. Thereafter, MAIL FROM must be received before
RCPT TO, before DATA. Not sure what this specific ordering
achieves semantically, but it does make it easier to
implement. We also support user-specified requirements for
STARTTLS and AUTH. We make it impossible to proceed to MAIL FROM
without fulfilling tls and/or auth, if the user specified either
or both as required. We need to check the extension standard
for auth to see if a credential is discarded after a RSET along
with all the rest of the state. We’ll behave as if it is.
Now clearly, we can’t discard tls after its been negotiated
without dropping the connection, so that flag doesn’t get cleared.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 293</span>

<span class='kw'>def</span> <span class='id identifier rubyid_process_ehlo'>process_ehlo</span> <span class='id identifier rubyid_domain'>domain</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_receive_ehlo_domain'>receive_ehlo_domain</span> <span class='id identifier rubyid_domain'>domain</span>
    <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>250-</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_get_server_domain'>get_server_domain</span><span class='embexpr_end'>}</span><span class='tstring_content'>\r\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>if</span> <span class='cvar'>@@parms</span><span class='lbracket'>[</span><span class='symbol'>:starttls</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>250-STARTTLS\r\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='kw'>if</span> <span class='cvar'>@@parms</span><span class='lbracket'>[</span><span class='symbol'>:auth</span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>250-AUTH PLAIN\r\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>250-NO-SOLICITING\r\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='comment'># TODO, size needs to be configurable.
</span>    <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>250 SIZE 20000000\r\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_reset_protocol_state'>reset_protocol_state</span>
    <span class='ivar'>@state</span> <span class='op'>&lt;&lt;</span> <span class='symbol'>:ehlo</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>550 Requested action not taken\r\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="process_expn-instance_method">
  
    - (<tt>Object</tt>) <strong>process_expn</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>TODO - implement this properly, the implementation is a stub!</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


240
241
242</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 240</span>

<span class='kw'>def</span> <span class='id identifier rubyid_process_expn'>process_expn</span>
  <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>250 Ok, but unimplemented\r\n</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="process_helo-instance_method">
  
    - (<tt>Object</tt>) <strong>process_helo</strong>(domain) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


312
313
314
315
316
317
318
319
320</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 312</span>

<span class='kw'>def</span> <span class='id identifier rubyid_process_helo'>process_helo</span> <span class='id identifier rubyid_domain'>domain</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_receive_ehlo_domain'>receive_ehlo_domain</span> <span class='id identifier rubyid_domain'>domain</span><span class='period'>.</span><span class='id identifier rubyid_dup'>dup</span>
    <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>250 </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_get_server_domain'>get_server_domain</span><span class='embexpr_end'>}</span><span class='tstring_content'>\r\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_reset_protocol_state'>reset_protocol_state</span>
    <span class='ivar'>@state</span> <span class='op'>&lt;&lt;</span> <span class='symbol'>:ehlo</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>550 Requested action not taken\r\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="process_help-instance_method">
  
    - (<tt>Object</tt>) <strong>process_help</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>TODO - implement this properly, the implementation is a stub!</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


236
237
238</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 236</span>

<span class='kw'>def</span> <span class='id identifier rubyid_process_help'>process_help</span>
  <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>250 Ok, but unimplemented\r\n</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="process_mail_from-instance_method">
  
    - (<tt>Object</tt>) <strong>process_mail_from</strong>(sender) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>–
Requiring TLS is touchy, cf RFC2784.
Requiring AUTH seems to be much more reasonable.
We don’t currently support any notion of deriving an authentication from the TLS
negotiation, although that would certainly be reasonable.
We DON’T allow MAIL FROM to be given twice.
We DON’T enforce all the various rules for validating the sender or
the reverse-path (like whether it should be null), and notifying the reverse
path in case of delivery problems. All of that is left to the calling application.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 441</span>

<span class='kw'>def</span> <span class='id identifier rubyid_process_mail_from'>process_mail_from</span> <span class='id identifier rubyid_sender'>sender</span>
  <span class='kw'>if</span> <span class='lparen'>(</span><span class='cvar'>@@parms</span><span class='lbracket'>[</span><span class='symbol'>:starttls</span><span class='rbracket'>]</span><span class='op'>==</span><span class='symbol'>:required</span> <span class='kw'>and</span> <span class='op'>!</span><span class='ivar'>@state</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='symbol'>:starttls</span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>550 This server requires STARTTLS before MAIL FROM\r\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>elsif</span> <span class='lparen'>(</span><span class='cvar'>@@parms</span><span class='lbracket'>[</span><span class='symbol'>:auth</span><span class='rbracket'>]</span><span class='op'>==</span><span class='symbol'>:required</span> <span class='kw'>and</span> <span class='op'>!</span><span class='ivar'>@state</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='symbol'>:auth</span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>550 This server requires authentication before MAIL FROM\r\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>elsif</span> <span class='ivar'>@state</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='symbol'>:mail_from</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>503 MAIL already given\r\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>else</span>
    <span class='kw'>unless</span> <span class='id identifier rubyid_receive_sender'>receive_sender</span> <span class='id identifier rubyid_sender'>sender</span>
      <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>550 sender is unacceptable\r\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>250 Ok\r\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='ivar'>@state</span> <span class='op'>&lt;&lt;</span> <span class='symbol'>:mail_from</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="process_noop-instance_method">
  
    - (<tt>Object</tt>) <strong>process_noop</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


327
328
329</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 327</span>

<span class='kw'>def</span> <span class='id identifier rubyid_process_noop'>process_noop</span>
  <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>250 Ok\r\n</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="process_quit-instance_method">
  
    - (<tt>Object</tt>) <strong>process_quit</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


322
323
324
325</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 322</span>

<span class='kw'>def</span> <span class='id identifier rubyid_process_quit'>process_quit</span>
  <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>221 Ok\r\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_close_connection_after_writing'>close_connection_after_writing</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="process_rcpt_to-instance_method">
  
    - (<tt>Object</tt>) <strong>process_rcpt_to</strong>(rcpt) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>–
Since we require :mail_from to have been seen before we process RCPT TO,
we don’t need to repeat the tests for TLS and AUTH.
Note that we don’t remember or do anything else with the recipients.
All of that is on the user code.
TODO: we should enforce user-definable limits on the total number of
recipients per transaction.
We might want to make sure that a given recipient is only seen once, but
for now we’ll let that be the user’s problem.</p>

<p>User-written code can return a deferrable from receive_recipient.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 470</span>

<span class='kw'>def</span> <span class='id identifier rubyid_process_rcpt_to'>process_rcpt_to</span> <span class='id identifier rubyid_rcpt'>rcpt</span>
  <span class='kw'>unless</span> <span class='ivar'>@state</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='symbol'>:mail_from</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>503 MAIL is required before RCPT\r\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_succeeded'>succeeded</span> <span class='op'>=</span> <span class='id identifier rubyid_proc'>proc</span> <span class='lbrace'>{</span>
      <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>250 Ok\r\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='ivar'>@state</span> <span class='op'>&lt;&lt;</span> <span class='symbol'>:rcpt</span> <span class='kw'>unless</span> <span class='ivar'>@state</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='symbol'>:rcpt</span><span class='rparen'>)</span>
    <span class='rbrace'>}</span>
    <span class='id identifier rubyid_failed'>failed</span> <span class='op'>=</span> <span class='id identifier rubyid_proc'>proc</span> <span class='lbrace'>{</span>
      <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>550 recipient is unacceptable\r\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='rbrace'>}</span>

    <span class='id identifier rubyid_d'>d</span> <span class='op'>=</span> <span class='id identifier rubyid_receive_recipient'>receive_recipient</span> <span class='id identifier rubyid_rcpt'>rcpt</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:set_deferred_status</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_callback'>callback</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='id identifier rubyid_succeeded'>succeeded</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_d'>d</span><span class='period'>.</span><span class='id identifier rubyid_errback'>errback</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='id identifier rubyid_failed'>failed</span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='lparen'>(</span><span class='id identifier rubyid_d'>d</span> <span class='op'>?</span> <span class='id identifier rubyid_succeeded'>succeeded</span> <span class='op'>:</span> <span class='id identifier rubyid_failed'>failed</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span>
    <span class='kw'>end</span>

<span class='embdoc_beg'>=begin
</span><span class='embdoc'>  unless receive_recipient rcpt
</span><span class='embdoc'>    send_data &quot;550 recipient is unacceptable\r\n&quot;
</span><span class='embdoc'>  else
</span><span class='embdoc'>    send_data &quot;250 Ok\r\n&quot;
</span><span class='embdoc'>    @state &lt;&lt; :rcpt unless @state.include?(:rcpt)
</span><span class='embdoc'>  end
</span><span class='embdoc_end'>=end
</span>  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="process_rset-instance_method">
  
    - (<tt>Object</tt>) <strong>process_rset</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


399
400
401
402
403</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 399</span>

<span class='kw'>def</span> <span class='id identifier rubyid_process_rset'>process_rset</span>
  <span class='id identifier rubyid_reset_protocol_state'>reset_protocol_state</span>
  <span class='id identifier rubyid_receive_reset'>receive_reset</span>
  <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>250 Ok\r\n</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="process_starttls-instance_method">
  
    - (<tt>Object</tt>) <strong>process_starttls</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>–
STARTTLS may not be issued before EHLO, or unless the user has chosen
to support it.
TODO, must support user-supplied certificates.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


414
415
416
417
418
419
420
421
422
423
424
425
426
427
428</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 414</span>

<span class='kw'>def</span> <span class='id identifier rubyid_process_starttls'>process_starttls</span>
  <span class='kw'>if</span> <span class='cvar'>@@parms</span><span class='lbracket'>[</span><span class='symbol'>:starttls</span><span class='rbracket'>]</span>
    <span class='kw'>if</span> <span class='ivar'>@state</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='symbol'>:starttls</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>503 TLS Already negotiated\r\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>elsif</span> <span class='op'>!</span> <span class='ivar'>@state</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='symbol'>:ehlo</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>503 EHLO required before STARTTLS\r\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>220 Start TLS negotiation\r\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_start_tls'>start_tls</span>
      <span class='ivar'>@state</span> <span class='op'>&lt;&lt;</span> <span class='symbol'>:starttls</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_process_unknown'>process_unknown</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="process_unknown-instance_method">
  
    - (<tt>Object</tt>) <strong>process_unknown</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


331
332
333</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 331</span>

<span class='kw'>def</span> <span class='id identifier rubyid_process_unknown'>process_unknown</span>
  <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>500 Unknown command\r\n</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="process_vrfy-instance_method">
  
    - (<tt>Object</tt>) <strong>process_vrfy</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>TODO - implement this properly, the implementation is a stub!</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


232
233
234</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 232</span>

<span class='kw'>def</span> <span class='id identifier rubyid_process_vrfy'>process_vrfy</span>
  <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>250 Ok, but unimplemented\r\n</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="receive_data_chunk-instance_method">
  
    - (<tt>Object</tt>) <strong>receive_data_chunk</strong>(data) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Sent when data from the remote peer is available. The size can be controlled
by setting the :chunksize parameter. This call can be made multiple times.
The goal is to strike a balance between sending the data to the application one
line at a time, and holding all of a very large message in memory.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


623
624
625
626
627</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 623</span>

<span class='kw'>def</span> <span class='id identifier rubyid_receive_data_chunk'>receive_data_chunk</span> <span class='id identifier rubyid_data'>data</span>
  <span class='ivar'>@smtps_msg_size</span> <span class='op'>||=</span> <span class='int'>0</span>
  <span class='ivar'>@smtps_msg_size</span> <span class='op'>+=</span> <span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span>
  <span class='const'>STDERR</span><span class='period'>.</span><span class='id identifier rubyid_write'>write</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&lt;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@smtps_msg_size</span><span class='embexpr_end'>}</span><span class='tstring_content'>&gt;</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="receive_data_command-instance_method">
  
    - (<tt>Object</tt>) <strong>receive_data_command</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Called when the remote peer sends the DATA command.
Returning false will cause us to send a 550 error to the peer.
This can be useful for dealing with problems that arise from processing
the whole set of sender and recipients.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


614
615
616</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 614</span>

<span class='kw'>def</span> <span class='id identifier rubyid_receive_data_command'>receive_data_command</span>
  <span class='kw'>true</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="receive_ehlo_domain-instance_method">
  
    - (<tt>Object</tt>) <strong>receive_ehlo_domain</strong>(domain) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>A false response from this user-overridable method will cause a
550 error to be returned to the remote client.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


573
574
575</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 573</span>

<span class='kw'>def</span> <span class='id identifier rubyid_receive_ehlo_domain'>receive_ehlo_domain</span> <span class='id identifier rubyid_domain'>domain</span>
  <span class='kw'>true</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="receive_line-instance_method">
  
    - (<tt>Object</tt>) <strong>receive_line</strong>(ln) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 193</span>

<span class='kw'>def</span> <span class='id identifier rubyid_receive_line'>receive_line</span> <span class='id identifier rubyid_ln'>ln</span>
  <span class='cvar'>@@parms</span><span class='lbracket'>[</span><span class='symbol'>:verbose</span><span class='rbracket'>]</span> <span class='kw'>and</span> <span class='gvar'>$&gt;</span><span class='period'>.</span><span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&gt;&gt;&gt; </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_ln'>ln</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>

  <span class='kw'>return</span> <span class='id identifier rubyid_process_data_line'>process_data_line</span><span class='lparen'>(</span><span class='id identifier rubyid_ln'>ln</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='ivar'>@state</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='symbol'>:data</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='id identifier rubyid_process_auth_line'>process_auth_line</span><span class='lparen'>(</span><span class='id identifier rubyid_ln'>ln</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='ivar'>@state</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='symbol'>:auth_incomplete</span><span class='rparen'>)</span>

  <span class='kw'>case</span> <span class='id identifier rubyid_ln'>ln</span>
  <span class='kw'>when</span> <span class='const'>EhloRegex</span>
    <span class='id identifier rubyid_process_ehlo'>process_ehlo</span> <span class='backref'>$&#39;</span><span class='period'>.</span><span class='id identifier rubyid_dup'>dup</span>
  <span class='kw'>when</span> <span class='const'>HeloRegex</span>
    <span class='id identifier rubyid_process_helo'>process_helo</span> <span class='backref'>$&#39;</span><span class='period'>.</span><span class='id identifier rubyid_dup'>dup</span>
  <span class='kw'>when</span> <span class='const'>MailFromRegex</span>
    <span class='id identifier rubyid_process_mail_from'>process_mail_from</span> <span class='backref'>$&#39;</span><span class='period'>.</span><span class='id identifier rubyid_dup'>dup</span>
  <span class='kw'>when</span> <span class='const'>RcptToRegex</span>
    <span class='id identifier rubyid_process_rcpt_to'>process_rcpt_to</span> <span class='backref'>$&#39;</span><span class='period'>.</span><span class='id identifier rubyid_dup'>dup</span>
  <span class='kw'>when</span> <span class='const'>DataRegex</span>
    <span class='id identifier rubyid_process_data'>process_data</span>
  <span class='kw'>when</span> <span class='const'>RsetRegex</span>
    <span class='id identifier rubyid_process_rset'>process_rset</span>
  <span class='kw'>when</span> <span class='const'>VrfyRegex</span>
    <span class='id identifier rubyid_process_vrfy'>process_vrfy</span>
  <span class='kw'>when</span> <span class='const'>ExpnRegex</span>
    <span class='id identifier rubyid_process_expn'>process_expn</span>
  <span class='kw'>when</span> <span class='const'>HelpRegex</span>
    <span class='id identifier rubyid_process_help'>process_help</span>
  <span class='kw'>when</span> <span class='const'>NoopRegex</span>
    <span class='id identifier rubyid_process_noop'>process_noop</span>
  <span class='kw'>when</span> <span class='const'>QuitRegex</span>
    <span class='id identifier rubyid_process_quit'>process_quit</span>
  <span class='kw'>when</span> <span class='const'>StarttlsRegex</span>
    <span class='id identifier rubyid_process_starttls'>process_starttls</span>
  <span class='kw'>when</span> <span class='const'>AuthRegex</span>
    <span class='id identifier rubyid_process_auth'>process_auth</span> <span class='backref'>$&#39;</span><span class='period'>.</span><span class='id identifier rubyid_dup'>dup</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_process_unknown'>process_unknown</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="receive_message-instance_method">
  
    - (<tt>Object</tt>) <strong>receive_message</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Sent after a message has been completely received. User code
must return true or false to indicate whether the message has
been accepted for delivery.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


632
633
634
635</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 632</span>

<span class='kw'>def</span> <span class='id identifier rubyid_receive_message'>receive_message</span>
  <span class='cvar'>@@parms</span><span class='lbracket'>[</span><span class='symbol'>:verbose</span><span class='rbracket'>]</span> <span class='kw'>and</span> <span class='gvar'>$&gt;</span><span class='period'>.</span><span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Received complete message</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>true</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="receive_plain_auth-instance_method">
  
    - (<tt>Object</tt>) <strong>receive_plain_auth</strong>(user, password) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Return true or false to indicate that the authentication is acceptable.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


578
579
580</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 578</span>

<span class='kw'>def</span> <span class='id identifier rubyid_receive_plain_auth'>receive_plain_auth</span> <span class='id identifier rubyid_user'>user</span><span class='comma'>,</span> <span class='id identifier rubyid_password'>password</span>
  <span class='kw'>true</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="receive_recipient-instance_method">
  
    - (<tt>Object</tt>) <strong>receive_recipient</strong>(rcpt) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Receives the argument of a RCPT TO command. Can be given multiple
times per transaction. Return false to reject the recipient.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


593
594
595</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 593</span>

<span class='kw'>def</span> <span class='id identifier rubyid_receive_recipient'>receive_recipient</span> <span class='id identifier rubyid_rcpt'>rcpt</span>
  <span class='kw'>true</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="receive_reset-instance_method">
  
    - (<tt>Object</tt>) <strong>receive_reset</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Sent when the remote peer issues the RSET command.
Since RSET is not allowed to fail (according to the protocol),
we ignore any return value from user overrides of this method.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


601
602</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 601</span>

<span class='kw'>def</span> <span class='id identifier rubyid_receive_reset'>receive_reset</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="receive_sender-instance_method">
  
    - (<tt>Object</tt>) <strong>receive_sender</strong>(sender) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Receives the argument of the MAIL FROM command. Return false to
indicate to the remote client that the sender is not accepted.
This can only be successfully called once per transaction.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


586
587
588</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 586</span>

<span class='kw'>def</span> <span class='id identifier rubyid_receive_sender'>receive_sender</span> <span class='id identifier rubyid_sender'>sender</span>
  <span class='kw'>true</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="receive_transaction-instance_method">
  
    - (<tt>Object</tt>) <strong>receive_transaction</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>This is called when the protocol state is reset. It happens
when the remote client calls EHLO/HELO or RSET.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


639
640</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 639</span>

<span class='kw'>def</span> <span class='id identifier rubyid_receive_transaction'>receive_transaction</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="reset_protocol_state-instance_method">
  
    - (<tt>Object</tt>) <strong>reset_protocol_state</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>–
This is called at several points to restore the protocol state
to a pre-transaction state. In essence, we “forget” having seen
any valid command except EHLO and STARTTLS.
We also have to callback user code, in case they’re keeping track
of senders, recipients, and whatnot.</p>

<p>We try to follow the convention of avoiding the verb “receive” for
internal method names except receive_line (which we inherit), and
using only receive_xxx for user-overridable stubs.</p>

<p>init_protocol_state is called when we initialize the connection as
well as during reset_protocol_state. It does NOT call the user
override method. This enables us to promise the users that they
won’t see the overridable fire except after EHLO and RSET, and
after a message has been received. Although the latter may be wrong.
The standard may allow multiple DATA segments with the same set of
senders and recipients.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


263
264
265
266
267
268
269</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 263</span>

<span class='kw'>def</span> <span class='id identifier rubyid_reset_protocol_state'>reset_protocol_state</span>
  <span class='id identifier rubyid_init_protocol_state'>init_protocol_state</span>
  <span class='id identifier rubyid_s'>s</span><span class='comma'>,</span><span class='ivar'>@state</span> <span class='op'>=</span> <span class='ivar'>@state</span><span class='comma'>,</span><span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='ivar'>@state</span> <span class='op'>&lt;&lt;</span> <span class='symbol'>:starttls</span> <span class='kw'>if</span> <span class='id identifier rubyid_s'>s</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='symbol'>:starttls</span><span class='rparen'>)</span>
  <span class='ivar'>@state</span> <span class='op'>&lt;&lt;</span> <span class='symbol'>:ehlo</span> <span class='kw'>if</span> <span class='id identifier rubyid_s'>s</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='symbol'>:ehlo</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_receive_transaction'>receive_transaction</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="send_server_greeting-instance_method">
  
    - (<tt>Object</tt>) <strong>send_server_greeting</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


189
190
191</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 189</span>

<span class='kw'>def</span> <span class='id identifier rubyid_send_server_greeting'>send_server_greeting</span>
  <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>220 </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_get_server_greeting'>get_server_greeting</span><span class='embexpr_end'>}</span><span class='tstring_content'>\r\n</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="unbind-instance_method">
  
    - (<tt>Object</tt>) <strong>unbind</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


405
406
407</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/protocols/smtpserver.rb', line 405</span>

<span class='kw'>def</span> <span class='id identifier rubyid_unbind'>unbind</span>
  <span class='id identifier rubyid_connection_ended'>connection_ended</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Fri Feb 21 19:35:01 2014 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.5.2 (ruby-2.0.0).
</div>

  </body>
</html>
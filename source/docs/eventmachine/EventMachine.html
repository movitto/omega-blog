<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Module: EventMachine
  
    &mdash; Documentation by YARD 0.8.5.2
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" media="screen" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" media="screen" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '';
  framesUrl = "frames.html#!" + escape(window.location.href);
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index (E)</a> &raquo;
    
    
    <span class="title">EventMachine</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Module: EventMachine
  
  
  
</h1>

<dl class="box">
  
  
    
  
    
  
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">lib/em/future.rb<span class="defines">,<br />
  lib/em/pool.rb,<br /> lib/em/queue.rb,<br /> lib/em/timers.rb,<br /> lib/em/channel.rb,<br /> lib/em/version.rb,<br /> lib/em/callback.rb,<br /> lib/em/iterator.rb,<br /> lib/em/streamer.rb,<br /> lib/em/resolver.rb,<br /> lib/em/protocols.rb,<br /> lib/em/processes.rb,<br /> lib/em/tick_loop.rb,<br /> lib/eventmachine.rb,<br /> lib/em/spawnable.rb,<br /> lib/em/connection.rb,<br /> lib/em/file_watch.rb,<br /> lib/em/completion.rb,<br /> lib/em/deferrable.rb,<br /> lib/em/process_watch.rb,<br /> lib/em/protocols/stomp.rb,<br /> lib/em/protocols/socks4.rb,<br /> lib/em/threaded_resource.rb,<br /> lib/em/protocols/tcptest.rb,<br /> lib/em/protocols/saslauth.rb,<br /> lib/em/protocols/memcache.rb,<br /> lib/em/protocols/linetext2.rb,<br /> lib/em/protocols/postgres3.rb,<br /> lib/em/protocols/httpclient.rb,<br /> lib/em/protocols/smtpclient.rb,<br /> lib/em/protocols/smtpserver.rb,<br /> lib/em/protocols/httpclient2.rb,<br /> lib/em/protocols/line_and_text.rb,<br /> lib/em/protocols/line_protocol.rb,<br /> lib/em/protocols/object_protocol.rb,<br /> lib/em/protocols/header_and_content.rb</span>
</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p>–</p>

<p>Author:: Francis Cianfrocca (gmail: blackhedd)
Homepage::  http://rubyeventmachine.com
Date:: 15 Nov 2006</p>

<p>See EventMachine and EventMachine::Connection for documentation and
usage examples.</p>

<hr />

<p>Copyright (C) 2006-07 by Francis Cianfrocca. All Rights Reserved.
Gmail: blackhedd</p>

<p>This program is free software; you can redistribute it and/or modify
it under the terms of either: 1) the GNU General Public License
as published by the Free Software Foundation; either version 2 of the
License, or (at your option) any later version; or 2) Ruby’s License.</p>

<p>See the file COPYING for complete licensing information.</p>

<hr />


  </div>
</div>
<div class="tags">
  

</div><h2>Defined Under Namespace</h2>
<p class="children">
  
    
      <strong class="modules">Modules:</strong> <span class='object_link'><a href="EventMachine/DNS.html" title="EventMachine::DNS (module)">DNS</a></span>, <span class='object_link'><a href="EventMachine/Deferrable.html" title="EventMachine::Deferrable (module)">Deferrable</a></span>, <span class='object_link'><a href="EventMachine/Protocols.html" title="EventMachine::Protocols (module)">Protocols</a></span>
    
  
    
      <strong class="classes">Classes:</strong> <span class='object_link'><a href="EventMachine/Channel.html" title="EventMachine::Channel (class)">Channel</a></span>, <span class='object_link'><a href="EventMachine/Completion.html" title="EventMachine::Completion (class)">Completion</a></span>, <span class='object_link'><a href="EventMachine/Connection.html" title="EventMachine::Connection (class)">Connection</a></span>, <span class='object_link'><a href="EventMachine/DefaultDeferrable.html" title="EventMachine::DefaultDeferrable (class)">DefaultDeferrable</a></span>, <span class='object_link'><a href="EventMachine/DeferrableChildProcess.html" title="EventMachine::DeferrableChildProcess (class)">DeferrableChildProcess</a></span>, <span class='object_link'><a href="EventMachine/FileNotFoundException.html" title="EventMachine::FileNotFoundException (class)">FileNotFoundException</a></span>, <span class='object_link'><a href="EventMachine/FileStreamer.html" title="EventMachine::FileStreamer (class)">FileStreamer</a></span>, <span class='object_link'><a href="EventMachine/FileWatch.html" title="EventMachine::FileWatch (class)">FileWatch</a></span>, <span class='object_link'><a href="EventMachine/Iterator.html" title="EventMachine::Iterator (class)">Iterator</a></span>, <span class='object_link'><a href="EventMachine/PeriodicTimer.html" title="EventMachine::PeriodicTimer (class)">PeriodicTimer</a></span>, <span class='object_link'><a href="EventMachine/Pool.html" title="EventMachine::Pool (class)">Pool</a></span>, <span class='object_link'><a href="EventMachine/ProcessWatch.html" title="EventMachine::ProcessWatch (class)">ProcessWatch</a></span>, <span class='object_link'><a href="EventMachine/Queue.html" title="EventMachine::Queue (class)">Queue</a></span>, <span class='object_link'><a href="EventMachine/SpawnedProcess.html" title="EventMachine::SpawnedProcess (class)">SpawnedProcess</a></span>, <span class='object_link'><a href="EventMachine/ThreadedResource.html" title="EventMachine::ThreadedResource (class)">ThreadedResource</a></span>, <span class='object_link'><a href="EventMachine/TickLoop.html" title="EventMachine::TickLoop (class)">TickLoop</a></span>, <span class='object_link'><a href="EventMachine/Timer.html" title="EventMachine::Timer (class)">Timer</a></span>
    
  
</p>

  <h2>Constant Summary</h2>
  
    <dl class="constants">
      
        <dt id="VERSION-constant" class="">VERSION =
          
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>1.0.3</span><span class='tstring_end'>&quot;</span></span></pre></dd>
      
    </dl>
  




  <h2>Class Attribute Summary <small>(<a href="#" class="summary_toggle">collapse</a>)</small></h2>
  <ul class="summary">
    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#reactor_thread-class_method" title="reactor_thread (class method)">+ (Thread) <strong>reactor_thread</strong> </a>
    

    
  </span>
  
  
  
    
      <span class="note title readonly">readonly</span>
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Exposed to allow joining on the thread, when run in a multithreaded
environment.</p>
</div></span>
  
</li>

    
      <li class="public ">
  <span class="summary_signature">
    
      <a href="#threadpool_size-class_method" title="threadpool_size (class method)">+ (Number) <strong>threadpool_size</strong> </a>
    

    
  </span>
  
  
  
    
    
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Size of the EventMachine.defer threadpool (defaults to 20).</p>
</div></span>
  
</li>

    
  </ul>




  
    <h2>
      Class Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#add_periodic_timer-class_method" title="add_periodic_timer (class method)">+ (Object) <strong>add_periodic_timer</strong>(*args, &amp;block) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Adds a periodic timer to the event loop.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#add_shutdown_hook-class_method" title="add_shutdown_hook (class method)">+ (Object) <strong>add_shutdown_hook</strong>(&amp;block) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Adds a block to call as the reactor is shutting down.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#add_timer-class_method" title="add_timer (class method)">+ (Object) <strong>add_timer</strong>(*args, &amp;block) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Adds a one-shot timer to the event loop.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#attach-class_method" title="attach (class method)">+ (Object) <strong>attach</strong>(io, handler = nil, *args, &amp;blk) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Attaches an IO object or file descriptor to the eventloop as a regular connection.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#bind_connect-class_method" title="bind_connect (class method)">+ (Object) <strong>bind_connect</strong>(bind_addr, bind_port, server, port = nil, handler = nil, *args) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>This method is like <span class='object_link'><a href="#connect-class_method" title="EventMachine.connect (method)">EventMachine.connect</a></span>, but allows for a local address/port
to bind the connection to.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#Callback-class_method" title="Callback (class method)">+ (&lt;#call&gt;) <strong>Callback</strong>(object = nil, method = nil, &amp;blk) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Utility method for coercing arguments to an object that responds to :call.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#cancel_timer-class_method" title="cancel_timer (class method)">+ (Object) <strong>cancel_timer</strong>(timer_or_sig) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Cancel a timer (can be a callback or an <span class='object_link'><a href="EventMachine/Timer.html" title="EventMachine::Timer (class)">Timer</a></span> instance).</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#connect-class_method" title="connect (class method)">+ (Object) <strong>connect</strong>(server, port = nil, handler = nil, *args, &amp;blk) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Initiates a TCP connection to a remote server and sets up event handling for the connection.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#connect_unix_domain-class_method" title="connect_unix_domain (class method)">+ (Object) <strong>connect_unix_domain</strong>(socketname, *args, &amp;blk) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Make a connection to a Unix-domain socket.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#connection_count-class_method" title="connection_count (class method)">+ (Integer) <strong>connection_count</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Returns the total number of connections (file descriptors) currently held by the reactor.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#defer-class_method" title="defer (class method)">+ (Object) <strong>defer</strong>(op = nil, callback = nil, &amp;blk) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>EventMachine.defer is used for integrating blocking operations into EventMachine’s control flow.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#defers_finished%3F-class_method" title="defers_finished? (class method)">+ (Boolean) <strong>defers_finished?</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Returns +true+ if all deferred actions are done executing and their
callbacks have been fired.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#disable_proxy-class_method" title="disable_proxy (class method)">+ (Object) <strong>disable_proxy</strong>(from) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Takes just one argument, a <span class='object_link'><a href="EventMachine/Connection.html" title="EventMachine::Connection (class)">Connection</a></span> that has proxying enabled via <span class='object_link'><a href="#enable_proxy-class_method" title="EventMachine.enable_proxy (method)">EventMachine.enable_proxy</a></span>.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#enable_proxy-class_method" title="enable_proxy (class method)">+ (Object) <strong>enable_proxy</strong>(from, to, bufsize = 0, length = 0) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>This method allows for direct writing of incoming data back out to another descriptor, at the C++ level in the reactor.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#error_handler-class_method" title="error_handler (class method)">+ (Object) <strong>error_handler</strong>(cb = nil, &amp;blk) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Catch-all for errors raised during event loop callbacks.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#fork_reactor-class_method" title="fork_reactor (class method)">+ (Object) <strong>fork_reactor</strong>(&amp;block) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Forks a new process, properly stops the reactor and then calls <span class='object_link'><a href="#run-class_method" title="EventMachine.run (method)">EventMachine.run</a></span> inside of it again, passing your block.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#get_max_timers-class_method" title="get_max_timers (class method)">+ (Integer) <strong>get_max_timers</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Gets the current maximum number of allowed timers.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#heartbeat_interval-class_method" title="heartbeat_interval (class method)">+ (Integer) <strong>heartbeat_interval</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Retrieve the heartbeat interval.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#heartbeat_interval%3D-class_method" title="heartbeat_interval= (class method)">+ (Object) <strong>heartbeat_interval=</strong>(time) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Set the heartbeat interval.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#next_tick-class_method" title="next_tick (class method)">+ (Object) <strong>next_tick</strong>(pr = nil, &amp;block) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Schedules a proc for execution immediately after the next “turn” through the reactor
core.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#open_datagram_socket-class_method" title="open_datagram_socket (class method)">+ (Object) <strong>open_datagram_socket</strong>(address, port, handler = nil, *args) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Used for UDP-based protocols.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#popen-class_method" title="popen (class method)">+ (Object) <strong>popen</strong>(cmd, handler = nil, *args) {|c| ... }</a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Runs an external process.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#reactor_running%3F-class_method" title="reactor_running? (class method)">+ (Boolean) <strong>reactor_running?</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Tells you whether the EventMachine reactor loop is currently running.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#reactor_thread%3F-class_method" title="reactor_thread? (class method)">+ (Boolean) <strong>reactor_thread?</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>True if the calling thread is the same thread as the reactor.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#reconnect-class_method" title="reconnect (class method)">+ (Object) <strong>reconnect</strong>(server, port, handler) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Connect to a given host/port and re-use the provided <span class='object_link'><a href="EventMachine/Connection.html" title="EventMachine::Connection (class)">Connection</a></span> instance.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#run-class_method" title="run (class method)">+ (Object) <strong>run</strong>(blk = nil, tail = nil, &amp;block) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Initializes and runs an event loop.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#run_block-class_method" title="run_block (class method)">+ (Object) <strong>run_block</strong>(&amp;block) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Sugars a common use case.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#schedule-class_method" title="schedule (class method)">+ (Object) <strong>schedule</strong>(*a, &amp;b) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Runs the given callback on the reactor thread, or immediately if called
from the reactor thread.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#set_descriptor_table_size-class_method" title="set_descriptor_table_size (class method)">+ (Integer) <strong>set_descriptor_table_size</strong>(n_descriptors = nil) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Sets the maximum number of file or socket descriptors that your process may open.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#set_effective_user-class_method" title="set_effective_user (class method)">+ (Object) <strong>set_effective_user</strong>(username) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>A wrapper over the setuid system call.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#set_max_timers-class_method" title="set_max_timers (class method)">+ (Object) <strong>set_max_timers</strong>(ct) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Sets the maximum number of timers and periodic timers that may be outstanding at any
given time.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#set_quantum-class_method" title="set_quantum (class method)">+ (Object) <strong>set_quantum</strong>(mills) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>For advanced users.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#spawn-class_method" title="spawn (class method)">+ (Object) <strong>spawn</strong>(&amp;block) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Spawn an erlang-style process.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#start_server-class_method" title="start_server (class method)">+ (Object) <strong>start_server</strong>(server, port = nil, handler = nil, *args, &amp;block) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Initiates a TCP server (socket acceptor) on the specified IP address and port.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#start_unix_domain_server-class_method" title="start_unix_domain_server (class method)">+ (Object) <strong>start_unix_domain_server</strong>(filename, *args, &amp;block) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Start a Unix-domain server.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#stop_event_loop-class_method" title="stop_event_loop (class method)">+ (Object) <strong>stop_event_loop</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Causes the processing loop to stop executing, which will cause all open connections and accepting servers
to be run down and closed.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#stop_server-class_method" title="stop_server (class method)">+ (Object) <strong>stop_server</strong>(signature) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Stop a TCP server socket that was started with <span class='object_link'><a href="#start_server-class_method" title="EventMachine.start_server (method)">EventMachine.start_server</a></span>.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#system-class_method" title="system (class method)">+ (Object) <strong>system</strong>(cmd, *args, &amp;cb) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>EM::system is a simple wrapper for EM::popen.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#tick_loop-class_method" title="tick_loop (class method)">+ (Object) <strong>tick_loop</strong>(*a, &amp;b) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Creates and immediately starts an EventMachine::TickLoop.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#watch-class_method" title="watch (class method)">+ (Object) <strong>watch</strong>(io, handler = nil, *args, &amp;blk) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p><span class='object_link'><a href="#watch-class_method" title="EventMachine.watch (method)">EventMachine.watch</a></span> registers a given file descriptor or IO object with the eventloop.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#watch_file-class_method" title="watch_file (class method)">+ (Object) <strong>watch_file</strong>(filename, handler = nil, *args) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>EventMachine’s file monitoring API.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#watch_process-class_method" title="watch_process (class method)">+ (Object) <strong>watch_process</strong>(pid, handler = nil, *args) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>EventMachine’s process monitoring API.</p>
</div></span>
  
</li>

      
    </ul>
  


  <div id="class_attr_details" class="attr_details">
    <h2>Class Attribute Details</h2>
    
      
      <span id=""></span>
      <div class="method_details first">
  <h3 class="signature first" id="reactor_thread-class_method">
  
    + (<tt>Thread</tt>) <strong>reactor_thread</strong>  <span class="extras">(readonly)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Exposed to allow joining on the thread, when run in a multithreaded
environment. Performing other actions on the thread has undefined
semantics (read: a dangerous endevor).</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Thread</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


79
80
81</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 79</span>

<span class='kw'>def</span> <span class='id identifier rubyid_reactor_thread'>reactor_thread</span>
  <span class='ivar'>@reactor_thread</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="threadpool_size=-class_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="threadpool_size-class_method">
  
    + (<tt>Number</tt>) <strong>threadpool_size</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Size of the EventMachine.defer threadpool (defaults to 20)</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Number</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1065
1066
1067</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 1065</span>

<span class='kw'>def</span> <span class='id identifier rubyid_threadpool_size'>threadpool_size</span>
  <span class='ivar'>@threadpool_size</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="add_periodic_timer-class_method">
  
    + (<tt>Object</tt>) <strong>add_periodic_timer</strong>(*args, &amp;block) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Adds a periodic timer to the event loop.
It takes the same parameters as the one-shot timer method, <span class='object_link'><a href="#add_timer-class_method" title="EventMachine.add_timer (method)">add_timer</a></span>.
This method schedules execution of the given block repeatedly, at intervals
of time <em>at least</em> as great as the number of seconds given in the first
parameter to the call.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
        <p class="example_title"><div class='inline'><p>Write a dollar-sign to stderr every five seconds, without blocking</p>
</div></p>
      
      <pre class="example code"><code>
<span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_run'>run</span> <span class='lbrace'>{</span>
  <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_add_periodic_timer'>add_periodic_timer</span><span class='lparen'>(</span> <span class='int'>5</span> <span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='gvar'>$stderr</span><span class='period'>.</span><span class='id identifier rubyid_write'>write</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>$</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
<span class='rbrace'>}</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>delay</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Delay in seconds</p>
</div>
      
    </li>
  
</ul>


  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><span class='object_link'><a href="EventMachine/PeriodicTimer.html" title="EventMachine::PeriodicTimer (class)">PeriodicTimer</a></span></li>
    
      <li><span class='object_link'><a href="#add_timer-class_method" title="EventMachine.add_timer (method)">add_timer</a></span></li>
    
  </ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


346
347
348
349
350
351</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 346</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_add_periodic_timer'>add_periodic_timer</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>
  <span class='id identifier rubyid_interval'>interval</span> <span class='op'>=</span> <span class='id identifier rubyid_args'>args</span><span class='period'>.</span><span class='id identifier rubyid_shift'>shift</span>
  <span class='id identifier rubyid_code'>code</span> <span class='op'>=</span> <span class='id identifier rubyid_args'>args</span><span class='period'>.</span><span class='id identifier rubyid_shift'>shift</span> <span class='op'>||</span> <span class='id identifier rubyid_block'>block</span>

  <span class='const'>EventMachine</span><span class='op'>::</span><span class='const'>PeriodicTimer</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_interval'>interval</span><span class='comma'>,</span> <span class='id identifier rubyid_code'>code</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="add_shutdown_hook-class_method">
  
    + (<tt>Object</tt>) <strong>add_shutdown_hook</strong>(&amp;block) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Adds a block to call as the reactor is shutting down.</p>

<p>These callbacks are called in the <em>reverse</em> order to which they are added.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
        <p class="example_title"><div class='inline'><p>Scheduling operations to be run when EventMachine event loop is stopped</p>
</div></p>
      
      <pre class="example code"><code>
<span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_run'>run</span> <span class='kw'>do</span>
  <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_add_shutdown_hook'>add_shutdown_hook</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>b</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
  <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_add_shutdown_hook'>add_shutdown_hook</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>a</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
  <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_stop'>stop</span>
<span class='kw'>end</span>

<span class='comment'># Outputs:
</span><span class='comment'>#   a
</span><span class='comment'>#   b</span></code></pre>
    
  </div>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


286
287
288</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 286</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_add_shutdown_hook'>add_shutdown_hook</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>
  <span class='ivar'>@tails</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_block'>block</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="add_timer-class_method">
  
    + (<tt>Object</tt>) <strong>add_timer</strong>(*args, &amp;block) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Adds a one-shot timer to the event loop.
Call it with one or two parameters. The first parameters is a delay-time
expressed in <em>seconds</em> (not milliseconds). The second parameter, if
present, must be an object that responds to :call. If 2nd parameter is not given, then you
can also simply pass a block to the method call.</p>

<p>This method may be called from the block passed to <span class='object_link'><a href="#run-class_method" title="EventMachine.run (method)">run</a></span>
or from any callback method. It schedules execution of the proc or block
passed to it, after the passage of an interval of time equal to
<em>at least</em> the number of seconds specified in the first parameter to
the call.</p>

<p><span class='object_link'><a href="#add_timer-class_method" title="EventMachine.add_timer (method)">add_timer</a></span> is a non-blocking method. Callbacks can and will
be called during the interval of time that the timer is in effect.
There is no built-in limit to the number of timers that can be outstanding at
any given time.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
        <p class="example_title"><div class='inline'><p>Setting a one-shot timer with EventMachine</p>
</div></p>
      
      <pre class="example code"><code>
<span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_run'>run</span> <span class='lbrace'>{</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Starting the run now: </span><span class='embexpr_beg'>#{</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_add_timer'>add_timer</span> <span class='int'>5</span><span class='comma'>,</span> <span class='id identifier rubyid_proc'>proc</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Executing timer event: </span><span class='embexpr_beg'>#{</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
  <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_add_timer'>add_timer</span><span class='lparen'>(</span><span class='int'>10</span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Executing timer event: </span><span class='embexpr_beg'>#{</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
<span class='rbrace'>}</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>delay</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Delay in seconds</p>
</div>
      
    </li>
  
</ul>


  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><span class='object_link'><a href="EventMachine/Timer.html" title="EventMachine::Timer (class)">Timer</a></span></li>
    
      <li><span class='object_link'><a href="#add_periodic_timer-class_method" title="EventMachine.add_periodic_timer (method)">add_periodic_timer</a></span></li>
    
  </ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


318
319
320
321
322
323
324
325
326
327</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 318</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_add_timer'>add_timer</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>
  <span class='id identifier rubyid_interval'>interval</span> <span class='op'>=</span> <span class='id identifier rubyid_args'>args</span><span class='period'>.</span><span class='id identifier rubyid_shift'>shift</span>
  <span class='id identifier rubyid_code'>code</span> <span class='op'>=</span> <span class='id identifier rubyid_args'>args</span><span class='period'>.</span><span class='id identifier rubyid_shift'>shift</span> <span class='op'>||</span> <span class='id identifier rubyid_block'>block</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_code'>code</span>
    <span class='comment'># check too many timers!
</span>    <span class='id identifier rubyid_s'>s</span> <span class='op'>=</span> <span class='id identifier rubyid_add_oneshot_timer'>add_oneshot_timer</span><span class='lparen'>(</span><span class='lparen'>(</span><span class='id identifier rubyid_interval'>interval</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span> <span class='op'>*</span> <span class='int'>1000</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='rparen'>)</span>
    <span class='ivar'>@timers</span><span class='lbracket'>[</span><span class='id identifier rubyid_s'>s</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_code'>code</span>
    <span class='id identifier rubyid_s'>s</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="attach-class_method">
  
    + (<tt>Object</tt>) <strong>attach</strong>(io, handler = nil, *args, &amp;blk) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Attaches an IO object or file descriptor to the eventloop as a regular connection.
The file descriptor will be set as non-blocking, and EventMachine will process
receive_data and send_data events on it as it would for any other connection.</p>

<p>To watch a fd instead, use <span class='object_link'><a href="#watch-class_method" title="EventMachine.watch (method)">watch</a></span>, which will not alter the state of the socket
and fire notify_readable and notify_writable events instead.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


727
728
729</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 727</span>

<span class='kw'>def</span> <span class='const'>EventMachine</span><span class='op'>::</span><span class='id identifier rubyid_attach'>attach</span> <span class='id identifier rubyid_io'>io</span><span class='comma'>,</span> <span class='id identifier rubyid_handler'>handler</span><span class='op'>=</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_blk'>blk</span>
  <span class='id identifier rubyid_attach_io'>attach_io</span> <span class='id identifier rubyid_io'>io</span><span class='comma'>,</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='id identifier rubyid_handler'>handler</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_blk'>blk</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="bind_connect-class_method">
  
    + (<tt>Object</tt>) <strong>bind_connect</strong>(bind_addr, bind_port, server, port = nil, handler = nil, *args) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>This method is like <span class='object_link'><a href="#connect-class_method" title="EventMachine.connect (method)">connect</a></span>, but allows for a local address/port
to bind the connection to.</p>


  </div>
</div>
<div class="tags">
  

  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><span class='object_link'><a href="#connect-class_method" title="EventMachine.connect (method)">connect</a></span></li>
    
  </ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


647
648
649
650
651
652
653
654
655
656
657
658
659
660
661
662
663
664
665
666
667
668
669
670
671
672
673
674</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 647</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_bind_connect'>bind_connect</span> <span class='id identifier rubyid_bind_addr'>bind_addr</span><span class='comma'>,</span> <span class='id identifier rubyid_bind_port'>bind_port</span><span class='comma'>,</span> <span class='id identifier rubyid_server'>server</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span><span class='op'>=</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_handler'>handler</span><span class='op'>=</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span>
  <span class='kw'>begin</span>
    <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='const'>Integer</span><span class='lparen'>(</span><span class='id identifier rubyid_port'>port</span><span class='rparen'>)</span>
  <span class='kw'>rescue</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='const'>TypeError</span>
    <span class='comment'># there was no port, so server must be a unix domain socket
</span>    <span class='comment'># the port argument is actually the handler, and the handler is one of the args
</span>    <span class='id identifier rubyid_args'>args</span><span class='period'>.</span><span class='id identifier rubyid_unshift'>unshift</span> <span class='id identifier rubyid_handler'>handler</span> <span class='kw'>if</span> <span class='id identifier rubyid_handler'>handler</span>
    <span class='id identifier rubyid_handler'>handler</span> <span class='op'>=</span> <span class='id identifier rubyid_port'>port</span>
    <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='kw'>end</span> <span class='kw'>if</span> <span class='id identifier rubyid_port'>port</span>

  <span class='id identifier rubyid_klass'>klass</span> <span class='op'>=</span> <span class='id identifier rubyid_klass_from_handler'>klass_from_handler</span><span class='lparen'>(</span><span class='const'>Connection</span><span class='comma'>,</span> <span class='id identifier rubyid_handler'>handler</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_s'>s</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_port'>port</span>
        <span class='kw'>if</span> <span class='id identifier rubyid_bind_addr'>bind_addr</span>
          <span class='id identifier rubyid_bind_connect_server'>bind_connect_server</span> <span class='id identifier rubyid_bind_addr'>bind_addr</span><span class='comma'>,</span> <span class='id identifier rubyid_bind_port'>bind_port</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='id identifier rubyid_server'>server</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span>
        <span class='kw'>else</span>
          <span class='id identifier rubyid_connect_server'>connect_server</span> <span class='id identifier rubyid_server'>server</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span>
        <span class='kw'>end</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_connect_unix_server'>connect_unix_server</span> <span class='id identifier rubyid_server'>server</span>
      <span class='kw'>end</span>

  <span class='id identifier rubyid_c'>c</span> <span class='op'>=</span> <span class='id identifier rubyid_klass'>klass</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_s'>s</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span>
  <span class='ivar'>@conns</span><span class='lbracket'>[</span><span class='id identifier rubyid_s'>s</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_c'>c</span>
  <span class='id identifier rubyid_block_given?'>block_given?</span> <span class='kw'>and</span> <span class='kw'>yield</span> <span class='id identifier rubyid_c'>c</span>
  <span class='id identifier rubyid_c'>c</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="Callback-class_method">
  
    
      <span class="overload">+ (<tt>&lt;#call&gt;</tt>) <strong>Callback</strong>(object, method) </span>
    
      <span class="overload">+ (<tt>&lt;#call&gt;</tt>) <strong>Callback</strong>(object) </span>
    
      <span class="overload">+ (<tt>&lt;#call&gt;</tt>) <strong>Callback</strong>(&amp;block) </span>
    
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Utility method for coercing arguments to an object that responds to :call.
Accepts an object and a method name to send to, or a block, or an object
that responds to :call.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
        <p class="example_title"><div class='inline'><p>EventMachine.Callback used with a block. Returns that block.</p>
</div></p>
      
      <pre class="example code"><code>
<span class='id identifier rubyid_cb'>cb</span> <span class='op'>=</span> <span class='const'>EventMachine</span><span class='period'>.</span><span class='const'>Callback</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_msg'>msg</span><span class='op'>|</span>
  <span class='id identifier rubyid_puts'>puts</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='rparen'>)</span>
<span class='kw'>end</span>
<span class='comment'># returned object is a callable
</span><span class='id identifier rubyid_cb'>cb</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>hello world</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span></code></pre>
    
      
        <p class="example_title"><div class='inline'><p>EventMachine.Callback used with an object (to be more specific, class object) and a method name, returns an object that responds to #call</p>
</div></p>
      
      <pre class="example code"><code>
<span class='id identifier rubyid_cb'>cb</span> <span class='op'>=</span> <span class='const'>EventMachine</span><span class='period'>.</span><span class='const'>Callback</span><span class='lparen'>(</span><span class='const'>Object</span><span class='comma'>,</span> <span class='symbol'>:puts</span><span class='rparen'>)</span>
<span class='comment'># returned object is a callable that delegates to Kernel#puts (in this case Object.puts)
</span><span class='id identifier rubyid_cb'>cb</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>hello world</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span></code></pre>
    
      
        <p class="example_title"><div class='inline'><p>EventMachine.Callback used with an object that responds to #call. Returns the argument.</p>
</div></p>
      
      <pre class="example code"><code>
<span class='id identifier rubyid_cb'>cb</span> <span class='op'>=</span> <span class='const'>EventMachine</span><span class='period'>.</span><span class='const'>Callback</span><span class='lparen'>(</span><span class='id identifier rubyid_proc'>proc</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_msg'>msg</span><span class='op'>|</span> <span class='id identifier rubyid_puts'>puts</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='rparen'>)</span> <span class='rbrace'>}</span><span class='rparen'>)</span>
<span class='comment'># returned object is a callable
</span><span class='id identifier rubyid_cb'>cb</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>hello world</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span></code></pre>
    
  </div>

  <p class="tag_title">Overloads:</p>
  <ul class="overload">
    
      
      <li class="overload_item">
        <span class="signature">+ (<tt>&lt;#call&gt;</tt>) <strong>Callback</strong>(object, method) </span>
        <div class="docstring">
  <div class="discussion">
    <p>Wraps <code>method</code> invocation on <code>object</code> into an object that responds to #call that proxies all the arguments to that method</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>Object</span>
      
      
        <span class='type'>(<tt>Object</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>to invoke method on</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>Method</span>
      
      
        <span class='type'>(<tt>Symbol</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>name</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>&lt;#call&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>An object that responds to #call that takes any number of arguments and invokes method on object with those arguments</p>
</div>
      
    </li>
  
</ul>

</div>
      </li>
    
      
      <li class="overload_item">
        <span class="signature">+ (<tt>&lt;#call&gt;</tt>) <strong>Callback</strong>(object) </span>
        <div class="docstring">
  <div class="discussion">
    <p>Returns callable object as is, without any coercion</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>An</span>
      
      
        <span class='type'>(<tt>&lt;#call&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>object that responds to #call</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>&lt;#call&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Its argument</p>
</div>
      
    </li>
  
</ul>

</div>
      </li>
    
      
      <li class="overload_item">
        <span class="signature">+ (<tt>&lt;#call&gt;</tt>) <strong>Callback</strong>(&amp;block) </span>
        <div class="docstring">
  <div class="discussion">
    <p>Returns block passed to it without any coercion</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>&lt;#call&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Block passed to this method</p>
</div>
      
    </li>
  
</ul>

</div>
      </li>
    
  </ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>&lt;#call&gt;</tt>)</span>
      
      
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt>ArgumentError</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>When argument doesn&#8217;t respond to #call, method name is missing or when invoked without arguments and block isn&#8217;t given</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


47
48
49
50
51
52
53
54
55
56
57</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/callback.rb', line 47</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='const'>Callback</span><span class='lparen'>(</span><span class='id identifier rubyid_object'>object</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_method'>method</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_blk'>blk</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_object'>object</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_method'>method</span>
    <span class='id identifier rubyid_lambda'>lambda</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='op'>|</span> <span class='id identifier rubyid_object'>object</span><span class='period'>.</span><span class='id identifier rubyid___send__'>__send__</span> <span class='id identifier rubyid_method'>method</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span> <span class='rbrace'>}</span>
  <span class='kw'>else</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_object'>object</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span> <span class='symbol'>:call</span>
      <span class='id identifier rubyid_object'>object</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_blk'>blk</span> <span class='op'>||</span> <span class='id identifier rubyid_raise'>raise</span><span class='lparen'>(</span><span class='const'>ArgumentError</span><span class='rparen'>)</span>
    <span class='kw'>end</span> <span class='comment'># if
</span>  <span class='kw'>end</span> <span class='comment'># if
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="cancel_timer-class_method">
  
    + (<tt>Object</tt>) <strong>cancel_timer</strong>(timer_or_sig) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Cancel a timer (can be a callback or an <span class='object_link'><a href="EventMachine/Timer.html" title="EventMachine::Timer (class)">Timer</a></span> instance).</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>timer_or_sig</span>
      
      
        <span class='type'>(<tt>#cancel</tt>, <tt>#call</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>A timer to cancel</p>
</div>
      
    </li>
  
</ul>


  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><span class='object_link'><a href="EventMachine/Timer.html#cancel-instance_method" title="EventMachine::Timer#cancel (method)">EventMachine::Timer#cancel</a></span></li>
    
  </ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


358
359
360
361
362
363
364</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 358</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_cancel_timer'>cancel_timer</span> <span class='id identifier rubyid_timer_or_sig'>timer_or_sig</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_timer_or_sig'>timer_or_sig</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span> <span class='symbol'>:cancel</span>
    <span class='id identifier rubyid_timer_or_sig'>timer_or_sig</span><span class='period'>.</span><span class='id identifier rubyid_cancel'>cancel</span>
  <span class='kw'>else</span>
    <span class='ivar'>@timers</span><span class='lbracket'>[</span><span class='id identifier rubyid_timer_or_sig'>timer_or_sig</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='kw'>false</span> <span class='kw'>if</span> <span class='ivar'>@timers</span><span class='period'>.</span><span class='id identifier rubyid_has_key?'>has_key?</span><span class='lparen'>(</span><span class='id identifier rubyid_timer_or_sig'>timer_or_sig</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="connect-class_method">
  
    + (<tt>Object</tt>) <strong>connect</strong>(server, port = nil, handler = nil, *args, &amp;blk) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Initiates a TCP connection to a remote server and sets up event handling for the connection.
<span class='object_link'><a href="#connect-class_method" title="EventMachine.connect (method)">connect</a></span> requires event loop to be running (see <span class='object_link'><a href="#run-class_method" title="EventMachine.run (method)">run</a></span>).</p>

<p><span class='object_link'><a href="#connect-class_method" title="EventMachine.connect (method)">connect</a></span> takes the IP address (or hostname) and
port of the remote server you want to connect to.
It also takes an optional handler (a module or a subclass of <span class='object_link'><a href="EventMachine/Connection.html" title="EventMachine::Connection (class)">Connection</a></span>) which you must define, that
contains the callbacks that will be invoked by the event loop on behalf of the connection.</p>

<p>Learn more about connection lifecycle callbacks in the <a href="file.GettingStarted.html" title="EventMachine tutorial">EventMachine tutorial</a> and
<a href="file.ConnectionLifecycleCallbacks.html" title="Connection lifecycle guide">Connection lifecycle guide</a>.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
      <pre class="example code"><code>
<span class='comment'># Here&#39;s a program which connects to a web server, sends a naive
</span><span class='comment'># request, parses the HTTP header of the response, and then
</span><span class='comment'># (antisocially) ends the event loop, which automatically drops the connection
</span><span class='comment'># (and incidentally calls the connection&#39;s unbind method).
</span><span class='kw'>module</span> <span class='const'>DumbHttpClient</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_post_init'>post_init</span>
    <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>GET / HTTP/1.1\r\nHost: _\r\n\r\n</span><span class='tstring_end'>&quot;</span></span>
    <span class='ivar'>@data</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>
    <span class='ivar'>@parsed</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_receive_data'>receive_data</span> <span class='id identifier rubyid_data'>data</span>
    <span class='ivar'>@data</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_data'>data</span>
    <span class='kw'>if</span> <span class='op'>!</span><span class='ivar'>@parsed</span> <span class='kw'>and</span> <span class='ivar'>@data</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>[\n][\r]*[\n]</span><span class='regexp_end'>/m</span></span>
      <span class='ivar'>@parsed</span> <span class='op'>=</span> <span class='kw'>true</span>
      <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>RECEIVED HTTP HEADER:</span><span class='tstring_end'>&quot;</span></span>
      <span class='backref'>$`</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_line'>line</span><span class='op'>|</span> <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>&gt;&gt;&gt; </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_line'>line</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>

      <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Now we&#39;ll terminate the loop, which will also close the connection</span><span class='tstring_end'>&quot;</span></span>
      <span class='const'>EventMachine</span><span class='op'>::</span><span class='id identifier rubyid_stop_event_loop'>stop_event_loop</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_unbind'>unbind</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>A connection has terminated</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_run'>run</span> <span class='lbrace'>{</span>
  <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_connect'>connect</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.bayshorenetworks.com</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>80</span><span class='comma'>,</span> <span class='const'>DumbHttpClient</span>
<span class='rbrace'>}</span>
<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The event loop has ended</span><span class='tstring_end'>&quot;</span></span></code></pre>
    
      
        <p class="example_title"><div class='inline'><p>Defining protocol handler as a class</p>
</div></p>
      
      <pre class="example code"><code>
<span class='kw'>class</span> <span class='const'>MyProtocolHandler</span> <span class='op'>&lt;</span> <span class='const'>EventMachine</span><span class='op'>::</span><span class='const'>Connection</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span>
    <span class='kw'>super</span>
    <span class='comment'># whatever else you want to do here
</span>  <span class='kw'>end</span>

  <span class='comment'># ...
</span><span class='kw'>end</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>server</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Host to connect to</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>port</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Port to connect to</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>handler</span>
      
      
        <span class='type'>(<tt>Module</tt>, <tt>Class</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>A module or class that implements connection lifecycle callbacks</p>
</div>
      
    </li>
  
</ul>


  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><span class='object_link'><a href="#start_server-class_method" title="EventMachine.start_server (method)">start_server</a></span></li>
    
      <li><a href="file.GettingStarted.html" title="EventMachine tutorial">EventMachine tutorial</a></li>
    
  </ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


617
618
619
620
621
622
623
624
625
626
627
628
629
630
631
632
633
634
635
636
637
638
639
640
641</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 617</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_connect'>connect</span> <span class='id identifier rubyid_server'>server</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span><span class='op'>=</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_handler'>handler</span><span class='op'>=</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_blk'>blk</span>
  <span class='comment'># EventMachine::connect initiates a TCP connection to a remote
</span>  <span class='comment'># server and sets up event-handling for the connection.
</span>  <span class='comment'># It internally creates an object that should not be handled
</span>  <span class='comment'># by the caller. HOWEVER, it&#39;s often convenient to get the
</span>  <span class='comment'># object to set up interfacing to other objects in the system.
</span>  <span class='comment'># We return the newly-created anonymous-class object to the caller.
</span>  <span class='comment'># It&#39;s expected that a considerable amount of code will depend
</span>  <span class='comment'># on this behavior, so don&#39;t change it.
</span>  <span class='comment'>#
</span>  <span class='comment'># Ok, added support for a user-defined block, 13Apr06.
</span>  <span class='comment'># This leads us to an interesting choice because of the
</span>  <span class='comment'># presence of the post_init call, which happens in the
</span>  <span class='comment'># initialize method of the new object. We call the user&#39;s
</span>  <span class='comment'># block and pass the new object to it. This is a great
</span>  <span class='comment'># way to do protocol-specific initiation. It happens
</span>  <span class='comment'># AFTER post_init has been called on the object, which I
</span>  <span class='comment'># certainly hope is the right choice.
</span>  <span class='comment'># Don&#39;t change this lightly, because accepted connections
</span>  <span class='comment'># are different from connected ones and we don&#39;t want
</span>  <span class='comment'># to have them behave differently with respect to post_init
</span>  <span class='comment'># if at all possible.
</span>
  <span class='id identifier rubyid_bind_connect'>bind_connect</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_server'>server</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span><span class='comma'>,</span> <span class='id identifier rubyid_handler'>handler</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_blk'>blk</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="connect_unix_domain-class_method">
  
    + (<tt>Object</tt>) <strong>connect_unix_domain</strong>(socketname, *args, &amp;blk) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'><p>UNIX sockets, as the name suggests, are not available on Microsoft Windows.</p>
</div>
  </div>

<p>Make a connection to a Unix-domain socket. This method is simply an alias for <span class='object_link'><a href="#connect-class_method" title="EventMachine.connect (method)">connect</a></span>,
which can connect to both TCP and Unix-domain sockets. Make sure that your process has sufficient
permissions to open the socket it is given.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>socketname</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Unix domain socket (local fully-qualified path) you want to connect to.</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


794
795
796</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 794</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_connect_unix_domain'>connect_unix_domain</span> <span class='id identifier rubyid_socketname'>socketname</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_blk'>blk</span>
  <span class='id identifier rubyid_connect'>connect</span> <span class='id identifier rubyid_socketname'>socketname</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_blk'>blk</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="connection_count-class_method">
  
    + (<tt>Integer</tt>) <strong>connection_count</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Returns the total number of connections (file descriptors) currently held by the reactor.
Note that a tick must pass after the ‘initiation’ of a connection for this number to increment.
It’s usually accurate, but don’t rely on the exact precision of this number unless you really know EM internals.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
      <pre class="example code"><code>
<span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_run'>run</span> <span class='lbrace'>{</span>
  <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_connect'>connect</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>rubyeventmachine.com</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>80</span><span class='rparen'>)</span>
  <span class='comment'># count will be 0 in this case, because connection is not
</span>  <span class='comment'># established yet
</span>  <span class='id identifier rubyid_count'>count</span> <span class='op'>=</span> <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_connection_count'>connection_count</span>
<span class='rbrace'>}</span></code></pre>
    
      
      <pre class="example code"><code>
<span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_run'>run</span> <span class='lbrace'>{</span>
  <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_connect'>connect</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>rubyeventmachine.com</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>80</span><span class='rparen'>)</span>

  <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_next_tick'>next_tick</span> <span class='lbrace'>{</span>
    <span class='comment'># In this example, count will be 1 since the connection has been established in
</span>    <span class='comment'># the next loop of the reactor.
</span>    <span class='id identifier rubyid_count'>count</span> <span class='op'>=</span> <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_connection_count'>connection_count</span>
  <span class='rbrace'>}</span>
<span class='rbrace'>}</span></code></pre>
    
  </div>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Number of connections currently held by the reactor.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


936
937
938</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 936</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_connection_count'>connection_count</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_get_connection_count'>get_connection_count</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="defer-class_method">
  
    + (<tt>Object</tt>) <strong>defer</strong>(op = nil, callback = nil, &amp;blk) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>EventMachine.defer is used for integrating blocking operations into EventMachine’s control flow.
The action of <span class='object_link'><a href="#defer-class_method" title="EventMachine.defer (method)">defer</a></span> is to take the block specified in the first parameter (the “operation”)
and schedule it for asynchronous execution on an internal thread pool maintained by EventMachine.
When the operation completes, it will pass the result computed by the block (if any)
back to the EventMachine reactor. Then, EventMachine calls the block specified in the
second parameter to <span class='object_link'><a href="#defer-class_method" title="EventMachine.defer (method)">defer</a></span> (the “callback”), as part of its normal event handling loop.
The result computed by the operation block is passed as a parameter to the callback.
You may omit the callback parameter if you don’t need to execute any code after the operation completes.</p>

<h2 id="caveats">Caveats</h2>

<p>Note carefully that the code in your deferred operation will be executed on a separate
thread from the main EventMachine processing and all other Ruby threads that may exist in
your program. Also, multiple deferred operations may be running at once! Therefore, you
are responsible for ensuring that your operation code is threadsafe.</p>

<p>Don’t write a deferred operation that will block forever. If so, the current implementation will
not detect the problem, and the thread will never be returned to the pool. EventMachine limits
the number of threads in its pool, so if you do this enough times, your subsequent deferred
operations won’t get a chance to run.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
      <pre class="example code"><code>
<span class='id identifier rubyid_operation'>operation</span> <span class='op'>=</span> <span class='id identifier rubyid_proc'>proc</span> <span class='lbrace'>{</span>
  <span class='comment'># perform a long-running operation here, such as a database query.
</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>result</span><span class='tstring_end'>&quot;</span></span> <span class='comment'># as usual, the last expression evaluated in the block will be the return value.
</span><span class='rbrace'>}</span>
<span class='id identifier rubyid_callback'>callback</span> <span class='op'>=</span> <span class='id identifier rubyid_proc'>proc</span> <span class='lbrace'>{</span><span class='op'>|</span><span class='id identifier rubyid_result'>result</span><span class='op'>|</span>
  <span class='comment'># do something with result here, such as send it back to a network client.
</span><span class='rbrace'>}</span>

<span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_defer'>defer</span><span class='lparen'>(</span><span class='id identifier rubyid_operation'>operation</span><span class='comma'>,</span> <span class='id identifier rubyid_callback'>callback</span><span class='rparen'>)</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>op</span>
      
      
        <span class='type'>(<tt>#call</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>An operation you want to offload to EventMachine thread pool</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>callback</span>
      
      
        <span class='type'>(<tt>#call</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>A callback that will be run on the event loop thread after <code>operation</code> finishes.</p>
</div>
      
    </li>
  
</ul>


  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><span class='object_link'><a href="#threadpool_size-class_method" title="EventMachine.threadpool_size (method)">threadpool_size</a></span></li>
    
  </ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1009
1010
1011
1012
1013
1014
1015
1016
1017
1018
1019
1020
1021
1022
1023
1024
1025
1026
1027</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 1009</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_defer'>defer</span> <span class='id identifier rubyid_op'>op</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_callback'>callback</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_blk'>blk</span>
  <span class='comment'># OBSERVE that #next_tick hacks into this mechanism, so don&#39;t make any changes here
</span>  <span class='comment'># without syncing there.
</span>  <span class='comment'>#
</span>  <span class='comment'># Running with $VERBOSE set to true gives a warning unless all ivars are defined when
</span>  <span class='comment'># they appear in rvalues. But we DON&#39;T ever want to initialize @threadqueue unless we
</span>  <span class='comment'># need it, because the Ruby threads are so heavyweight. We end up with this bizarre
</span>  <span class='comment'># way of initializing @threadqueue because EventMachine is a Module, not a Class, and
</span>  <span class='comment'># has no constructor.
</span>
  <span class='kw'>unless</span> <span class='ivar'>@threadpool</span>
    <span class='ivar'>@threadpool</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
    <span class='ivar'>@threadqueue</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'>Queue</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
    <span class='ivar'>@resultqueue</span> <span class='op'>=</span> <span class='op'>::</span><span class='const'>Queue</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
    <span class='id identifier rubyid_spawn_threadpool'>spawn_threadpool</span>
  <span class='kw'>end</span>

  <span class='ivar'>@threadqueue</span> <span class='op'>&lt;&lt;</span> <span class='lbracket'>[</span><span class='id identifier rubyid_op'>op</span><span class='op'>||</span><span class='id identifier rubyid_blk'>blk</span><span class='comma'>,</span><span class='id identifier rubyid_callback'>callback</span><span class='rbracket'>]</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="defers_finished?-class_method">
  
    + (<tt>Boolean</tt>) <strong>defers_finished?</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Returns +true+ if all deferred actions are done executing and their
callbacks have been fired.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1051
1052
1053
1054
1055
1056
1057</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 1051</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_defers_finished?'>defers_finished?</span>
  <span class='kw'>return</span> <span class='kw'>false</span> <span class='kw'>if</span> <span class='ivar'>@threadpool</span> <span class='kw'>and</span> <span class='op'>!</span><span class='ivar'>@all_threads_spawned</span>
  <span class='kw'>return</span> <span class='kw'>false</span> <span class='kw'>if</span> <span class='ivar'>@threadqueue</span> <span class='kw'>and</span> <span class='kw'>not</span> <span class='ivar'>@threadqueue</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
  <span class='kw'>return</span> <span class='kw'>false</span> <span class='kw'>if</span> <span class='ivar'>@resultqueue</span> <span class='kw'>and</span> <span class='kw'>not</span> <span class='ivar'>@resultqueue</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
  <span class='kw'>return</span> <span class='kw'>false</span> <span class='kw'>if</span> <span class='ivar'>@threadpool</span> <span class='kw'>and</span> <span class='ivar'>@threadqueue</span><span class='period'>.</span><span class='id identifier rubyid_num_waiting'>num_waiting</span> <span class='op'>!=</span> <span class='ivar'>@threadpool</span><span class='period'>.</span><span class='id identifier rubyid_size'>size</span>
  <span class='kw'>return</span> <span class='kw'>true</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="disable_proxy-class_method">
  
    + (<tt>Object</tt>) <strong>disable_proxy</strong>(from) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Takes just one argument, a <span class='object_link'><a href="EventMachine/Connection.html" title="EventMachine::Connection (class)">Connection</a></span> that has proxying enabled via <span class='object_link'><a href="#enable_proxy-class_method" title="EventMachine.enable_proxy (method)">enable_proxy</a></span>.
Calling this method will remove that functionality and your connection will begin receiving
data via <span class='object_link'><a href="EventMachine/Connection.html#receive_data-instance_method" title="EventMachine::Connection#receive_data (method)">EventMachine::Connection#receive_data</a></span> again.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>from</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="EventMachine/Connection.html" title="EventMachine::Connection (class)">EventMachine::Connection</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Source of data that is being proxied</p>
</div>
      
    </li>
  
</ul>


  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><span class='object_link'><a href="#enable_proxy-class_method" title="EventMachine.enable_proxy (method)">enable_proxy</a></span></li>
    
  </ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1396
1397
1398</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 1396</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_disable_proxy'>disable_proxy</span><span class='lparen'>(</span><span class='id identifier rubyid_from'>from</span><span class='rparen'>)</span>
  <span class='const'>EM</span><span class='op'>::</span><span class='id identifier rubyid_stop_proxy'>stop_proxy</span><span class='lparen'>(</span><span class='id identifier rubyid_from'>from</span><span class='period'>.</span><span class='id identifier rubyid_signature'>signature</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="enable_proxy-class_method">
  
    + (<tt>Object</tt>) <strong>enable_proxy</strong>(from, to, bufsize = 0, length = 0) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>This method allows for direct writing of incoming data back out to another descriptor, at the C++ level in the reactor.
This is very efficient and especially useful for proxies where high performance is required. Propogating data from a server response
all the way up to Ruby, and then back down to the reactor to be sent back to the client, is often unnecessary and
incurs a significant performance decrease.</p>

<p>The two arguments are instance of <span class='object_link'><a href="EventMachine/Connection.html" title="EventMachine::Connection (class)">Connection</a></span> subclasses, ‘from’ and ‘to’. ‘from’ is the connection whose inbound data you want
relayed back out. ‘to’ is the connection to write it to.</p>

<p>Once you call this method, the ‘from’ connection will no longer get receive_data callbacks from the reactor,
except in the case that ‘to’ connection has already closed when attempting to write to it. You can see
in the example, that proxy_target_unbound will be called when this occurs. After that, further incoming
data will be passed into receive_data as normal.</p>

<p>Note also that this feature supports different types of descriptors: TCP, UDP, and pipes. You can relay
data from one kind to another, for example, feed a pipe from a UDP stream.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
      <pre class="example code"><code>
<span class='kw'>module</span> <span class='const'>ProxyConnection</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_client'>client</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span><span class='rparen'>)</span>
    <span class='ivar'>@client</span><span class='comma'>,</span> <span class='ivar'>@request</span> <span class='op'>=</span> <span class='id identifier rubyid_client'>client</span><span class='comma'>,</span> <span class='id identifier rubyid_request'>request</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_post_init'>post_init</span>
    <span class='const'>EM</span><span class='op'>::</span><span class='id identifier rubyid_enable_proxy'>enable_proxy</span><span class='lparen'>(</span><span class='kw'>self</span><span class='comma'>,</span> <span class='ivar'>@client</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_connection_completed'>connection_completed</span>
    <span class='id identifier rubyid_send_data'>send_data</span> <span class='ivar'>@request</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_proxy_target_unbound'>proxy_target_unbound</span>
    <span class='id identifier rubyid_close_connection'>close_connection</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_unbind'>unbind</span>
    <span class='ivar'>@client</span><span class='period'>.</span><span class='id identifier rubyid_close_connection_after_writing'>close_connection_after_writing</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='kw'>module</span> <span class='const'>ProxyServer</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_receive_data'>receive_data</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
    <span class='lparen'>(</span><span class='ivar'>@buf</span> <span class='op'>||=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_data'>data</span>
    <span class='kw'>if</span> <span class='ivar'>@buf</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\r\n\r\n</span><span class='regexp_end'>/</span></span> <span class='comment'># all http headers received
</span>      <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_connect'>connect</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>10.0.0.15</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>80</span><span class='comma'>,</span> <span class='const'>ProxyConnection</span><span class='comma'>,</span> <span class='kw'>self</span><span class='comma'>,</span> <span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_run'>run</span> <span class='lbrace'>{</span>
  <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_start_server'>start_server</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>127.0.0.1</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>8080</span><span class='comma'>,</span> <span class='const'>ProxyServer</span><span class='rparen'>)</span>
<span class='rbrace'>}</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>from</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="EventMachine/Connection.html" title="EventMachine::Connection (class)">EventMachine::Connection</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Source of data to be proxies/streamed.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>to</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="EventMachine/Connection.html" title="EventMachine::Connection (class)">EventMachine::Connection</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Destination of data to be proxies/streamed.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>bufsize</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>0</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Buffer size to use</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>length</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>0</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Maximum number of bytes to proxy.</p>
</div>
      
    </li>
  
</ul>


  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><span class='object_link'><a href="#disable_proxy-class_method" title="EventMachine.disable_proxy (method)">disable_proxy</a></span></li>
    
  </ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1386
1387
1388</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 1386</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_enable_proxy'>enable_proxy</span><span class='lparen'>(</span><span class='id identifier rubyid_from'>from</span><span class='comma'>,</span> <span class='id identifier rubyid_to'>to</span><span class='comma'>,</span> <span class='id identifier rubyid_bufsize'>bufsize</span><span class='op'>=</span><span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_length'>length</span><span class='op'>=</span><span class='int'>0</span><span class='rparen'>)</span>
  <span class='const'>EM</span><span class='op'>::</span><span class='id identifier rubyid_start_proxy'>start_proxy</span><span class='lparen'>(</span><span class='id identifier rubyid_from'>from</span><span class='period'>.</span><span class='id identifier rubyid_signature'>signature</span><span class='comma'>,</span> <span class='id identifier rubyid_to'>to</span><span class='period'>.</span><span class='id identifier rubyid_signature'>signature</span><span class='comma'>,</span> <span class='id identifier rubyid_bufsize'>bufsize</span><span class='comma'>,</span> <span class='id identifier rubyid_length'>length</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="error_handler-class_method">
  
    + (<tt>Object</tt>) <strong>error_handler</strong>(cb = nil, &amp;blk) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Catch-all for errors raised during event loop callbacks.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
      <pre class="example code"><code>
<span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_error_handler'>error_handler</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_e'>e</span><span class='op'>|</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Error raised during event loop: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
<span class='rbrace'>}</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>cb</span>
      
      
        <span class='type'>(<tt>#call</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Global catch-all errback</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1319
1320
1321
1322
1323
1324
1325</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 1319</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_error_handler'>error_handler</span> <span class='id identifier rubyid_cb'>cb</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_blk'>blk</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_cb'>cb</span> <span class='kw'>or</span> <span class='id identifier rubyid_blk'>blk</span>
    <span class='ivar'>@error_handler</span> <span class='op'>=</span> <span class='id identifier rubyid_cb'>cb</span> <span class='op'>||</span> <span class='id identifier rubyid_blk'>blk</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_instance_variable_defined?'>instance_variable_defined?</span> <span class='symbol'>:@error_handler</span>
    <span class='id identifier rubyid_remove_instance_variable'>remove_instance_variable</span> <span class='symbol'>:@error_handler</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="fork_reactor-class_method">
  
    + (<tt>Object</tt>) <strong>fork_reactor</strong>(&amp;block) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Forks a new process, properly stops the reactor and then calls <span class='object_link'><a href="#run-class_method" title="EventMachine.run (method)">run</a></span> inside of it again, passing your block.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


255
256
257
258
259
260
261
262
263
264
265
266
267
268</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 255</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_fork_reactor'>fork_reactor</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>
  <span class='comment'># This implementation is subject to change, especially if we clean up the relationship
</span>  <span class='comment'># of EM#run to @reactor_running.
</span>  <span class='comment'># Original patch by Aman Gupta.
</span>  <span class='comment'>#
</span>  <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_fork'>fork</span> <span class='kw'>do</span>
    <span class='kw'>if</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_reactor_running?'>reactor_running?</span>
      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_stop_event_loop'>stop_event_loop</span>
      <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_release_machine'>release_machine</span>
      <span class='ivar'>@reactor_running</span> <span class='op'>=</span> <span class='kw'>false</span>
    <span class='kw'>end</span>
    <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_run'>run</span> <span class='id identifier rubyid_block'>block</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="get_max_timers-class_method">
  
    + (<tt>Integer</tt>) <strong>get_max_timers</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Gets the current maximum number of allowed timers</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Maximum number of timers that may be outstanding at any given time</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


905
906
907</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 905</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_get_max_timers'>get_max_timers</span>
  <span class='id identifier rubyid_get_max_timer_count'>get_max_timer_count</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="heartbeat_interval-class_method">
  
    + (<tt>Integer</tt>) <strong>heartbeat_interval</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Retrieve the heartbeat interval. This is how often EventMachine will check for dead connections
that have had an inactivity timeout set via <span class='object_link'><a href="EventMachine/Connection.html#set_comm_inactivity_timeout-instance_method" title="EventMachine::Connection#set_comm_inactivity_timeout (method)">EventMachine::Connection#set_comm_inactivity_timeout</a></span>.
Default is 2 seconds.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Heartbeat interval, in seconds</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1405
1406
1407</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 1405</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_heartbeat_interval'>heartbeat_interval</span>
  <span class='const'>EM</span><span class='op'>::</span><span class='id identifier rubyid_get_heartbeat_interval'>get_heartbeat_interval</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="heartbeat_interval=-class_method">
  
    + (<tt>Object</tt>) <strong>heartbeat_interval=</strong>(time) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Set the heartbeat interval. This is how often EventMachine will check for dead connections
that have had an inactivity timeout set via <span class='object_link'><a href="EventMachine/Connection.html#set_comm_inactivity_timeout-instance_method" title="EventMachine::Connection#set_comm_inactivity_timeout (method)">EventMachine::Connection#set_comm_inactivity_timeout</a></span>.
Takes a Numeric number of seconds. Default is 2.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>time</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Heartbeat interval, in seconds</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1414
1415
1416</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 1414</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_heartbeat_interval='>heartbeat_interval=</span><span class='lparen'>(</span><span class='id identifier rubyid_time'>time</span><span class='rparen'>)</span>
  <span class='const'>EM</span><span class='op'>::</span><span class='id identifier rubyid_set_heartbeat_interval'>set_heartbeat_interval</span> <span class='id identifier rubyid_time'>time</span><span class='period'>.</span><span class='id identifier rubyid_to_f'>to_f</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="next_tick-class_method">
  
    + (<tt>Object</tt>) <strong>next_tick</strong>(pr = nil, &amp;block) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Schedules a proc for execution immediately after the next “turn” through the reactor
core. An advanced technique, this can be useful for improving memory management and/or
application responsiveness, especially when scheduling large amounts of data for
writing to a network connection.</p>

<p>This method takes either a single argument (which must be a callable object) or a block.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>pr</span>
      
      
        <span class='type'>(<tt>#call</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>A callable object to run</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt>ArgumentError</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1077
1078
1079
1080
1081
1082
1083
1084
1085
1086
1087
1088
1089
1090
1091</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 1077</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_next_tick'>next_tick</span> <span class='id identifier rubyid_pr'>pr</span><span class='op'>=</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>
  <span class='comment'># This works by adding to the @resultqueue that&#39;s used for #defer.
</span>  <span class='comment'># The general idea is that next_tick is used when we want to give the reactor a chance
</span>  <span class='comment'># to let other operations run, either to balance the load out more evenly, or to let
</span>  <span class='comment'># outbound network buffers drain, or both. So we probably do NOT want to block, and
</span>  <span class='comment'># we probably do NOT want to be spinning any threads. A program that uses next_tick
</span>  <span class='comment'># but not #defer shouldn&#39;t suffer the penalty of having Ruby threads running. They&#39;re
</span>  <span class='comment'># extremely expensive even if they&#39;re just sleeping.
</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>no proc or block given</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='lparen'>(</span><span class='lparen'>(</span><span class='id identifier rubyid_pr'>pr</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_pr'>pr</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:call</span><span class='rparen'>)</span><span class='rparen'>)</span> <span class='kw'>or</span> <span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span>
  <span class='ivar'>@next_tick_mutex</span><span class='period'>.</span><span class='id identifier rubyid_synchronize'>synchronize</span> <span class='kw'>do</span>
    <span class='ivar'>@next_tick_queue</span> <span class='op'>&lt;&lt;</span> <span class='lparen'>(</span> <span class='id identifier rubyid_pr'>pr</span> <span class='op'>||</span> <span class='id identifier rubyid_block'>block</span> <span class='rparen'>)</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_signal_loopbreak'>signal_loopbreak</span> <span class='kw'>if</span> <span class='id identifier rubyid_reactor_running?'>reactor_running?</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="open_datagram_socket-class_method">
  
    + (<tt>Object</tt>) <strong>open_datagram_socket</strong>(address, port, handler = nil, *args) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Used for UDP-based protocols. Its usage is similar to that of <span class='object_link'><a href="#start_server-class_method" title="EventMachine.start_server (method)">start_server</a></span>.</p>

<p>This method will create a new UDP (datagram) socket and
bind it to the address and port that you specify.
The normal callbacks (see <span class='object_link'><a href="#start_server-class_method" title="EventMachine.start_server (method)">start_server</a></span>) will
be called as events of interest occur on the newly-created
socket, but there are some differences in how they behave.</p>

<p><span class='object_link'><a href="EventMachine/Connection.html#receive_data-instance_method" title="EventMachine::Connection#receive_data (method)">EventMachine::Connection#receive_data</a></span> will be called when a datagram packet
is received on the socket, but unlike TCP sockets, the message
boundaries of the received data will be respected. In other words,
if the remote peer sent you a datagram of a particular size,
you may rely on <span class='object_link'><a href="EventMachine/Connection.html#receive_data-instance_method" title="EventMachine::Connection#receive_data (method)">EventMachine::Connection#receive_data</a></span> to give you the
exact data in the packet, with the original data length.
Also observe that Connection#receive_data may be called with a
<em>zero-length</em> data payload, since empty datagrams are permitted in UDP.</p>

<p><span class='object_link'><a href="EventMachine/Connection.html#send_data-instance_method" title="EventMachine::Connection#send_data (method)">EventMachine::Connection#send_data</a></span> is available with UDP packets as with TCP,
but there is an important difference. Because UDP communications
are <em>connectionless</em>, there is no implicit recipient for the packets you
send. Ordinarily you must specify the recipient for each packet you send.
However, EventMachine provides for the typical pattern of receiving a UDP datagram
from a remote peer, performing some operation, and then sending
one or more packets in response to the same remote peer.
To support this model easily, just use <span class='object_link'><a href="EventMachine/Connection.html#send_data-instance_method" title="EventMachine::Connection#send_data (method)">EventMachine::Connection#send_data</a></span>
in the code that you supply for <span class='object_link'><a href="EventMachine/Connection.html#receive_data-instance_method" title="EventMachine::Connection#receive_data (method)">EventMachine::Connection#receive_data</a></span>.</p>

<p>EventMachine will provide an implicit return address for any messages sent to
<span class='object_link'><a href="EventMachine/Connection.html#send_data-instance_method" title="EventMachine::Connection#send_data (method)">EventMachine::Connection#send_data</a></span> within the context of a <span class='object_link'><a href="EventMachine/Connection.html#receive_data-instance_method" title="EventMachine::Connection#receive_data (method)">EventMachine::Connection#receive_data</a></span> callback,
and your response will automatically go to the correct remote peer.</p>

<p>Observe that the port number that you supply to <span class='object_link'><a href="#open_datagram_socket-class_method" title="EventMachine.open_datagram_socket (method)">open_datagram_socket</a></span>
may be zero. In this case, EventMachine will create a UDP socket
that is bound to an <a href="http://en.wikipedia.org/wiki/Ephemeral_port">ephemeral port</a>.
This is not appropriate for servers that must publish a well-known
port to which remote peers may send datagrams. But it can be useful
for clients that send datagrams to other servers.
If you do this, you will receive any responses from the remote
servers through the normal <span class='object_link'><a href="EventMachine/Connection.html#receive_data-instance_method" title="EventMachine::Connection#receive_data (method)">EventMachine::Connection#receive_data</a></span> callback.
Observe that you will probably have issues with firewalls blocking
the ephemeral port numbers, so this technique is most appropriate for LANs.</p>

<p>If you wish to send datagrams to arbitrary remote peers (not
necessarily ones that have sent data to which you are responding),
then see <span class='object_link'><a href="EventMachine/Connection.html#send_datagram-instance_method" title="EventMachine::Connection#send_datagram (method)">EventMachine::Connection#send_datagram</a></span>.</p>

<p>DO NOT call send_data from a datagram socket outside of a <span class='object_link'><a href="EventMachine/Connection.html#receive_data-instance_method" title="EventMachine::Connection#receive_data (method)">EventMachine::Connection#receive_data</a></span> method. Use <span class='object_link'><a href="EventMachine/Connection.html#send_datagram-instance_method" title="EventMachine::Connection#send_datagram (method)">EventMachine::Connection#send_datagram</a></span>.
If you do use <span class='object_link'><a href="EventMachine/Connection.html#send_data-instance_method" title="EventMachine::Connection#send_data (method)">EventMachine::Connection#send_data</a></span> outside of a <span class='object_link'><a href="EventMachine/Connection.html#receive_data-instance_method" title="EventMachine::Connection#receive_data (method)">EventMachine::Connection#receive_data</a></span> method, you’ll get a confusing error
because there is no “peer,” as #send_data requires (inside of <span class='object_link'><a href="EventMachine/Connection.html#receive_data-instance_method" title="EventMachine::Connection#receive_data (method)">EventMachine::Connection#receive_data</a></span>,
<span class='object_link'><a href="EventMachine/Connection.html#send_data-instance_method" title="EventMachine::Connection#send_data (method)">EventMachine::Connection#send_data</a></span> “fakes” the peer as described above).</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>address</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>IP address</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>port</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Port</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>handler</span>
      
      
        <span class='type'>(<tt>Class</tt>, <tt>Module</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>A class or a module that implements connection lifecycle callbacks.</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


853
854
855
856
857
858
859
860
861
862
863
864</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 853</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_open_datagram_socket'>open_datagram_socket</span> <span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span><span class='comma'>,</span> <span class='id identifier rubyid_handler'>handler</span><span class='op'>=</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span>
  <span class='comment'># Replaced the implementation on 01Oct06. Thanks to Tobias Gustafsson for pointing
</span>  <span class='comment'># out that this originally did not take a class but only a module.
</span>

  <span class='id identifier rubyid_klass'>klass</span> <span class='op'>=</span> <span class='id identifier rubyid_klass_from_handler'>klass_from_handler</span><span class='lparen'>(</span><span class='const'>Connection</span><span class='comma'>,</span> <span class='id identifier rubyid_handler'>handler</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_s'>s</span> <span class='op'>=</span> <span class='id identifier rubyid_open_udp_socket'>open_udp_socket</span> <span class='id identifier rubyid_address'>address</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
  <span class='id identifier rubyid_c'>c</span> <span class='op'>=</span> <span class='id identifier rubyid_klass'>klass</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_s'>s</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span>
  <span class='ivar'>@conns</span><span class='lbracket'>[</span><span class='id identifier rubyid_s'>s</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_c'>c</span>
  <span class='id identifier rubyid_block_given?'>block_given?</span> <span class='kw'>and</span> <span class='kw'>yield</span> <span class='id identifier rubyid_c'>c</span>
  <span class='id identifier rubyid_c'>c</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="popen-class_method">
  
    + (<tt>Object</tt>) <strong>popen</strong>(cmd, handler = nil, *args) {|c| ... }
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'><p>This method is not supported on Microsoft Windows</p>
</div>
  </div>

<p>Runs an external process.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
      <pre class="example code"><code>
<span class='kw'>module</span> <span class='const'>RubyCounter</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_post_init'>post_init</span>
    <span class='comment'># count up to 5
</span>    <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>5\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_receive_data'>receive_data</span> <span class='id identifier rubyid_data'>data</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ruby sent me: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_data'>data</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_unbind'>unbind</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ruby died with exit status: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_get_status'>get_status</span><span class='period'>.</span><span class='id identifier rubyid_exitstatus'>exitstatus</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_run'>run</span> <span class='lbrace'>{</span>
  <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_popen'>popen</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ruby -e&#39; $stdout.sync = true; gets.to_i.times{ |i| puts i+1; sleep 1 } &#39;</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='const'>RubyCounter</span><span class='rparen'>)</span>
<span class='rbrace'>}</span></code></pre>
    
  </div>

<p class="tag_title">Yields:</p>
<ul class="yield">
  
    <li>
      
      
        <span class='type'>(<tt>c</tt>)</span>
      
      
      
    </li>
  
</ul>

  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><span class='object_link'><a href="EventMachine/DeferrableChildProcess.html" title="EventMachine::DeferrableChildProcess (class)">DeferrableChildProcess</a></span></li>
    
      <li><span class='object_link'><a href="#system-class_method" title="EventMachine.system (method)">system</a></span></li>
    
  </ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1154
1155
1156
1157
1158
1159
1160
1161
1162
1163
1164
1165
1166
1167
1168
1169
1170
1171</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 1154</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_popen'>popen</span> <span class='id identifier rubyid_cmd'>cmd</span><span class='comma'>,</span> <span class='id identifier rubyid_handler'>handler</span><span class='op'>=</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span>
  <span class='comment'># At this moment, it&#39;s only available on Unix.
</span>  <span class='comment'># Perhaps misnamed since the underlying function uses socketpair and is full-duplex.
</span>
  <span class='id identifier rubyid_klass'>klass</span> <span class='op'>=</span> <span class='id identifier rubyid_klass_from_handler'>klass_from_handler</span><span class='lparen'>(</span><span class='const'>Connection</span><span class='comma'>,</span> <span class='id identifier rubyid_handler'>handler</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_w'>w</span> <span class='op'>=</span> <span class='kw'>case</span> <span class='id identifier rubyid_cmd'>cmd</span>
      <span class='kw'>when</span> <span class='const'>Array</span>
        <span class='id identifier rubyid_cmd'>cmd</span>
      <span class='kw'>when</span> <span class='const'>String</span>
        <span class='const'>Shellwords</span><span class='op'>::</span><span class='id identifier rubyid_shellwords'>shellwords</span><span class='lparen'>(</span> <span class='id identifier rubyid_cmd'>cmd</span> <span class='rparen'>)</span>
      <span class='kw'>end</span>
  <span class='id identifier rubyid_w'>w</span><span class='period'>.</span><span class='id identifier rubyid_unshift'>unshift</span><span class='lparen'>(</span> <span class='id identifier rubyid_w'>w</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span> <span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_w'>w</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
  <span class='id identifier rubyid_s'>s</span> <span class='op'>=</span> <span class='id identifier rubyid_invoke_popen'>invoke_popen</span><span class='lparen'>(</span> <span class='id identifier rubyid_w'>w</span> <span class='rparen'>)</span>
  <span class='id identifier rubyid_c'>c</span> <span class='op'>=</span> <span class='id identifier rubyid_klass'>klass</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_s'>s</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span>
  <span class='ivar'>@conns</span><span class='lbracket'>[</span><span class='id identifier rubyid_s'>s</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_c'>c</span>
  <span class='kw'>yield</span><span class='lparen'>(</span><span class='id identifier rubyid_c'>c</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='id identifier rubyid_block_given?'>block_given?</span>
  <span class='id identifier rubyid_c'>c</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="reactor_running?-class_method">
  
    + (<tt>Boolean</tt>) <strong>reactor_running?</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Tells you whether the EventMachine reactor loop is currently running.</p>

<p>Useful when writing libraries that want to run event-driven code, but may
be running in programs that are already event-driven. In such cases, if <span class='object_link'><a href="#reactor_running%3F-class_method" title="EventMachine.reactor_running? (method)">reactor_running?</a></span>
returns false, your code can invoke <span class='object_link'><a href="#run-class_method" title="EventMachine.run (method)">run</a></span> and run your application code inside
the block passed to that method. If this method returns true, just
execute your event-aware code.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>true if the EventMachine reactor loop is currently running</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1183
1184
1185</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 1183</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_reactor_running?'>reactor_running?</span>
  <span class='lparen'>(</span><span class='ivar'>@reactor_running</span> <span class='op'>||</span> <span class='kw'>false</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="reactor_thread?-class_method">
  
    + (<tt>Boolean</tt>) <strong>reactor_thread?</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>True if the calling thread is the same thread as the reactor.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>true if the calling thread is the same thread as the reactor.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


239
240
241</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 239</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_reactor_thread?'>reactor_thread?</span>
  <span class='const'>Thread</span><span class='period'>.</span><span class='id identifier rubyid_current'>current</span> <span class='op'>==</span> <span class='ivar'>@reactor_thread</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="reconnect-class_method">
  
    + (<tt>Object</tt>) <strong>reconnect</strong>(server, port, handler) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Connect to a given host/port and re-use the provided <span class='object_link'><a href="EventMachine/Connection.html" title="EventMachine::Connection (class)">Connection</a></span> instance.
Consider also <span class='object_link'><a href="EventMachine/Connection.html#reconnect-instance_method" title="EventMachine::Connection#reconnect (method)">EventMachine::Connection#reconnect</a></span>.</p>


  </div>
</div>
<div class="tags">
  

  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><span class='object_link'><a href="EventMachine/Connection.html#reconnect-instance_method" title="EventMachine::Connection#reconnect (method)">EventMachine::Connection#reconnect</a></span></li>
    
  </ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


762
763
764
765
766
767
768
769
770
771
772
773
774
775
776
777
778
779
780
781
782
783
784</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 762</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_reconnect'>reconnect</span> <span class='id identifier rubyid_server'>server</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span><span class='comma'>,</span> <span class='id identifier rubyid_handler'>handler</span>
  <span class='comment'># Observe, the test for already-connected FAILS if we call a reconnect inside post_init,
</span>  <span class='comment'># because we haven&#39;t set up the connection in @conns by that point.
</span>  <span class='comment'># RESIST THE TEMPTATION to &quot;fix&quot; this problem by redefining the behavior of post_init.
</span>  <span class='comment'>#
</span>  <span class='comment'># Changed 22Nov06: if called on an already-connected handler, just return the
</span>  <span class='comment'># handler and do nothing more. Originally this condition raised an exception.
</span>  <span class='comment'># We may want to change it yet again and call the block, if any.
</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>invalid handler</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_handler'>handler</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:connection_completed</span><span class='rparen'>)</span>
  <span class='comment'>#raise &quot;still connected&quot; if @conns.has_key?(handler.signature)
</span>  <span class='kw'>return</span> <span class='id identifier rubyid_handler'>handler</span> <span class='kw'>if</span> <span class='ivar'>@conns</span><span class='period'>.</span><span class='id identifier rubyid_has_key?'>has_key?</span><span class='lparen'>(</span><span class='id identifier rubyid_handler'>handler</span><span class='period'>.</span><span class='id identifier rubyid_signature'>signature</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_s'>s</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_port'>port</span>
        <span class='id identifier rubyid_connect_server'>connect_server</span> <span class='id identifier rubyid_server'>server</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_connect_unix_server'>connect_unix_server</span> <span class='id identifier rubyid_server'>server</span>
      <span class='kw'>end</span>
  <span class='id identifier rubyid_handler'>handler</span><span class='period'>.</span><span class='id identifier rubyid_signature'>signature</span> <span class='op'>=</span> <span class='id identifier rubyid_s'>s</span>
  <span class='ivar'>@conns</span><span class='lbracket'>[</span><span class='id identifier rubyid_s'>s</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_handler'>handler</span>
  <span class='id identifier rubyid_block_given?'>block_given?</span> <span class='kw'>and</span> <span class='kw'>yield</span> <span class='id identifier rubyid_handler'>handler</span>
  <span class='id identifier rubyid_handler'>handler</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="run-class_method">
  
    + (<tt>Object</tt>) <strong>run</strong>(blk = nil, tail = nil, &amp;block) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'><p>This method blocks calling thread. If you need to start EventMachine event loop from a Web app
running on a non event-driven server (Unicorn, Apache Passenger, Mongrel), do it in a separate thread like demonstrated
in one of the examples.</p>
</div>
  </div>

<p>Initializes and runs an event loop. This method only returns if code inside the block passed to this method
calls <span class='object_link'><a href="#stop_event_loop-class_method" title="EventMachine.stop_event_loop (method)">stop_event_loop</a></span>. The block is executed after initializing its internal event loop but <em>before</em> running the loop,
therefore this block is the right place to call any code that needs event loop to run, for example, <span class='object_link'><a href="#start_server-class_method" title="EventMachine.start_server (method)">start_server</a></span>,
<span class='object_link'><a href="#connect-class_method" title="EventMachine.connect (method)">connect</a></span> or similar methods of libraries that use EventMachine under the hood
(like <code>EventMachine::HttpRequest.new</code> or <code>AMQP.start</code>).</p>

<p>Programs that are run for long periods of time (e.g. servers) usually start event loop by calling <span class='object_link'><a href="#run-class_method" title="EventMachine.run (method)">run</a></span>, and let it
run “forever”. It’s also possible to use <span class='object_link'><a href="#run-class_method" title="EventMachine.run (method)">run</a></span> to make a single client-connection to a remote server,
process the data flow from that single connection, and then call <span class='object_link'><a href="#stop_event_loop-class_method" title="EventMachine.stop_event_loop (method)">stop_event_loop</a></span> to stop, in other words,
to run event loop for a short period of time (necessary to complete some operation) and then shut it down.</p>

<p>Once event loop is running, it is perfectly possible to start multiple servers and clients simultaneously: content-aware
proxies like <a href="https://github.com/mojombo/proxymachine">Proxymachine</a> do just that.</p>

<h2 id="using-eventmachine-with-ruby-on-rails-and-other-web-application-frameworks">Using EventMachine with Ruby on Rails and other Web application frameworks</h2>

<p>Standalone applications often run event loop on the main thread, thus blocking for their entire lifespan. In case of Web applications,
if you are running an EventMachine-based app server such as <a href="http://code.macournoyer.com/thin/">Thin</a> or <a href="https://github.com/postrank-labs/goliath/">Goliath</a>,
they start event loop for you. Servers like Unicorn, Apache Passenger or Mongrel occupy main Ruby thread to serve HTTP(S) requests. This means
that calling <span class='object_link'><a href="#run-class_method" title="EventMachine.run (method)">run</a></span> on the same thread is not an option (it will result in Web server never binding to the socket).
In that case, start event loop in a separate thread as demonstrated below.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
        <p class="example_title"><div class='inline'><p>Starting EventMachine event loop in the current thread to run the &#8220;Hello, world&#8221;-like Echo server example</p>
</div></p>
      
      <pre class="example code"><code>
<span class='comment'>#!/usr/bin/env ruby
</span>
<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>rubygems</span><span class='tstring_end'>&#39;</span></span> <span class='comment'># or use Bundler.setup
</span><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>eventmachine</span><span class='tstring_end'>&#39;</span></span>

<span class='kw'>class</span> <span class='const'>EchoServer</span> <span class='op'>&lt;</span> <span class='const'>EM</span><span class='op'>::</span><span class='const'>Connection</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_receive_data'>receive_data</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_send_data'>send_data</span><span class='lparen'>(</span><span class='id identifier rubyid_data'>data</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_run'>run</span> <span class='kw'>do</span>
  <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_start_server'>start_server</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>0.0.0.0</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>10000</span><span class='comma'>,</span> <span class='const'>EchoServer</span><span class='rparen'>)</span>
<span class='kw'>end</span></code></pre>
    
      
        <p class="example_title"><div class='inline'><p>Starting EventMachine event loop in a separate thread</p>
</div></p>
      
      <pre class="example code"><code>
<span class='comment'># doesn&#39;t block current thread, can be used with Ruby on Rails, Sinatra, Merb, Rack
</span><span class='comment'># and any other application server that occupies main Ruby thread.
</span><span class='const'>Thread</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='lbrace'>{</span> <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_run'>run</span> <span class='rbrace'>}</span></code></pre>
    
  </div>


  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><a href="file.GettingStarted.html" title="Getting started with EventMachine">Getting started with EventMachine</a></li>
    
      <li><span class='object_link'><a href="#stop_event_loop-class_method" title="EventMachine.stop_event_loop (method)">stop_event_loop</a></span></li>
    
  </ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 149</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_run'>run</span> <span class='id identifier rubyid_blk'>blk</span><span class='op'>=</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_tail'>tail</span><span class='op'>=</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>
  <span class='comment'># Obsoleted the use_threads mechanism.
</span>  <span class='comment'># 25Nov06: Added the begin/ensure block. We need to be sure that release_machine
</span>  <span class='comment'># gets called even if an exception gets thrown within any of the user code
</span>  <span class='comment'># that the event loop runs. The best way to see this is to run a unit
</span>  <span class='comment'># test with two functions, each of which calls {EventMachine.run} and each of
</span>  <span class='comment'># which throws something inside of #run. Without the ensure, the second test
</span>  <span class='comment'># will start without release_machine being called and will immediately throw
</span>
  <span class='comment'>#
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_reactor_running?'>reactor_running?</span> <span class='kw'>and</span> <span class='ivar'>@reactor_pid</span> <span class='op'>!=</span> <span class='const'>Process</span><span class='period'>.</span><span class='id identifier rubyid_pid'>pid</span>
    <span class='comment'># Reactor was started in a different parent, meaning we have forked.
</span>    <span class='comment'># Clean up reactor state so a new reactor boots up in this child.
</span>    <span class='id identifier rubyid_stop_event_loop'>stop_event_loop</span>
    <span class='id identifier rubyid_release_machine'>release_machine</span>
    <span class='ivar'>@reactor_running</span> <span class='op'>=</span> <span class='kw'>false</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_tail'>tail</span> <span class='kw'>and</span> <span class='ivar'>@tails</span><span class='period'>.</span><span class='id identifier rubyid_unshift'>unshift</span><span class='lparen'>(</span><span class='id identifier rubyid_tail'>tail</span><span class='rparen'>)</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_reactor_running?'>reactor_running?</span>
    <span class='lparen'>(</span><span class='id identifier rubyid_b'>b</span> <span class='op'>=</span> <span class='id identifier rubyid_blk'>blk</span> <span class='op'>||</span> <span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span> <span class='kw'>and</span> <span class='id identifier rubyid_b'>b</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span> <span class='comment'># next_tick(b)
</span>  <span class='kw'>else</span>
    <span class='ivar'>@conns</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
    <span class='ivar'>@acceptors</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
    <span class='ivar'>@timers</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
    <span class='ivar'>@wrapped_exception</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='ivar'>@next_tick_queue</span> <span class='op'>||=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
    <span class='ivar'>@tails</span> <span class='op'>||=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
    <span class='kw'>begin</span>
      <span class='ivar'>@reactor_pid</span> <span class='op'>=</span> <span class='const'>Process</span><span class='period'>.</span><span class='id identifier rubyid_pid'>pid</span>
      <span class='ivar'>@reactor_running</span> <span class='op'>=</span> <span class='kw'>true</span>
      <span class='id identifier rubyid_initialize_event_machine'>initialize_event_machine</span>
      <span class='lparen'>(</span><span class='id identifier rubyid_b'>b</span> <span class='op'>=</span> <span class='id identifier rubyid_blk'>blk</span> <span class='op'>||</span> <span class='id identifier rubyid_block'>block</span><span class='rparen'>)</span> <span class='kw'>and</span> <span class='id identifier rubyid_add_timer'>add_timer</span><span class='lparen'>(</span><span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_b'>b</span><span class='rparen'>)</span>
      <span class='kw'>if</span> <span class='ivar'>@next_tick_queue</span> <span class='op'>&amp;&amp;</span> <span class='op'>!</span><span class='ivar'>@next_tick_queue</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
        <span class='id identifier rubyid_add_timer'>add_timer</span><span class='lparen'>(</span><span class='int'>0</span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_signal_loopbreak'>signal_loopbreak</span> <span class='rbrace'>}</span>
      <span class='kw'>end</span>
      <span class='ivar'>@reactor_thread</span> <span class='op'>=</span> <span class='const'>Thread</span><span class='period'>.</span><span class='id identifier rubyid_current'>current</span>
      <span class='id identifier rubyid_run_machine'>run_machine</span>
    <span class='kw'>ensure</span>
      <span class='kw'>until</span> <span class='ivar'>@tails</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>
        <span class='ivar'>@tails</span><span class='period'>.</span><span class='id identifier rubyid_pop'>pop</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span>
      <span class='kw'>end</span>

      <span class='kw'>begin</span>
        <span class='id identifier rubyid_release_machine'>release_machine</span>
      <span class='kw'>ensure</span>
        <span class='kw'>if</span> <span class='ivar'>@threadpool</span>
          <span class='ivar'>@threadpool</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span> <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_exit'>exit</span> <span class='rbrace'>}</span>
          <span class='ivar'>@threadpool</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
            <span class='kw'>next</span> <span class='kw'>unless</span> <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_alive?'>alive?</span>
            <span class='kw'>begin</span>
              <span class='comment'># Thread#kill! does not exist on 1.9 or rbx, and raises
</span>              <span class='comment'># NotImplemented on jruby
</span>              <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_kill!'>kill!</span>
            <span class='kw'>rescue</span> <span class='const'>NoMethodError</span><span class='comma'>,</span> <span class='const'>NotImplementedError</span>
              <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_kill'>kill</span>
              <span class='comment'># XXX t.join here?
</span>            <span class='kw'>end</span>
          <span class='kw'>end</span>
          <span class='ivar'>@threadqueue</span> <span class='op'>=</span> <span class='kw'>nil</span>
          <span class='ivar'>@resultqueue</span> <span class='op'>=</span> <span class='kw'>nil</span>
          <span class='ivar'>@threadpool</span> <span class='op'>=</span> <span class='kw'>nil</span>
          <span class='ivar'>@all_threads_spawned</span> <span class='op'>=</span> <span class='kw'>false</span>
        <span class='kw'>end</span>

        <span class='ivar'>@next_tick_queue</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
      <span class='kw'>end</span>
      <span class='ivar'>@reactor_running</span> <span class='op'>=</span> <span class='kw'>false</span>
      <span class='ivar'>@reactor_thread</span> <span class='op'>=</span> <span class='kw'>nil</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_raise'>raise</span> <span class='ivar'>@wrapped_exception</span> <span class='kw'>if</span> <span class='ivar'>@wrapped_exception</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="run_block-class_method">
  
    + (<tt>Object</tt>) <strong>run_block</strong>(&amp;block) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Sugars a common use case. Will pass the given block to #run, but will terminate
the reactor loop and exit the function as soon as the code in the block completes.
(Normally, <span class='object_link'><a href="#run-class_method" title="EventMachine.run (method)">run</a></span> keeps running indefinitely, even after the block supplied to it
finishes running, until user code calls stop)</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


230
231
232
233
234
235
236</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 230</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_run_block'>run_block</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>
  <span class='id identifier rubyid_pr'>pr</span> <span class='op'>=</span> <span class='id identifier rubyid_proc'>proc</span> <span class='lbrace'>{</span>
    <span class='id identifier rubyid_block'>block</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span>
    <span class='const'>EventMachine</span><span class='op'>::</span><span class='id identifier rubyid_stop'>stop</span>
  <span class='rbrace'>}</span>
  <span class='id identifier rubyid_run'>run</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='id identifier rubyid_pr'>pr</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="schedule-class_method">
  
    + (<tt>Object</tt>) <strong>schedule</strong>(*a, &amp;b) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Runs the given callback on the reactor thread, or immediately if called
from the reactor thread. Accepts the same arguments as Callback</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


245
246
247
248
249
250
251
252</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 245</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_schedule'>schedule</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_a'>a</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_b'>b</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_cb'>cb</span> <span class='op'>=</span> <span class='const'>Callback</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_a'>a</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_b'>b</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_reactor_running?'>reactor_running?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_reactor_thread?'>reactor_thread?</span>
    <span class='id identifier rubyid_cb'>cb</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_next_tick'>next_tick</span> <span class='lbrace'>{</span> <span class='id identifier rubyid_cb'>cb</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="set_descriptor_table_size-class_method">
  
    + (<tt>Integer</tt>) <strong>set_descriptor_table_size</strong>(n_descriptors = nil) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Sets the maximum number of file or socket descriptors that your process may open.
If you call this method with no arguments, it will simply return
the current size of the descriptor table without attempting to change it.</p>

<p>The new limit on open descriptors <strong>only</strong> applies to sockets and other descriptors
that belong to EventMachine. It has <strong>no effect</strong> on the number of descriptors
you can create in ordinary Ruby code.</p>

<p>Not available on all platforms. Increasing the number of descriptors beyond its
default limit usually requires superuser privileges. (See <span class='object_link'><a href="#set_effective_user-class_method" title="EventMachine.set_effective_user (method)">set_effective_user</a></span>
for a way to drop superuser privileges while your program is running.)</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>n_descriptors</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>The maximum number of file or socket descriptors that your process may open</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The new descriptor table size.</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1124
1125
1126</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 1124</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_set_descriptor_table_size'>set_descriptor_table_size</span> <span class='id identifier rubyid_n_descriptors'>n_descriptors</span><span class='op'>=</span><span class='kw'>nil</span>
  <span class='const'>EventMachine</span><span class='op'>::</span><span class='id identifier rubyid_set_rlimit_nofile'>set_rlimit_nofile</span> <span class='id identifier rubyid_n_descriptors'>n_descriptors</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="set_effective_user-class_method">
  
    + (<tt>Object</tt>) <strong>set_effective_user</strong>(username) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'><p>This method has no effective implementation on Windows or in the pure-Ruby
implementation of EventMachine</p>
</div>
  </div>

<p>A wrapper over the setuid system call. Particularly useful when opening a network
server on a privileged port because you can use this call to drop privileges
after opening the port. Also very useful after a call to <span class='object_link'><a href="#set_descriptor_table_size-class_method" title="EventMachine.set_descriptor_table_size (method)">set_descriptor_table_size</a></span>,
which generally requires that you start your process with root privileges.</p>

<p>This method is intended for use in enforcing security requirements, consequently
it will throw a fatal error and end your program if it fails.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>username</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The effective name of the user whose privilege-level your process should attain.</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1105
1106
1107</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 1105</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_set_effective_user'>set_effective_user</span> <span class='id identifier rubyid_username'>username</span>
  <span class='const'>EventMachine</span><span class='op'>::</span><span class='id identifier rubyid_setuid_string'>setuid_string</span> <span class='id identifier rubyid_username'>username</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="set_max_timers-class_method">
  
    + (<tt>Object</tt>) <strong>set_max_timers</strong>(ct) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'><p>This method has to be used <em>before</em> event loop is started.</p>
</div>
  </div>

<p>Sets the maximum number of timers and periodic timers that may be outstanding at any
given time. You only need to call <span class='object_link'><a href="#set_max_timers-class_method" title="EventMachine.set_max_timers (method)">set_max_timers</a></span> if you need more than the default
number of timers, which on most platforms is 1000.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>ct</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Maximum number of timers that may be outstanding at any given time</p>
</div>
      
    </li>
  
</ul>


  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><span class='object_link'><a href="#add_timer-class_method" title="EventMachine.add_timer (method)">add_timer</a></span></li>
    
      <li><span class='object_link'><a href="#add_periodic_timer-class_method" title="EventMachine.add_periodic_timer (method)">add_periodic_timer</a></span></li>
    
      <li><span class='object_link'><a href="EventMachine/Timer.html" title="EventMachine::Timer (class)">Timer</a></span></li>
    
  </ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


898
899
900</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 898</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_set_max_timers'>set_max_timers</span> <span class='id identifier rubyid_ct'>ct</span>
  <span class='id identifier rubyid_set_max_timer_count'>set_max_timer_count</span> <span class='id identifier rubyid_ct'>ct</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="set_quantum-class_method">
  
    + (<tt>Object</tt>) <strong>set_quantum</strong>(mills) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>For advanced users. This function sets the default timer granularity, which by default is
slightly smaller than 100 milliseconds. Call this function to set a higher or lower granularity.
The function affects the behavior of <span class='object_link'><a href="#add_timer-class_method" title="EventMachine.add_timer (method)">add_timer</a></span> and <span class='object_link'><a href="#add_periodic_timer-class_method" title="EventMachine.add_periodic_timer (method)">add_periodic_timer</a></span>.
Most applications will not need to call this function.</p>

<p>Avoid setting the quantum to very low values because that may reduce performance under some extreme conditions.
We recommend that you not use values lower than 10.</p>

<p>This method only can be used if event loop is running.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>mills</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>New timer granularity, in milliseconds</p>
</div>
      
    </li>
  
</ul>


  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><span class='object_link'><a href="#add_timer-class_method" title="EventMachine.add_timer (method)">add_timer</a></span></li>
    
      <li><span class='object_link'><a href="#add_periodic_timer-class_method" title="EventMachine.add_periodic_timer (method)">add_periodic_timer</a></span></li>
    
      <li><span class='object_link'><a href="EventMachine/Timer.html" title="EventMachine::Timer (class)">Timer</a></span></li>
    
      <li><span class='object_link'><a href="#run-class_method" title="EventMachine.run (method)">run</a></span></li>
    
  </ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


883
884
885</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 883</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_set_quantum'>set_quantum</span> <span class='id identifier rubyid_mills'>mills</span>
  <span class='id identifier rubyid_set_timer_quantum'>set_timer_quantum</span> <span class='id identifier rubyid_mills'>mills</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="spawn-class_method">
  
    + (<tt>Object</tt>) <strong>spawn</strong>(&amp;block) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Spawn an erlang-style process</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


69
70
71
72
73</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/spawnable.rb', line 69</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_spawn'>spawn</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>
  <span class='id identifier rubyid_s'>s</span> <span class='op'>=</span> <span class='const'>SpawnedProcess</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='id identifier rubyid_s'>s</span><span class='period'>.</span><span class='id identifier rubyid_set_receiver'>set_receiver</span> <span class='id identifier rubyid_block'>block</span>
  <span class='id identifier rubyid_s'>s</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="start_server-class_method">
  
    + (<tt>Object</tt>) <strong>start_server</strong>(server, port = nil, handler = nil, *args, &amp;block) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'><p>Don&#8217;t forget that in order to bind to ports &lt; 1024 on Linux, *BSD and Mac OS X your process must have superuser privileges.</p>
</div>
  </div>

<p>Initiates a TCP server (socket acceptor) on the specified IP address and port.</p>

<p>The IP address must be valid on the machine where the program
runs, and the process must be privileged enough to listen
on the specified port (on Unix-like systems, superuser privileges
are usually required to listen on any port lower than 1024).
Only one listener may be running on any given address/port
combination. start_server will fail if the given address and port
are already listening on the machine, either because of a prior call
to <span class='object_link'><a href="#start_server-class_method" title="EventMachine.start_server (method)">start_server</a></span> or some unrelated process running on the machine.
If <span class='object_link'><a href="#start_server-class_method" title="EventMachine.start_server (method)">start_server</a></span> succeeds, the new network listener becomes active
immediately and starts accepting connections from remote peers,
and these connections generate callback events that are processed
by the code specified in the handler parameter to <span class='object_link'><a href="#start_server-class_method" title="EventMachine.start_server (method)">start_server</a></span>.</p>

<p>The optional handler which is passed to this method is the key
to EventMachine’s ability to handle particular network protocols.
The handler parameter passed to start_server must be a Ruby Module
that you must define. When the network server that is started by
start_server accepts a new connection, it instantiates a new
object of an anonymous class that is inherited from <span class='object_link'><a href="EventMachine/Connection.html" title="EventMachine::Connection (class)">Connection</a></span>,
<em>into which your handler module have been included</em>. Arguments passed into start_server
after the class name are passed into the constructor during the instantiation.</p>

<p>Your handler module may override any of the methods in <span class='object_link'><a href="EventMachine/Connection.html" title="EventMachine::Connection (class)">Connection</a></span>,
such as <span class='object_link'><a href="EventMachine/Connection.html#receive_data-instance_method" title="EventMachine::Connection#receive_data (method)">EventMachine::Connection#receive_data</a></span>, in order to implement the specific behavior
of the network protocol.</p>

<p>Callbacks invoked in response to network events <em>always</em> take place
within the execution context of the object derived from <span class='object_link'><a href="EventMachine/Connection.html" title="EventMachine::Connection (class)">Connection</a></span>
extended by your handler module. There is one object per connection, and
all of the callbacks invoked for a particular connection take the form
of instance methods called against the corresponding <span class='object_link'><a href="EventMachine/Connection.html" title="EventMachine::Connection (class)">Connection</a></span>
object. Therefore, you are free to define whatever instance variables you
wish, in order to contain the per-connection state required by the network protocol you are
implementing.</p>

<p><span class='object_link'><a href="#start_server-class_method" title="EventMachine.start_server (method)">start_server</a></span> is usually called inside the block passed to <span class='object_link'><a href="#run-class_method" title="EventMachine.run (method)">run</a></span>,
but it can be called from any EventMachine callback. <span class='object_link'><a href="#start_server-class_method" title="EventMachine.start_server (method)">start_server</a></span> will fail
unless the EventMachine event loop is currently running (which is why
it’s often called in the block suppled to <span class='object_link'><a href="#run-class_method" title="EventMachine.run (method)">run</a></span>).</p>

<p>You may call start_server any number of times to start up network
listeners on different address/port combinations. The servers will
all run simultaneously. More interestingly, each individual call to start_server
can specify a different handler module and thus implement a different
network protocol from all the others.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
      <pre class="example code"><code>
<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>rubygems</span><span class='tstring_end'>&#39;</span></span>
<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>eventmachine</span><span class='tstring_end'>&#39;</span></span>

<span class='comment'># Here is an example of a server that counts lines of input from the remote
</span><span class='comment'># peer and sends back the total number of lines received, after each line.
</span><span class='comment'># Try the example with more than one client connection opened via telnet,
</span><span class='comment'># and you will see that the line count increments independently on each
</span><span class='comment'># of the client connections. Also very important to note, is that the
</span><span class='comment'># handler for the receive_data function, which our handler redefines, may
</span><span class='comment'># not assume that the data it receives observes any kind of message boundaries.
</span><span class='comment'># Also, to use this example, be sure to change the server and port parameters
</span><span class='comment'># to the start_server call to values appropriate for your environment.
</span><span class='kw'>module</span> <span class='const'>LineCounter</span>
  <span class='const'>MaxLinesPerConnection</span> <span class='op'>=</span> <span class='int'>10</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_post_init'>post_init</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Received a new connection</span><span class='tstring_end'>&quot;</span></span>
    <span class='ivar'>@data_received</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_end'>&quot;</span></span>
    <span class='ivar'>@line_count</span> <span class='op'>=</span> <span class='int'>0</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_receive_data'>receive_data</span> <span class='id identifier rubyid_data'>data</span>
    <span class='ivar'>@data_received</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_data'>data</span>
    <span class='kw'>while</span> <span class='ivar'>@data_received</span><span class='period'>.</span><span class='id identifier rubyid_slice!'>slice!</span><span class='lparen'>(</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^[^\n]*[\n]</span><span class='regexp_end'>/m</span></span> <span class='rparen'>)</span>
      <span class='ivar'>@line_count</span> <span class='op'>+=</span> <span class='int'>1</span>
      <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>received </span><span class='embexpr_beg'>#{</span><span class='ivar'>@line_count</span><span class='embexpr_end'>}</span><span class='tstring_content'> lines so far\r\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='ivar'>@line_count</span> <span class='op'>==</span> <span class='const'>MaxLinesPerConnection</span> <span class='kw'>and</span> <span class='id identifier rubyid_close_connection_after_writing'>close_connection_after_writing</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_run'>run</span> <span class='lbrace'>{</span>
  <span class='id identifier rubyid_host'>host</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>192.168.0.100</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>8090</span>
  <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_start_server'>start_server</span> <span class='id identifier rubyid_host'>host</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span><span class='comma'>,</span> <span class='const'>LineCounter</span>
  <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Now accepting connections on address </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_host'>host</span><span class='embexpr_end'>}</span><span class='tstring_content'>, port </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_port'>port</span><span class='embexpr_end'>}</span><span class='tstring_content'>...</span><span class='tstring_end'>&quot;</span></span>
  <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_add_periodic_timer'>add_periodic_timer</span><span class='lparen'>(</span><span class='int'>10</span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='gvar'>$stderr</span><span class='period'>.</span><span class='id identifier rubyid_write'>write</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>*</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
<span class='rbrace'>}</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>server</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Host to bind to.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>port</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Port to bind to.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>handler</span>
      
      
        <span class='type'>(<tt>Module</tt>, <tt>Class</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>A module or class that implements connection callbacks</p>
</div>
      
    </li>
  
</ul>


  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><a href="file.GettingStarted.html" title="EventMachine tutorial">EventMachine tutorial</a></li>
    
      <li><span class='object_link'><a href="#stop_server-class_method" title="EventMachine.stop_server (method)">stop_server</a></span></li>
    
  </ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 512</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_start_server'>start_server</span> <span class='id identifier rubyid_server'>server</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span><span class='op'>=</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_handler'>handler</span><span class='op'>=</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>
  <span class='kw'>begin</span>
    <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='const'>Integer</span><span class='lparen'>(</span><span class='id identifier rubyid_port'>port</span><span class='rparen'>)</span>
  <span class='kw'>rescue</span> <span class='const'>ArgumentError</span><span class='comma'>,</span> <span class='const'>TypeError</span>
    <span class='comment'># there was no port, so server must be a unix domain socket
</span>    <span class='comment'># the port argument is actually the handler, and the handler is one of the args
</span>    <span class='id identifier rubyid_args'>args</span><span class='period'>.</span><span class='id identifier rubyid_unshift'>unshift</span> <span class='id identifier rubyid_handler'>handler</span> <span class='kw'>if</span> <span class='id identifier rubyid_handler'>handler</span>
    <span class='id identifier rubyid_handler'>handler</span> <span class='op'>=</span> <span class='id identifier rubyid_port'>port</span>
    <span class='id identifier rubyid_port'>port</span> <span class='op'>=</span> <span class='kw'>nil</span>
  <span class='kw'>end</span> <span class='kw'>if</span> <span class='id identifier rubyid_port'>port</span>

  <span class='id identifier rubyid_klass'>klass</span> <span class='op'>=</span> <span class='id identifier rubyid_klass_from_handler'>klass_from_handler</span><span class='lparen'>(</span><span class='const'>Connection</span><span class='comma'>,</span> <span class='id identifier rubyid_handler'>handler</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_s'>s</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='id identifier rubyid_port'>port</span>
        <span class='id identifier rubyid_start_tcp_server'>start_tcp_server</span> <span class='id identifier rubyid_server'>server</span><span class='comma'>,</span> <span class='id identifier rubyid_port'>port</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_start_unix_server'>start_unix_server</span> <span class='id identifier rubyid_server'>server</span>
      <span class='kw'>end</span>
  <span class='ivar'>@acceptors</span><span class='lbracket'>[</span><span class='id identifier rubyid_s'>s</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_klass'>klass</span><span class='comma'>,</span><span class='id identifier rubyid_args'>args</span><span class='comma'>,</span><span class='id identifier rubyid_block'>block</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_s'>s</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="start_unix_domain_server-class_method">
  
    + (<tt>Object</tt>) <strong>start_unix_domain_server</strong>(filename, *args, &amp;block) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Start a Unix-domain server.</p>

<p>Note that this is an alias for <span class='object_link'><a href="#start_server-class_method" title="EventMachine.start_server (method)">start_server</a></span>, which can be used to start both
TCP and Unix-domain servers.</p>


  </div>
</div>
<div class="tags">
  

  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><span class='object_link'><a href="#start_server-class_method" title="EventMachine.start_server (method)">start_server</a></span></li>
    
  </ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


547
548
549</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 547</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_start_unix_domain_server'>start_unix_domain_server</span> <span class='id identifier rubyid_filename'>filename</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>
  <span class='id identifier rubyid_start_server'>start_server</span> <span class='id identifier rubyid_filename'>filename</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_block'>block</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="stop_event_loop-class_method">
  
    + (<tt>Object</tt>) <strong>stop_event_loop</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Causes the processing loop to stop executing, which will cause all open connections and accepting servers
to be run down and closed. Connection termination callbacks added using <span class='object_link'><a href="#add_shutdown_hook-class_method" title="EventMachine.add_shutdown_hook (method)">add_shutdown_hook</a></span>
will be called as part of running this method.</p>

<p>When all of this processing is complete, the call to <span class='object_link'><a href="#run-class_method" title="EventMachine.run (method)">run</a></span> which started the processing loop
will return and program flow will resume from the statement following <span class='object_link'><a href="#run-class_method" title="EventMachine.run (method)">run</a></span> call.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
        <p class="example_title"><div class='inline'><p>Stopping a running EventMachine event loop</p>
</div></p>
      
      <pre class="example code"><code>
<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>rubygems</span><span class='tstring_end'>&#39;</span></span>
<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>eventmachine</span><span class='tstring_end'>&#39;</span></span>

<span class='kw'>module</span> <span class='const'>Redmond</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_post_init'>post_init</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>We&#39;re sending a dumb HTTP request to the remote peer.</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_send_data'>send_data</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>GET / HTTP/1.1\r\nHost: www.microsoft.com\r\n\r\n</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_receive_data'>receive_data</span> <span class='id identifier rubyid_data'>data</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>We received </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span><span class='embexpr_end'>}</span><span class='tstring_content'> bytes from the remote peer.</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>We&#39;re going to stop the event loop now.</span><span class='tstring_end'>&quot;</span></span>
    <span class='const'>EventMachine</span><span class='op'>::</span><span class='id identifier rubyid_stop_event_loop'>stop_event_loop</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_unbind'>unbind</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>A connection has terminated.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>We&#39;re starting the event loop now.</span><span class='tstring_end'>&quot;</span></span>
<span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_run'>run</span> <span class='lbrace'>{</span>
  <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_connect'>connect</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>www.microsoft.com</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='int'>80</span><span class='comma'>,</span> <span class='const'>Redmond</span>
<span class='rbrace'>}</span>
<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>The event loop has stopped.</span><span class='tstring_end'>&quot;</span></span>

<span class='comment'># This program will produce approximately the following output:
</span><span class='comment'>#
</span><span class='comment'># We&#39;re starting the event loop now.
</span><span class='comment'># We&#39;re sending a dumb HTTP request to the remote peer.
</span><span class='comment'># We received 1440 bytes from the remote peer.
</span><span class='comment'># We&#39;re going to stop the event loop now.
</span><span class='comment'># A connection has terminated.
</span><span class='comment'># The event loop has stopped.</span></code></pre>
    
  </div>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


412
413
414</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 412</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_stop_event_loop'>stop_event_loop</span>
  <span class='const'>EventMachine</span><span class='op'>::</span><span class='id identifier rubyid_stop'>stop</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="stop_server-class_method">
  
    + (<tt>Object</tt>) <strong>stop_server</strong>(signature) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Stop a TCP server socket that was started with <span class='object_link'><a href="#start_server-class_method" title="EventMachine.start_server (method)">start_server</a></span>.</p>


  </div>
</div>
<div class="tags">
  

  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><span class='object_link'><a href="#start_server-class_method" title="EventMachine.start_server (method)">start_server</a></span></li>
    
  </ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


537
538
539</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 537</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_stop_server'>stop_server</span> <span class='id identifier rubyid_signature'>signature</span>
  <span class='const'>EventMachine</span><span class='op'>::</span><span class='id identifier rubyid_stop_tcp_server'>stop_tcp_server</span> <span class='id identifier rubyid_signature'>signature</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="system-class_method">
  
    + (<tt>Object</tt>) <strong>system</strong>(cmd, *args, &amp;cb) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>EM::system is a simple wrapper for EM::popen. It is similar to Kernel::system, but requires a
single string argument for the command and performs no shell expansion.</p>

<p>The block or proc passed to EM::system is called with two arguments: the output generated by the command,
and a Process::Status that contains information about the command’s execution.</p>

<p>EM.run{
   EM.system(‘ls’){ |output,status| puts output if status.exitstatus == 0 }
 }</p>

<p>You can also supply an additional proc to send some data to the process:</p>

<p>EM.run{
   EM.system(‘sh’, proc{ |process|
     process.send_data(“echo hello\n”)
     process.send_data(“exit\n”)
   }, proc{ |out,status|
     puts(out)
   })
 }</p>

<p>Like EventMachine.popen, EventMachine.system currently does not work on windows.
It returns the pid of the spawned process.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


112
113
114
115
116
117
118
119
120
121
122</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/processes.rb', line 112</span>

<span class='kw'>def</span> <span class='const'>EventMachine</span><span class='op'>::</span><span class='id identifier rubyid_system'>system</span> <span class='id identifier rubyid_cmd'>cmd</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_cb'>cb</span>
  <span class='id identifier rubyid_cb'>cb</span> <span class='op'>||=</span> <span class='id identifier rubyid_args'>args</span><span class='period'>.</span><span class='id identifier rubyid_pop'>pop</span> <span class='kw'>if</span> <span class='id identifier rubyid_args'>args</span><span class='period'>.</span><span class='id identifier rubyid_last'>last</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Proc</span>
  <span class='id identifier rubyid_init'>init</span> <span class='op'>=</span> <span class='id identifier rubyid_args'>args</span><span class='period'>.</span><span class='id identifier rubyid_pop'>pop</span> <span class='kw'>if</span> <span class='id identifier rubyid_args'>args</span><span class='period'>.</span><span class='id identifier rubyid_last'>last</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Proc</span>

  <span class='comment'># merge remaining arguments into the command
</span>  <span class='id identifier rubyid_cmd'>cmd</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_cmd'>cmd</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_args'>args</span><span class='period'>.</span><span class='id identifier rubyid_any?'>any?</span>

  <span class='const'>EM</span><span class='period'>.</span><span class='id identifier rubyid_get_subprocess_pid'>get_subprocess_pid</span><span class='lparen'>(</span><span class='const'>EM</span><span class='period'>.</span><span class='id identifier rubyid_popen'>popen</span><span class='lparen'>(</span><span class='id identifier rubyid_cmd'>cmd</span><span class='comma'>,</span> <span class='const'>SystemCmd</span><span class='comma'>,</span> <span class='id identifier rubyid_cb'>cb</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_c'>c</span><span class='op'>|</span>
    <span class='id identifier rubyid_init'>init</span><span class='lbracket'>[</span><span class='id identifier rubyid_c'>c</span><span class='rbracket'>]</span> <span class='kw'>if</span> <span class='id identifier rubyid_init'>init</span>
  <span class='kw'>end</span><span class='period'>.</span><span class='id identifier rubyid_signature'>signature</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="tick_loop-class_method">
  
    + (<tt>Object</tt>) <strong>tick_loop</strong>(*a, &amp;b) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Creates and immediately starts an EventMachine::TickLoop</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


3
4
5</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/em/tick_loop.rb', line 3</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_tick_loop'>tick_loop</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_a'>a</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_b'>b</span><span class='rparen'>)</span>
  <span class='const'>TickLoop</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_a'>a</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_b'>b</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_start'>start</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="watch-class_method">
  
    + (<tt>Object</tt>) <strong>watch</strong>(io, handler = nil, *args, &amp;blk) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p><span class='object_link'><a href="#watch-class_method" title="EventMachine.watch (method)">watch</a></span> registers a given file descriptor or IO object with the eventloop. The
file descriptor will not be modified (it will remain blocking or non-blocking).</p>

<p>The eventloop can be used to process readable and writable events on the file descriptor, using
<span class='object_link'><a href="EventMachine/Connection.html#notify_readable%3D-instance_method" title="EventMachine::Connection#notify_readable= (method)">EventMachine::Connection#notify_readable=</a></span> and <span class='object_link'><a href="EventMachine/Connection.html#notify_writable%3D-instance_method" title="EventMachine::Connection#notify_writable= (method)">EventMachine::Connection#notify_writable=</a></span></p>

<p><span class='object_link'><a href="EventMachine/Connection.html#notify_readable%3F-instance_method" title="EventMachine::Connection#notify_readable? (method)">EventMachine::Connection#notify_readable?</a></span> and <span class='object_link'><a href="EventMachine/Connection.html#notify_writable%3F-instance_method" title="EventMachine::Connection#notify_writable? (method)">EventMachine::Connection#notify_writable?</a></span> can be used
to check what events are enabled on the connection.</p>

<p>To detach the file descriptor, use <span class='object_link'><a href="EventMachine/Connection.html#detach-instance_method" title="EventMachine::Connection#detach (method)">EventMachine::Connection#detach</a></span></p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
      <pre class="example code"><code>
<span class='kw'>module</span> <span class='const'>SimpleHttpClient</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_notify_readable'>notify_readable</span>
    <span class='id identifier rubyid_header'>header</span> <span class='op'>=</span> <span class='ivar'>@io</span><span class='period'>.</span><span class='id identifier rubyid_readline'>readline</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_header'>header</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\r\n</span><span class='tstring_end'>&quot;</span></span>
      <span class='comment'># detach returns the file descriptor number (fd == @io.fileno)
</span>      <span class='id identifier rubyid_fd'>fd</span> <span class='op'>=</span> <span class='id identifier rubyid_detach'>detach</span>
    <span class='kw'>end</span>
  <span class='kw'>rescue</span> <span class='const'>EOFError</span>
    <span class='id identifier rubyid_detach'>detach</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_unbind'>unbind</span>
    <span class='const'>EM</span><span class='period'>.</span><span class='id identifier rubyid_next_tick'>next_tick</span> <span class='kw'>do</span>
      <span class='comment'># socket is detached from the eventloop, but still open
</span>      <span class='id identifier rubyid_data'>data</span> <span class='op'>=</span> <span class='ivar'>@io</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_run'>run</span> <span class='lbrace'>{</span>
  <span class='id identifier rubyid_sock'>sock</span> <span class='op'>=</span> <span class='const'>TCPSocket</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>site.com</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>80</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_sock'>sock</span><span class='period'>.</span><span class='id identifier rubyid_write'>write</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>GET / HTTP/1.0\r\n\r\n</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='id identifier rubyid_conn'>conn</span> <span class='op'>=</span> <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_watch'>watch</span><span class='lparen'>(</span><span class='id identifier rubyid_sock'>sock</span><span class='comma'>,</span> <span class='const'>SimpleHttpClient</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_conn'>conn</span><span class='period'>.</span><span class='id identifier rubyid_notify_readable'>notify_readable</span> <span class='op'>=</span> <span class='kw'>true</span>
<span class='rbrace'>}</span></code></pre>
    
  </div>

<p class="tag_title">Author:</p>
<ul class="author">
  
    <li>
      
      
      
      
        
        <div class='inline'><p>Riham Aldakkak (eSpace Technologies)</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


717
718
719</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 717</span>

<span class='kw'>def</span> <span class='const'>EventMachine</span><span class='op'>::</span><span class='id identifier rubyid_watch'>watch</span> <span class='id identifier rubyid_io'>io</span><span class='comma'>,</span> <span class='id identifier rubyid_handler'>handler</span><span class='op'>=</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_blk'>blk</span>
  <span class='id identifier rubyid_attach_io'>attach_io</span> <span class='id identifier rubyid_io'>io</span><span class='comma'>,</span> <span class='kw'>true</span><span class='comma'>,</span> <span class='id identifier rubyid_handler'>handler</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_blk'>blk</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="watch_file-class_method">
  
    + (<tt>Object</tt>) <strong>watch_file</strong>(filename, handler = nil, *args) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'><p>The ability to pick up on the new filename after a rename is not yet supported.
Calling #path will always return the filename you originally used.</p>
</div>
  </div>

<p>EventMachine’s file monitoring API. Currently supported are the following events
on individual files, using inotify on Linux systems, and kqueue for *BSD and Mac OS X:</p>

<ul>
  <li>File modified (written to)</li>
  <li>File moved/renamed</li>
  <li>File deleted</li>
</ul>

<p>EventMachine::watch_file takes a filename and a handler Module containing your custom callback methods.
This will setup the low level monitoring on the specified file, and create a new EventMachine::FileWatch
object with your Module mixed in. FileWatch is a subclass of <span class='object_link'><a href="EventMachine/Connection.html" title="EventMachine::Connection (class)">Connection</a></span>, so callbacks on this object
work in the familiar way. The callbacks that will be fired by EventMachine are:</p>

<ul>
  <li>file_modified</li>
  <li>file_moved</li>
  <li>file_deleted</li>
</ul>

<p>You can access the filename being monitored from within this object using <span class='object_link'><a href="EventMachine/FileWatch.html#path-instance_method" title="EventMachine::FileWatch#path (method)">EventMachine::FileWatch#path</a></span>.</p>

<p>When a file is deleted, <span class='object_link'><a href="EventMachine/FileWatch.html#stop_watching-instance_method" title="EventMachine::FileWatch#stop_watching (method)">EventMachine::FileWatch#stop_watching</a></span> will be called after your file_deleted callback,
to clean up the underlying monitoring and remove EventMachine’s reference to the now-useless <span class='object_link'><a href="EventMachine/FileWatch.html" title="EventMachine::FileWatch (class)">FileWatch</a></span> instance.
This will in turn call unbind, if you wish to use it.</p>

<p>The corresponding system-level Errno will be raised when attempting to monitor non-existent files,
files with wrong permissions, or if an error occurs dealing with inotify/kqueue.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
      <pre class="example code"><code>
<span class='comment'># Before running this example, make sure we have a file to monitor:
</span><span class='comment'># $ echo &quot;bar&quot; &gt; /tmp/foo
</span>
<span class='kw'>module</span> <span class='const'>Handler</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_file_modified'>file_modified</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_path'>path</span><span class='embexpr_end'>}</span><span class='tstring_content'> modified</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_file_moved'>file_moved</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_path'>path</span><span class='embexpr_end'>}</span><span class='tstring_content'> moved</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_file_deleted'>file_deleted</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_path'>path</span><span class='embexpr_end'>}</span><span class='tstring_content'> deleted</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_unbind'>unbind</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_path'>path</span><span class='embexpr_end'>}</span><span class='tstring_content'> monitoring ceased</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='comment'># for efficient file watching, use kqueue on Mac OS X
</span><span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_kqueue'>kqueue</span> <span class='op'>=</span> <span class='kw'>true</span> <span class='kw'>if</span> <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_kqueue?'>kqueue?</span>

<span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_run'>run</span> <span class='lbrace'>{</span>
  <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_watch_file'>watch_file</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/tmp/foo</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='const'>Handler</span><span class='rparen'>)</span>
<span class='rbrace'>}</span>

<span class='comment'># $ echo &quot;baz&quot; &gt;&gt; /tmp/foo    =&gt;    &quot;/tmp/foo modified&quot;
</span><span class='comment'># $ mv /tmp/foo /tmp/oof      =&gt;    &quot;/tmp/foo moved&quot;
</span><span class='comment'># $ rm /tmp/oof               =&gt;    &quot;/tmp/foo deleted&quot;</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>filename</span>
      
      
        <span class='type'>(<tt>String</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Local path to the file to watch.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>handler</span>
      
      
        <span class='type'>(<tt>Class</tt>, <tt>Module</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>A class or module that implements event handlers associated with the file.</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1265
1266
1267
1268
1269
1270
1271
1272
1273
1274
1275</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 1265</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_watch_file'>watch_file</span><span class='lparen'>(</span><span class='id identifier rubyid_filename'>filename</span><span class='comma'>,</span> <span class='id identifier rubyid_handler'>handler</span><span class='op'>=</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_klass'>klass</span> <span class='op'>=</span> <span class='id identifier rubyid_klass_from_handler'>klass_from_handler</span><span class='lparen'>(</span><span class='const'>FileWatch</span><span class='comma'>,</span> <span class='id identifier rubyid_handler'>handler</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_s'>s</span> <span class='op'>=</span> <span class='const'>EM</span><span class='op'>::</span><span class='id identifier rubyid_watch_filename'>watch_filename</span><span class='lparen'>(</span><span class='id identifier rubyid_filename'>filename</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_c'>c</span> <span class='op'>=</span> <span class='id identifier rubyid_klass'>klass</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_s'>s</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span>
  <span class='comment'># we have to set the path like this because of how Connection.new works
</span>  <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_instance_variable_set'>instance_variable_set</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>@path</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_filename'>filename</span><span class='rparen'>)</span>
  <span class='ivar'>@conns</span><span class='lbracket'>[</span><span class='id identifier rubyid_s'>s</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_c'>c</span>
  <span class='id identifier rubyid_block_given?'>block_given?</span> <span class='kw'>and</span> <span class='kw'>yield</span> <span class='id identifier rubyid_c'>c</span>
  <span class='id identifier rubyid_c'>c</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="watch_process-class_method">
  
    + (<tt>Object</tt>) <strong>watch_process</strong>(pid, handler = nil, *args) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>EventMachine’s process monitoring API. On Mac OS X and *BSD this method is implemented using kqueue.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
      <pre class="example code"><code>
<span class='kw'>module</span> <span class='const'>ProcessWatcher</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_process_exited'>process_exited</span>
    <span class='id identifier rubyid_put'>put</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>the forked child died!</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_pid'>pid</span> <span class='op'>=</span> <span class='id identifier rubyid_fork'>fork</span><span class='lbrace'>{</span> <span class='id identifier rubyid_sleep'>sleep</span> <span class='rbrace'>}</span>

<span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_run'>run</span> <span class='lbrace'>{</span>
  <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_watch_process'>watch_process</span><span class='lparen'>(</span><span class='id identifier rubyid_pid'>pid</span><span class='comma'>,</span> <span class='const'>ProcessWatcher</span><span class='rparen'>)</span>
  <span class='const'>EventMachine</span><span class='period'>.</span><span class='id identifier rubyid_add_timer'>add_timer</span><span class='lparen'>(</span><span class='int'>1</span><span class='rparen'>)</span><span class='lbrace'>{</span> <span class='const'>Process</span><span class='period'>.</span><span class='id identifier rubyid_kill'>kill</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>TERM</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_pid'>pid</span><span class='rparen'>)</span> <span class='rbrace'>}</span>
<span class='rbrace'>}</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>pid</span>
      
      
        <span class='type'>(<tt>Integer</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>PID of the process to watch.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>handler</span>
      
      
        <span class='type'>(<tt>Class</tt>, <tt>Module</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>A class or module that implements event handlers associated with the file.</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


1296
1297
1298
1299
1300
1301
1302
1303
1304
1305
1306
1307
1308</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/eventmachine.rb', line 1296</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_watch_process'>watch_process</span><span class='lparen'>(</span><span class='id identifier rubyid_pid'>pid</span><span class='comma'>,</span> <span class='id identifier rubyid_handler'>handler</span><span class='op'>=</span><span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_pid'>pid</span> <span class='op'>=</span> <span class='id identifier rubyid_pid'>pid</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span>

  <span class='id identifier rubyid_klass'>klass</span> <span class='op'>=</span> <span class='id identifier rubyid_klass_from_handler'>klass_from_handler</span><span class='lparen'>(</span><span class='const'>ProcessWatch</span><span class='comma'>,</span> <span class='id identifier rubyid_handler'>handler</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_s'>s</span> <span class='op'>=</span> <span class='const'>EM</span><span class='op'>::</span><span class='id identifier rubyid_watch_pid'>watch_pid</span><span class='lparen'>(</span><span class='id identifier rubyid_pid'>pid</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_c'>c</span> <span class='op'>=</span> <span class='id identifier rubyid_klass'>klass</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_s'>s</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_args'>args</span>
  <span class='comment'># we have to set the path like this because of how Connection.new works
</span>  <span class='id identifier rubyid_c'>c</span><span class='period'>.</span><span class='id identifier rubyid_instance_variable_set'>instance_variable_set</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>@pid</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='id identifier rubyid_pid'>pid</span><span class='rparen'>)</span>
  <span class='ivar'>@conns</span><span class='lbracket'>[</span><span class='id identifier rubyid_s'>s</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_c'>c</span>
  <span class='id identifier rubyid_block_given?'>block_given?</span> <span class='kw'>and</span> <span class='kw'>yield</span> <span class='id identifier rubyid_c'>c</span>
  <span class='id identifier rubyid_c'>c</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Fri Feb 21 19:34:59 2014 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.5.2 (ruby-2.0.0).
</div>

  </body>
</html>